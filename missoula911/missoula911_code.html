<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>72722227ce4e400e91cbeff7a73c9c2d</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<div class="cell code" data-execution_count="1">
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio <span class="im">as</span> rio</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> raster_tools <span class="im">as</span> rt</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="2">
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">&#39;display.max_columns&#39;</span>, <span class="dv">500</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">&#39;display.max_rows&#39;</span>, <span class="dv">500</span>)</span></code></pre></div>
</div>
<section id="load-pois-combine-assign-type" class="cell markdown">
<h5>Load POIs, combine, assign type</h5>
</section>
<div class="cell code" data-execution_count="32">
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># for each geojson in data/missoula/missoula_poi, load the geojson into a geodataframe with the name of the file as the name of the geodataframe</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># get filenames with glob</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>filenames <span class="op">=</span> glob.glob(<span class="st">&#39;data/missoula/missoula_poi/*.geojson&#39;</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># create a dictionary to hold the geodataframes</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>gdfs <span class="op">=</span> {}</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># loop through the filenames</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> filename <span class="kw">in</span> filenames:</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get the name of the file</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> filename.split(<span class="st">&#39;/&#39;</span>)[<span class="op">-</span><span class="dv">1</span>].split(<span class="st">&#39;.&#39;</span>)[<span class="dv">0</span>]</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># load the geojson into a geodataframe</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    gdfs[name] <span class="op">=</span> gpd.read_file(filename)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add a column to the geodataframe with the name of the file</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    gdfs[name][<span class="st">&#39;b_type&#39;</span>] <span class="op">=</span> name</span></code></pre></div>
</div>
<div class="cell code">
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># combine the poi geodataframes into a single geodataframe, with a new column &#39;type&#39; that is the name of the original geodataframe</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>poi <span class="op">=</span> gpd.GeoDataFrame(pd.concat(gdfs.values(), ignore_index<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>poi[<span class="st">&#39;b_type&#39;</span>] <span class="op">=</span> poi[<span class="st">&#39;b_type&#39;</span>].astype(<span class="bu">str</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># poi[&#39;b_type&#39;] = poi[&#39;b_type&#39;].str.split(&#39;_&#39;).str[1:2].str[0</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># split and keep everything after the first _</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>poi[<span class="st">&#39;b_type&#39;</span>] <span class="op">=</span> poi[<span class="st">&#39;b_type&#39;</span>].<span class="bu">str</span>.split(<span class="st">&#39;_&#39;</span>).<span class="bu">str</span>[<span class="dv">1</span>:].<span class="bu">str</span>.join(<span class="st">&#39;_&#39;</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>poi[<span class="st">&#39;lat&#39;</span>] <span class="op">=</span> poi.geometry.y</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>poi[<span class="st">&#39;lon&#39;</span>] <span class="op">=</span> poi.geometry.x</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>poi.b_type</span></code></pre></div>
</div>
<div class="cell code">
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># distribution of business types</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>poi.b_type.value_counts()</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="6">
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># write pois to geojosn</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>poi.to_file(<span class="st">&#39;data/missoula/missoula_poi_all.geojson&#39;</span>, driver<span class="op">=</span><span class="st">&#39;GeoJSON&#39;</span>)</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="6">
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>poi.to_crs(epsg<span class="op">=</span><span class="dv">5070</span>, inplace<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
</div>
<div class="cell code">
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load missoula_landuse_fixed.geojson</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>landuse <span class="op">=</span> gpd.read_file(<span class="st">&#39;data/missoula/missoula_landuse_fixed.geojson&#39;</span>)</span></code></pre></div>
</div>
<section id="filterable-map-of-missoula-pois" class="cell markdown">
<h5>Filterable map of Missoula POIs</h5>
</section>
<div class="cell code">
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> folium.plugins <span class="im">import</span> MarkerCluster</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the POI data</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co"># poi = pd.read_csv(&#39;path_to_your_poi_data.csv&#39;)  # Replace with actual path to your POI data</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a map centered on Missoula</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>m_pois <span class="op">=</span> folium.Map(location<span class="op">=</span>[<span class="fl">46.87</span>, <span class="op">-</span><span class="fl">113.99</span>], zoom_start<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a color map for business types</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>unique_types <span class="op">=</span> poi[<span class="st">&#39;b_type&#39;</span>].unique()</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>color_map <span class="op">=</span> {b_type: <span class="ss">f&#39;#</span><span class="sc">{</span><span class="bu">hash</span>(b_type) <span class="op">%</span> <span class="bn">0xFFFFFF</span><span class="sc">:06x}</span><span class="ss">&#39;</span> <span class="cf">for</span> b_type <span class="kw">in</span> unique_types}</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a feature group for all POIs</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>all_pois <span class="op">=</span> folium.FeatureGroup(name<span class="op">=</span><span class="st">&quot;All POIs&quot;</span>, show<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Add all POIs to the all_pois group</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> poi.iterrows():</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    folium.CircleMarker(</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        location<span class="op">=</span>[row[<span class="st">&#39;lat&#39;</span>], row[<span class="st">&#39;lon&#39;</span>]],</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        radius<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>        popup<span class="op">=</span><span class="ss">f&quot;</span><span class="sc">{</span>row[<span class="st">&#39;b_type&#39;</span>]<span class="sc">}</span><span class="ss">&quot;</span>,</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span>color_map[row[<span class="st">&#39;b_type&#39;</span>]],</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>        fill<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>        fillColor<span class="op">=</span>color_map[row[<span class="st">&#39;b_type&#39;</span>]]</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    ).add_to(all_pois)</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>all_pois.add_to(m_pois)</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a feature group for each business type</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> b_type <span class="kw">in</span> unique_types:</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    fg <span class="op">=</span> folium.FeatureGroup(name<span class="op">=</span>b_type, show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    type_df <span class="op">=</span> poi[poi[<span class="st">&#39;b_type&#39;</span>] <span class="op">==</span> b_type]</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> type_df.iterrows():</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>        folium.CircleMarker(</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>            location<span class="op">=</span>[row[<span class="st">&#39;lat&#39;</span>], row[<span class="st">&#39;lon&#39;</span>]],</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>            radius<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>            popup<span class="op">=</span><span class="ss">f&quot;</span><span class="sc">{</span>row[<span class="st">&#39;b_type&#39;</span>]<span class="sc">}</span><span class="ss">&quot;</span>,</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>color_map[b_type],</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>            fill<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>            fillColor<span class="op">=</span>color_map[b_type]</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>        ).add_to(fg)</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    fg.add_to(m_pois)</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Add layer control to the map</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>folium.LayerControl().add_to(m_pois)</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a legend</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>legend_html <span class="op">=</span> <span class="st">&#39;&#39;&#39;</span></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;div style=&quot;position: fixed; bottom: 50px; left: 50px; width: 220px; height: 180px; </span></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a><span class="st">    border:2px solid grey; z-index:9999; font-size:14px; background-color:white;</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a><span class="st">    overflow-y: auto;&quot;&gt;</span></span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;p&gt;&lt;strong&gt;Business Types:&lt;/strong&gt;&lt;/p&gt;</span></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a><span class="st">    &#39;&#39;&#39;</span></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> b_type, color <span class="kw">in</span> color_map.items():</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>    legend_html <span class="op">+=</span> <span class="ss">f&#39;&lt;p&gt;&lt;span style=&quot;color:</span><span class="sc">{</span>color<span class="sc">}</span><span class="ss">;&quot;&gt;●&lt;/span&gt; </span><span class="sc">{</span>b_type<span class="sc">}</span><span class="ss">&lt;/p&gt;&#39;</span></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>legend_html <span class="op">+=</span> <span class="st">&#39;&lt;/div&gt;&#39;</span></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>m_pois.get_root().html.add_child(folium.Element(legend_html))</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the map</span></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>m_pois.save(<span class="st">&quot;maps/missoula_poi_map.html&quot;</span>)</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;POI map has been saved as &#39;missoula_poi_map.html&#39;&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code">
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> folium.plugins <span class="im">import</span> MarkerCluster</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the POI data</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co"># poi = pd.read_csv(&#39;path_to_your_poi_data.csv&#39;)  # Replace with actual path to your POI data</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a map centered on Missoula</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>m_pois <span class="op">=</span> folium.Map(location<span class="op">=</span>[<span class="fl">46.87</span>, <span class="op">-</span><span class="fl">113.99</span>], zoom_start<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a color map for business types</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>unique_types <span class="op">=</span> poi[<span class="st">&#39;b_type&#39;</span>].unique()</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>color_map <span class="op">=</span> {b_type: <span class="ss">f&#39;#</span><span class="sc">{</span><span class="bu">hash</span>(b_type) <span class="op">%</span> <span class="bn">0xFFFFFF</span><span class="sc">:06x}</span><span class="ss">&#39;</span> <span class="cf">for</span> b_type <span class="kw">in</span> unique_types}</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a feature group for all POIs</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>all_pois <span class="op">=</span> folium.FeatureGroup(name<span class="op">=</span><span class="st">&quot;All POIs&quot;</span>, show<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Add all POIs to the all_pois group</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> poi.iterrows():</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    folium.CircleMarker(</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        location<span class="op">=</span>[row[<span class="st">&#39;lat&#39;</span>], row[<span class="st">&#39;lon&#39;</span>]],</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        radius<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        popup<span class="op">=</span><span class="ss">f&quot;</span><span class="sc">{</span>row[<span class="st">&#39;b_type&#39;</span>]<span class="sc">}</span><span class="ss">&quot;</span>,</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span>color_map[row[<span class="st">&#39;b_type&#39;</span>]],</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>        fill<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        fillColor<span class="op">=</span>color_map[row[<span class="st">&#39;b_type&#39;</span>]]</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    ).add_to(all_pois)</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>all_pois.add_to(m_pois)</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a feature group for each business type</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> b_type <span class="kw">in</span> unique_types:</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    fg <span class="op">=</span> folium.FeatureGroup(name<span class="op">=</span>b_type, show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    type_df <span class="op">=</span> poi[poi[<span class="st">&#39;b_type&#39;</span>] <span class="op">==</span> b_type]</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> type_df.iterrows():</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>        folium.CircleMarker(</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>            location<span class="op">=</span>[row[<span class="st">&#39;lat&#39;</span>], row[<span class="st">&#39;lon&#39;</span>]],</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>            radius<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>            popup<span class="op">=</span><span class="ss">f&quot;</span><span class="sc">{</span>row[<span class="st">&#39;b_type&#39;</span>]<span class="sc">}</span><span class="ss">&quot;</span>,</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>color_map[b_type],</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>            fill<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>            fillColor<span class="op">=</span>color_map[b_type]</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>        ).add_to(fg)</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    fg.add_to(m_pois)</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Add layer control to the map</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>folium.LayerControl().add_to(m_pois)</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a legend</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>legend_html <span class="op">=</span> <span class="st">&#39;&#39;&#39;</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;div style=&quot;position: fixed; bottom: 50px; left: 50px; width: 220px; height: 180px; </span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a><span class="st">    border:2px solid grey; z-index:9999; font-size:14px; background-color:white;</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a><span class="st">    overflow-y: auto;&quot;&gt;</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;p&gt;&lt;strong&gt;Business Types:&lt;/strong&gt;&lt;/p&gt;</span></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a><span class="st">    &#39;&#39;&#39;</span></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> b_type, color <span class="kw">in</span> color_map.items():</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>    legend_html <span class="op">+=</span> <span class="ss">f&#39;&lt;p&gt;&lt;span style=&quot;color:</span><span class="sc">{</span>color<span class="sc">}</span><span class="ss">;&quot;&gt;●&lt;/span&gt; </span><span class="sc">{</span>b_type<span class="sc">}</span><span class="ss">&lt;/p&gt;&#39;</span></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>legend_html <span class="op">+=</span> <span class="st">&#39;&lt;/div&gt;&#39;</span></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>m_pois.get_root().html.add_child(folium.Element(legend_html))</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Add custom CSS and JavaScript for the layer control label</span></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>custom_css <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;style&gt;</span></span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a><span class="st">.leaflet-control-layers-list {</span></span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a><span class="st">    margin-top: 30px !important;</span></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a><span class="st">.layer-control-label {</span></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a><span class="st">    position: absolute;</span></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a><span class="st">    top: 10px;</span></span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a><span class="st">    left: 10px;</span></span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a><span class="st">    font-weight: bold;</span></span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/style&gt;</span></span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>custom_js <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;script&gt;</span></span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a><span class="st">document.addEventListener(&#39;DOMContentLoaded&#39;, function() {</span></span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a><span class="st">    var layerControl = document.querySelector(&#39;.leaflet-control-layers&#39;);</span></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a><span class="st">    if (layerControl) {</span></span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a><span class="st">        var label = document.createElement(&#39;div&#39;);</span></span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a><span class="st">        label.className = &#39;layer-control-label&#39;;</span></span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a><span class="st">        label.textContent = &#39;Select POI Type&#39;;</span></span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a><span class="st">        layerControl.insertBefore(label, layerControl.firstChild);</span></span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a><span class="st">    }</span></span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a><span class="st">});</span></span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;/script&gt;</span></span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a>m_pois.get_root().header.add_child(folium.Element(custom_css <span class="op">+</span> custom_js))</span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the map</span></span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a>m_pois.save(<span class="st">&quot;website/maps/missoula_poi_map.html&quot;</span>)</span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;POI map has been saved as &#39;missoula_poi_map.html&#39;&quot;</span>)</span></code></pre></div>
</div>
<section id="911-calls-data" class="cell markdown">
<h5>911 Calls Data</h5>
</section>
<div class="cell code">
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load the 911 calls data into a geodataframe</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>calls_911_2023 <span class="op">=</span> gpd.read_file(<span class="st">&#39;data/missoula/missoula_911Calls_2023.csv&#39;</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>calls_911_2023.geometry <span class="op">=</span> gpd.points_from_xy(calls_911_2023.Lon, calls_911_2023.Lat)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>calls_911_2024 <span class="op">=</span> gpd.read_file(<span class="st">&#39;data/missoula/missoula_911_calls_2024.geojson&#39;</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>calls_911_2024.geometry <span class="op">=</span> gpd.points_from_xy(calls_911_2024.Lon, calls_911_2024.Lat)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># merge the 911 calls data</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>calls_911_2023_2024 <span class="op">=</span> pd.concat([calls_911_2023, calls_911_2024], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co"># calls_911_2023_2024.to_crs(epsg=5070, inplace=True)</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co"># List of Violent call types</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>violent_calls <span class="op">=</span> [</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Assault&#39;</span>, <span class="st">&#39;Assault with a Weapon&#39;</span>, <span class="st">&#39;Domestic Animal&#39;</span>, <span class="st">&#39;Homicide&#39;</span>, </span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Intimidation&#39;</span>, <span class="st">&#39;Kidnapping&#39;</span>, <span class="st">&#39;Partner Family Member Assault&#39;</span>, </span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Robbery&#39;</span>, <span class="st">&#39;Sexual Assault&#39;</span>, <span class="st">&#39;Shots Fired&#39;</span>, <span class="st">&#39;Shots Heard&#39;</span>, </span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Suicidal Person&#39;</span>, <span class="st">&#39;Suicide&#39;</span>, <span class="st">&#39;Weapons - Carry/Possess&#39;</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to classify call types</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> classify_call(call_type):</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&#39;Violent&#39;</span> <span class="cf">if</span> call_type <span class="kw">in</span> violent_calls <span class="cf">else</span> <span class="st">&#39;Nonviolent&#39;</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Add new column &#39;crime_type&#39; to the DataFrame</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>calls_911_2023_2024[<span class="st">&#39;crime_type&#39;</span>] <span class="op">=</span> calls_911_2023_2024[<span class="st">&#39;Call Type Description&#39;</span>].<span class="bu">apply</span>(classify_call)</span></code></pre></div>
</div>
<section id="missoula-roads-data" class="cell markdown">
<h5>Missoula Roads Data</h5>
</section>
<div class="cell code">
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load missoula_roads_segments.geojson</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>missoula_roads <span class="op">=</span> gpd.read_file(<span class="st">&#39;data/missoula/missoula_roads_clipped.geojson&#39;</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># drop roads with roadname DRIVEWAY, ALLEY</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># missoula_roads = missoula_roads[~missoula_roads.roadname.isin([&#39;DRIVEWAY&#39;, &#39;ALLEY&#39;, &#39;SERVICE&#39;])]</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>missoula_roads <span class="op">=</span> missoula_roads[<span class="op">~</span>missoula_roads.roadname.isin([<span class="st">&#39;SERVICE&#39;</span>])]</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>missoula_roads.roadname.value_counts()</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>missoula_roads.isnull().<span class="bu">sum</span>()</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co"># drop all columns with any missing values</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>missoula_roads.dropna(axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>missoula_roads.reset_index(drop<span class="op">=</span><span class="va">True</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>missoula_roads[<span class="st">&#39;uniquename&#39;</span>] <span class="op">=</span> missoula_roads[<span class="st">&#39;roadname&#39;</span>] <span class="op">+</span> <span class="st">&#39;_&#39;</span> <span class="op">+</span> missoula_roads[<span class="st">&#39;fromleft&#39;</span>].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">&#39;_&#39;</span> <span class="op">+</span> missoula_roads[<span class="st">&#39;toleft&#39;</span>].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">&#39;_&#39;</span> <span class="op">+</span> missoula_roads.index.astype(<span class="bu">str</span>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co"># create n meter buffer around roads</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>missoula_roads_buffer <span class="op">=</span> missoula_roads.copy()</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>missoula_roads_buffer.to_crs(epsg<span class="op">=</span><span class="dv">5070</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>missoula_roads_buffer[<span class="st">&#39;geometry&#39;</span>] <span class="op">=</span> missoula_roads_buffer.<span class="bu">buffer</span>(<span class="dv">30</span>)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>missoula_roads_buffer.reset_index(drop<span class="op">=</span><span class="va">True</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>missoula_roads_buffer.plot()</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="18">
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>calls_911_2023_2024_buffer <span class="op">=</span> calls_911_2023_2024.copy()</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>calls_911_2023_2024_buffer.to_crs(epsg<span class="op">=</span><span class="dv">5070</span>, inplace<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
</div>
<div class="cell code">
<div class="sourceCode" id="cb14"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>calls_911_2023_2024_buffer_violent <span class="op">=</span> calls_911_2023_2024_buffer[calls_911_2023_2024_buffer[<span class="st">&#39;crime_type&#39;</span>] <span class="op">==</span> <span class="st">&#39;Violent&#39;</span>]</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>roads_calls_violent <span class="op">=</span> missoula_roads_buffer.merge(missoula_roads_buffer.sjoin(calls_911_2023_2024_buffer_violent).groupby(<span class="st">&#39;uniquename&#39;</span>).size().rename(<span class="st">&#39;n_points&#39;</span>).reset_index())</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>roads_calls_fixed_violent <span class="op">=</span> roads_calls_violent[[<span class="st">&#39;uniquename&#39;</span>, <span class="st">&#39;geometry&#39;</span>, <span class="st">&#39;n_points&#39;</span>, <span class="st">&#39;shape_Leng&#39;</span>]]</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># remove buffer for plotting</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>roads_calls_fixed_violent[<span class="st">&#39;geometry&#39;</span>] <span class="op">=</span> roads_calls_fixed_violent.<span class="bu">buffer</span>(<span class="op">-</span><span class="dv">20</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># remove roads starting with &#39;90&#39; in uniquename</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>roads_calls_fixed_violent <span class="op">=</span> roads_calls_fixed_violent[<span class="op">~</span>roads_calls_fixed_violent.uniquename.<span class="bu">str</span>.startswith(<span class="st">&#39;90&#39;</span>)]</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>roads_calls <span class="op">=</span> missoula_roads_buffer.merge(missoula_roads_buffer.sjoin(calls_911_2023_2024_buffer).groupby(<span class="st">&#39;uniquename&#39;</span>).size().rename(<span class="st">&#39;n_points&#39;</span>).reset_index())</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>roads_calls_fixed <span class="op">=</span> roads_calls[[<span class="st">&#39;uniquename&#39;</span>, <span class="st">&#39;geometry&#39;</span>, <span class="st">&#39;n_points&#39;</span>, <span class="st">&#39;shape_Leng&#39;</span>]]</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co"># remove buffer for plotting</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>roads_calls_fixed[<span class="st">&#39;geometry&#39;</span>] <span class="op">=</span> roads_calls_fixed.<span class="bu">buffer</span>(<span class="op">-</span><span class="dv">20</span>)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co"># remove roads starting with &#39;90&#39; in uniquename</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>roads_calls_fixed <span class="op">=</span> roads_calls_fixed[<span class="op">~</span>roads_calls_fixed.uniquename.<span class="bu">str</span>.startswith(<span class="st">&#39;90&#39;</span>)]</span></code></pre></div>
</div>
<div class="cell code">
<div class="sourceCode" id="cb15"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># show the roads from roads_calls_fixed with the most 911 calls</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>roads_calls_fixed.sort_values(<span class="st">&#39;n_points&#39;</span>, ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">10</span>)</span></code></pre></div>
</div>
<section id="missoula-911-roads-maps" class="cell markdown">
<h5>Missoula 911 Roads maps</h5>
</section>
<section id="all-road-calls-percentile-map" class="cell markdown">
<h6>All Road calls percentile map</h6>
</section>
<div class="cell code">
<div class="sourceCode" id="cb16"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> folium.features <span class="im">import</span> GeoJsonPopup, GeoJsonTooltip</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> branca.colormap <span class="im">import</span> LinearColormap</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure the GeoDataFrame is in WGS84 (EPSG:4326) for Folium</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>road_segments <span class="op">=</span> roads_calls_fixed.to_crs(epsg<span class="op">=</span><span class="dv">4326</span>)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a map centered on Missoula with Esri.WorldStreetMap as default</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> folium.Map(location<span class="op">=</span>[<span class="fl">46.87</span>, <span class="op">-</span><span class="fl">113.99</span>], zoom_start<span class="op">=</span><span class="dv">13</span>, min_zoom<span class="op">=</span><span class="dv">13</span>, max_bounds<span class="op">=</span><span class="va">True</span>, tiles<span class="op">=</span><span class="st">&#39;Esri.WorldStreetMap&#39;</span>, attr<span class="op">=</span><span class="st">&#39;Esri&#39;</span>)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the bounding box for the initial view </span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>min_lat, max_lat, min_lon, max_lon <span class="op">=</span> <span class="fl">46.77854245661467</span>, <span class="fl">46.97166694574133</span>, <span class="op">-</span><span class="fl">114.17662423519394</span>, <span class="op">-</span><span class="fl">113.85756122668695</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the max bounds to restrict panning</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>m.fit_bounds([[min_lat, min_lon], [max_lat, max_lon]])</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a color map with percentile-based scaling</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>min_points <span class="op">=</span> road_segments[<span class="st">&#39;n_points&#39;</span>].<span class="bu">min</span>()</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>max_points <span class="op">=</span> road_segments[<span class="st">&#39;n_points&#39;</span>].<span class="bu">max</span>()</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>p10 <span class="op">=</span> np.percentile(road_segments[<span class="st">&#39;n_points&#39;</span>], <span class="dv">10</span>)</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>p99 <span class="op">=</span> np.percentile(road_segments[<span class="st">&#39;n_points&#39;</span>], <span class="fl">99.5</span>)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>colormap <span class="op">=</span> LinearColormap(</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    colors <span class="op">=</span> [</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#00FF00&#39;</span>,  <span class="co"># Green</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#90EE90&#39;</span>,  <span class="co"># Light Green</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#FFA500&#39;</span>,  <span class="co"># Orange</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#FF8C00&#39;</span>,  <span class="co"># Dark Orange</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#FF4500&#39;</span>,  <span class="co"># Red-Orange</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#FF0000&#39;</span>,  <span class="co"># Red</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#DC143C&#39;</span>,  <span class="co"># Crimson</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#B22222&#39;</span>,  <span class="co"># Fire Brick</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#8B0000&#39;</span>,  <span class="co"># Dark Red</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#000000&#39;</span>   <span class="co"># Black</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>],</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>    vmin<span class="op">=</span>p10,</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>    vmax<span class="op">=</span>p99</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to get color based on number of points</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_color(n_points):</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n_points <span class="op">&lt;=</span> p10:</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> colormap(p10)</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> n_points <span class="op">&gt;=</span> p99:</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> colormap(p99)</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> colormap(n_points)</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Add road segments to the map</span></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>folium.GeoJson(</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>    road_segments,</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>    style_function<span class="op">=</span><span class="kw">lambda</span> feature: {</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;fillColor&#39;</span>: get_color(feature[<span class="st">&#39;properties&#39;</span>][<span class="st">&#39;n_points&#39;</span>]),</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;color&#39;</span>: <span class="st">&#39;black&#39;</span>,</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;weight&#39;</span>: <span class="dv">0</span>,</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;fillOpacity&#39;</span>: <span class="fl">0.7</span>,</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>    tooltip<span class="op">=</span>GeoJsonTooltip(fields<span class="op">=</span>[<span class="st">&#39;uniquename&#39;</span>, <span class="st">&#39;n_points&#39;</span>],</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>                           aliases<span class="op">=</span>[<span class="st">&#39;Road Name&#39;</span>, <span class="st">&#39;Number of Points&#39;</span>],</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>                           localize<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>    popup<span class="op">=</span>GeoJsonPopup(fields<span class="op">=</span>[<span class="st">&#39;uniquename&#39;</span>, <span class="st">&#39;n_points&#39;</span>],</span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>                       aliases<span class="op">=</span>[<span class="st">&#39;Road Name&#39;</span>, <span class="st">&#39;Number of Points&#39;</span>],</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>                       localize<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>).add_to(m)</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a color legend</span></span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>colormap.add_to(m)</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>colormap.caption <span class="op">=</span> <span class="ss">f&#39;Number of Calls near roads (10th-99.5th percentile: </span><span class="sc">{</span>p10<span class="sc">:.0f}</span><span class="ss">-</span><span class="sc">{</span>p99<span class="sc">:.0f}</span><span class="ss">)&#39;</span></span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Add tile layers</span></span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>folium.TileLayer(</span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>    tiles<span class="op">=</span><span class="st">&#39;Esri.WorldImagery&#39;</span>,</span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a>    attr<span class="op">=</span><span class="st">&#39;Esri&#39;</span>,</span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">&#39;Esri.WorldImagery&#39;</span>,</span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>    overlay<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>    control<span class="op">=</span><span class="va">True</span></span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a>).add_to(m)</span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a>folium.TileLayer(</span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a>    tiles<span class="op">=</span><span class="st">&#39;Esri.WorldGrayCanvas&#39;</span>,</span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a>    attr<span class="op">=</span><span class="st">&#39;Esri&#39;</span>,</span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">&#39;Esri.WorldGrayCanvas&#39;</span>,</span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a>    overlay<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb16-87"><a href="#cb16-87" aria-hidden="true" tabindex="-1"></a>    control<span class="op">=</span><span class="va">True</span></span>
<span id="cb16-88"><a href="#cb16-88" aria-hidden="true" tabindex="-1"></a>).add_to(m)</span>
<span id="cb16-89"><a href="#cb16-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-90"><a href="#cb16-90" aria-hidden="true" tabindex="-1"></a><span class="co"># Add layer control</span></span>
<span id="cb16-91"><a href="#cb16-91" aria-hidden="true" tabindex="-1"></a>folium.LayerControl().add_to(m)</span>
<span id="cb16-92"><a href="#cb16-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-93"><a href="#cb16-93" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the map</span></span>
<span id="cb16-94"><a href="#cb16-94" aria-hidden="true" tabindex="-1"></a>m.save(<span class="st">&quot;website/maps/missoula_road_segments_map.html&quot;</span>)</span>
<span id="cb16-95"><a href="#cb16-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-96"><a href="#cb16-96" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Map of road segments has been saved as &#39;missoula_road_segments_map.html&#39;&quot;</span>)</span></code></pre></div>
</div>
<section
id="all-roads-calls-mean---std-dev-of-911-calls-per-road-segment"
class="cell markdown">
<h6>All roads calls mean +/- std dev of 911 calls per road segment</h6>
</section>
<div class="cell code">
<div class="sourceCode" id="cb17"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> folium.features <span class="im">import</span> GeoJsonPopup, GeoJsonTooltip</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> branca.colormap <span class="im">import</span> LinearColormap</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure the GeoDataFrame is in WGS84 (EPSG:4326) for Folium</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>road_segments <span class="op">=</span> roads_calls_fixed.to_crs(epsg<span class="op">=</span><span class="dv">4326</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a map centered on Missoula with Esri.WorldStreetMap as default</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> folium.Map(location<span class="op">=</span>[<span class="fl">46.87</span>, <span class="op">-</span><span class="fl">113.99</span>], zoom_start<span class="op">=</span><span class="dv">12</span>, min_zoom<span class="op">=</span><span class="dv">12</span>, max_bounds<span class="op">=</span><span class="va">True</span>, tiles<span class="op">=</span><span class="st">&#39;Esri.WorldStreetMap&#39;</span>, attr<span class="op">=</span><span class="st">&#39;Esri&#39;</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the bounding box for the initial view </span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>min_lat, max_lat, min_lon, max_lon <span class="op">=</span> <span class="fl">46.77854245661467</span>, <span class="fl">46.97166694574133</span>, <span class="op">-</span><span class="fl">114.17662423519394</span>, <span class="op">-</span><span class="fl">113.85756122668695</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the max bounds to restrict panning</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>m.fit_bounds([[min_lat, min_lon], [max_lat, max_lon]])</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate mean and standard deviation</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>mean_points <span class="op">=</span> road_segments[<span class="st">&#39;n_points&#39;</span>].mean()</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>std_points <span class="op">=</span> road_segments[<span class="st">&#39;n_points&#39;</span>].std()</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Define color scale range (mean +/- 2 standard deviations)</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>vmin <span class="op">=</span> (mean_points <span class="op">-</span> <span class="dv">1</span> <span class="op">*</span> std_points) <span class="cf">if</span> (mean_points <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> std_points) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>vmax <span class="op">=</span> mean_points <span class="op">+</span> <span class="fl">2.0</span> <span class="op">*</span> std_points</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a diverging color map</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>colormap <span class="op">=</span> LinearColormap(</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    colors <span class="op">=</span> [</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#440154&#39;</span>, <span class="st">&#39;#482878&#39;</span>, <span class="st">&#39;#3E4989&#39;</span>, <span class="st">&#39;#31688E&#39;</span>, <span class="st">&#39;#26828E&#39;</span>,</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#1F9E89&#39;</span>, <span class="st">&#39;#35B779&#39;</span>, <span class="st">&#39;#6DCD59&#39;</span>, <span class="st">&#39;#B4DE2C&#39;</span>, <span class="st">&#39;#FDE725&#39;</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    vmin<span class="op">=</span>vmin,</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    vmax<span class="op">=</span>vmax,</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    caption<span class="op">=</span><span class="ss">f&#39;Number of Points (Mean: </span><span class="sc">{</span>mean_points<span class="sc">:.0f}</span><span class="ss">, Std: </span><span class="sc">{</span>std_points<span class="sc">:.0f}</span><span class="ss">)&#39;</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to get color based on number of points</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_color(n_points):</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n_points <span class="op">&lt;</span> vmin:</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> colormap(vmin)</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> n_points <span class="op">&gt;</span> vmax:</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> colormap(vmax)</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> colormap(n_points)</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Add road segments to the map</span></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>folium.GeoJson(</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>    road_segments,</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>    style_function<span class="op">=</span><span class="kw">lambda</span> feature: {</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;fillColor&#39;</span>: get_color(feature[<span class="st">&#39;properties&#39;</span>][<span class="st">&#39;n_points&#39;</span>]),</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;color&#39;</span>: <span class="st">&#39;black&#39;</span>,</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;weight&#39;</span>: <span class="dv">0</span>,</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;fillOpacity&#39;</span>: <span class="fl">0.7</span>,</span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>    tooltip<span class="op">=</span>GeoJsonTooltip(fields<span class="op">=</span>[<span class="st">&#39;uniquename&#39;</span>, <span class="st">&#39;n_points&#39;</span>],</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>                           aliases<span class="op">=</span>[<span class="st">&#39;Road Name&#39;</span>, <span class="st">&#39;Number of Points&#39;</span>],</span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>                           localize<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>    popup<span class="op">=</span>GeoJsonPopup(fields<span class="op">=</span>[<span class="st">&#39;uniquename&#39;</span>, <span class="st">&#39;n_points&#39;</span>],</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>                       aliases<span class="op">=</span>[<span class="st">&#39;Road Name&#39;</span>, <span class="st">&#39;Number of Points&#39;</span>],</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>                       localize<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>).add_to(m)</span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the color scale to the map</span></span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>colormap.add_to(m)</span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Add tile layers</span></span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>folium.TileLayer(</span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>    tiles<span class="op">=</span><span class="st">&#39;Esri.WorldImagery&#39;</span>,</span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>    attr<span class="op">=</span><span class="st">&#39;Esri&#39;</span>,</span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">&#39;Esri.WorldImagery&#39;</span>,</span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a>    overlay<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>    control<span class="op">=</span><span class="va">True</span></span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>).add_to(m)</span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>folium.TileLayer(</span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a>    tiles<span class="op">=</span><span class="st">&#39;Esri.WorldGrayCanvas&#39;</span>,</span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>    attr<span class="op">=</span><span class="st">&#39;Esri&#39;</span>,</span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">&#39;Esri.WorldGrayCanvas&#39;</span>,</span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>    overlay<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a>    control<span class="op">=</span><span class="va">True</span></span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>).add_to(m)</span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Add layer control</span></span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a>folium.LayerControl().add_to(m)</span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the map</span></span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a>m.save(<span class="st">&quot;maps/missoula_road_segments_map_std_scaled.html&quot;</span>)</span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Map of road segments has been saved as &#39;missoula_road_segments_map_std_scaled.html&#39;&quot;</span>)</span></code></pre></div>
</div>
<section id="violent-roads-calls-percentile-map" class="cell markdown">
<h6>Violent roads calls percentile map</h6>
</section>
<div class="cell code">
<div class="sourceCode" id="cb18"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> folium.features <span class="im">import</span> GeoJsonPopup, GeoJsonTooltip</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> branca.colormap <span class="im">import</span> LinearColormap</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure the GeoDataFrame is in WGS84 (EPSG:4326) for Folium</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>road_segments <span class="op">=</span> roads_calls_fixed_violent.to_crs(epsg<span class="op">=</span><span class="dv">4326</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a map centered on Missoula with Esri.WorldStreetMap as default</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> folium.Map(location<span class="op">=</span>[<span class="fl">46.87</span>, <span class="op">-</span><span class="fl">113.99</span>], zoom_start<span class="op">=</span><span class="dv">13</span>, min_zoom<span class="op">=</span><span class="dv">13</span>, max_bounds<span class="op">=</span><span class="va">True</span>, tiles<span class="op">=</span><span class="st">&#39;Esri.WorldStreetMap&#39;</span>, attr<span class="op">=</span><span class="st">&#39;Esri&#39;</span>)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the bounding box for the initial view </span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>min_lat, max_lat, min_lon, max_lon <span class="op">=</span> <span class="fl">46.77854245661467</span>, <span class="fl">46.97166694574133</span>, <span class="op">-</span><span class="fl">114.17662423519394</span>, <span class="op">-</span><span class="fl">113.85756122668695</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the max bounds to restrict panning</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>m.fit_bounds([[min_lat, min_lon], [max_lat, max_lon]])</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a color map with percentile-based scaling</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>min_points <span class="op">=</span> road_segments[<span class="st">&#39;n_points&#39;</span>].<span class="bu">min</span>()</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>max_points <span class="op">=</span> road_segments[<span class="st">&#39;n_points&#39;</span>].<span class="bu">max</span>()</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>p10 <span class="op">=</span> np.percentile(road_segments[<span class="st">&#39;n_points&#39;</span>], <span class="dv">10</span>)</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>p99 <span class="op">=</span> np.percentile(road_segments[<span class="st">&#39;n_points&#39;</span>], <span class="fl">99.5</span>)</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>colormap <span class="op">=</span> LinearColormap(</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    colors <span class="op">=</span> [</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#00FF00&#39;</span>,  <span class="co"># Green</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#90EE90&#39;</span>,  <span class="co"># Light Green</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#FFA500&#39;</span>,  <span class="co"># Orange</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#FF8C00&#39;</span>,  <span class="co"># Dark Orange</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#FF4500&#39;</span>,  <span class="co"># Red-Orange</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#FF0000&#39;</span>,  <span class="co"># Red</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#DC143C&#39;</span>,  <span class="co"># Crimson</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#B22222&#39;</span>,  <span class="co"># Fire Brick</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#8B0000&#39;</span>,  <span class="co"># Dark Red</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#000000&#39;</span>   <span class="co"># Black</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>],</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>    vmin<span class="op">=</span>p10,</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>    vmax<span class="op">=</span>p99</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to get color based on number of points</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_color(n_points):</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n_points <span class="op">&lt;=</span> p10:</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> colormap(p10)</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> n_points <span class="op">&gt;=</span> p99:</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> colormap(p99)</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> colormap(n_points)</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Add road segments to the map</span></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>folium.GeoJson(</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>    road_segments,</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>    style_function<span class="op">=</span><span class="kw">lambda</span> feature: {</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;fillColor&#39;</span>: get_color(feature[<span class="st">&#39;properties&#39;</span>][<span class="st">&#39;n_points&#39;</span>]),</span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;color&#39;</span>: <span class="st">&#39;black&#39;</span>,</span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;weight&#39;</span>: <span class="dv">0</span>,</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;fillOpacity&#39;</span>: <span class="fl">0.7</span>,</span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>    tooltip<span class="op">=</span>GeoJsonTooltip(fields<span class="op">=</span>[<span class="st">&#39;uniquename&#39;</span>, <span class="st">&#39;n_points&#39;</span>],</span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>                           aliases<span class="op">=</span>[<span class="st">&#39;Road Name&#39;</span>, <span class="st">&#39;Number of Points&#39;</span>],</span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>                           localize<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>    popup<span class="op">=</span>GeoJsonPopup(fields<span class="op">=</span>[<span class="st">&#39;uniquename&#39;</span>, <span class="st">&#39;n_points&#39;</span>],</span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>                       aliases<span class="op">=</span>[<span class="st">&#39;Road Name&#39;</span>, <span class="st">&#39;Number of Points&#39;</span>],</span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a>                       localize<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>).add_to(m)</span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a color legend</span></span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>colormap.add_to(m)</span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a>colormap.caption <span class="op">=</span> <span class="ss">f&#39;Number of violent calls near roads (10th-99.5th percentile: </span><span class="sc">{</span>p10<span class="sc">:.0f}</span><span class="ss">-</span><span class="sc">{</span>p99<span class="sc">:.0f}</span><span class="ss">)&#39;</span></span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Add tile layers</span></span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a>folium.TileLayer(</span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a>    tiles<span class="op">=</span><span class="st">&#39;Esri.WorldImagery&#39;</span>,</span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a>    attr<span class="op">=</span><span class="st">&#39;Esri&#39;</span>,</span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">&#39;Esri.WorldImagery&#39;</span>,</span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a>    overlay<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a>    control<span class="op">=</span><span class="va">True</span></span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a>).add_to(m)</span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a>folium.TileLayer(</span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a>    tiles<span class="op">=</span><span class="st">&#39;Esri.WorldGrayCanvas&#39;</span>,</span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a>    attr<span class="op">=</span><span class="st">&#39;Esri&#39;</span>,</span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">&#39;Esri.WorldGrayCanvas&#39;</span>,</span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a>    overlay<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb18-87"><a href="#cb18-87" aria-hidden="true" tabindex="-1"></a>    control<span class="op">=</span><span class="va">True</span></span>
<span id="cb18-88"><a href="#cb18-88" aria-hidden="true" tabindex="-1"></a>).add_to(m)</span>
<span id="cb18-89"><a href="#cb18-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-90"><a href="#cb18-90" aria-hidden="true" tabindex="-1"></a><span class="co"># Add layer control</span></span>
<span id="cb18-91"><a href="#cb18-91" aria-hidden="true" tabindex="-1"></a>folium.LayerControl().add_to(m)</span>
<span id="cb18-92"><a href="#cb18-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-93"><a href="#cb18-93" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the map</span></span>
<span id="cb18-94"><a href="#cb18-94" aria-hidden="true" tabindex="-1"></a>m.save(<span class="st">&quot;website/maps/missoula_road_segments_violent_map.html&quot;</span>)</span>
<span id="cb18-95"><a href="#cb18-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-96"><a href="#cb18-96" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Map of road segments has been saved as &#39;missoula_road_segments_violent_map.html&#39;&quot;</span>)</span></code></pre></div>
</div>
<section id="combined-all--violent-roads-calls-percentile-map"
class="cell markdown">
<h6>Combined all + violent roads calls percentile map</h6>
</section>
<section id="roads-911-maps-with-advanced-buffer-not-working"
class="cell markdown">
<h5>Roads 911 maps with advanced buffer (not working)</h5>
</section>
<div class="cell code">
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> folium.features <span class="im">import</span> GeoJsonPopup, GeoJsonTooltip</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> branca.colormap <span class="im">import</span> LinearColormap</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.ops <span class="im">import</span> unary_union</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure the data is in EPSG:5070 projection</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>missoula_roads <span class="op">=</span> missoula_roads.to_crs(epsg<span class="op">=</span><span class="dv">5070</span>)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a smart buffer that fills all space between polygons</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_smart_buffer(gdf):</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    buffer_distance <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    buffered <span class="op">=</span> gdf.<span class="bu">buffer</span>(buffer_distance)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="kw">not</span> unary_union(buffered).is_valid:</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>        buffer_distance <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>        buffered <span class="op">=</span> gdf.<span class="bu">buffer</span>(buffer_distance)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> gpd.GeoDataFrame(geometry<span class="op">=</span>buffered, crs<span class="op">=</span>gdf.crs)</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the smart buffer</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>missoula_roads_buffer <span class="op">=</span> create_smart_buffer(missoula_roads)</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>missoula_roads_buffer[<span class="st">&#39;uniquename&#39;</span>] <span class="op">=</span> missoula_roads[<span class="st">&#39;uniquename&#39;</span>]</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Process 911 calls data</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>calls_911_2023_2024_buffer <span class="op">=</span> calls_911_2023_2024.copy()</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>calls_911_2023_2024_buffer.to_crs(epsg<span class="op">=</span><span class="dv">5070</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform spatial join and count points</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>roads_calls <span class="op">=</span> missoula_roads_buffer.sjoin(calls_911_2023_2024_buffer).groupby(<span class="st">&#39;uniquename&#39;</span>).size().rename(<span class="st">&#39;n_points&#39;</span>).reset_index()</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>roads_calls <span class="op">=</span> missoula_roads_buffer.merge(roads_calls, on<span class="op">=</span><span class="st">&#39;uniquename&#39;</span>, how<span class="op">=</span><span class="st">&#39;left&#39;</span>)</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill NaN values with 0 for roads with no calls</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>roads_calls[<span class="st">&#39;n_points&#39;</span>] <span class="op">=</span> roads_calls[<span class="st">&#39;n_points&#39;</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only necessary columns</span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>roads_calls_fixed <span class="op">=</span> roads_calls[[<span class="st">&#39;uniquename&#39;</span>, <span class="st">&#39;geometry&#39;</span>, <span class="st">&#39;n_points&#39;</span>]]</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove roads starting with &#39;90&#39; in uniquename</span></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>roads_calls_fixed <span class="op">=</span> roads_calls_fixed[<span class="op">~</span>roads_calls_fixed.uniquename.<span class="bu">str</span>.startswith(<span class="st">&#39;90&#39;</span>)]</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a 20m buffer for visualization</span></span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>roads_calls_fixed[<span class="st">&#39;geometry&#39;</span>] <span class="op">=</span> roads_calls_fixed.<span class="bu">buffer</span>(<span class="dv">20</span>)</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure the GeoDataFrame is in WGS84 (EPSG:4326) for Folium</span></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>road_segments <span class="op">=</span> roads_calls_fixed.to_crs(epsg<span class="op">=</span><span class="dv">4326</span>)</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a map centered on Missoula</span></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> folium.Map(location<span class="op">=</span>[<span class="fl">46.87</span>, <span class="op">-</span><span class="fl">113.99</span>], zoom_start<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a color map with percentile-based scaling</span></span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>min_points <span class="op">=</span> road_segments[<span class="st">&#39;n_points&#39;</span>].<span class="bu">min</span>()</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>max_points <span class="op">=</span> road_segments[<span class="st">&#39;n_points&#39;</span>].<span class="bu">max</span>()</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>p10 <span class="op">=</span> np.percentile(road_segments[<span class="st">&#39;n_points&#39;</span>], <span class="dv">10</span>)</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>p99 <span class="op">=</span> np.percentile(road_segments[<span class="st">&#39;n_points&#39;</span>], <span class="dv">99</span>)</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>colormap <span class="op">=</span> LinearColormap(</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>    colors <span class="op">=</span> [</span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#00FF00&#39;</span>,  <span class="co"># Green</span></span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#90EE90&#39;</span>,  <span class="co"># Light Green</span></span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#FFA500&#39;</span>,  <span class="co"># Orange</span></span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#FF8C00&#39;</span>,  <span class="co"># Dark Orange</span></span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#FF4500&#39;</span>,  <span class="co"># Red-Orange</span></span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#FF0000&#39;</span>,  <span class="co"># Red</span></span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#DC143C&#39;</span>,  <span class="co"># Crimson</span></span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#B22222&#39;</span>,  <span class="co"># Fire Brick</span></span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#8B0000&#39;</span>,  <span class="co"># Dark Red</span></span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#000000&#39;</span>   <span class="co"># Black</span></span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>    vmin<span class="op">=</span>p10,</span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>    vmax<span class="op">=</span>p99</span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to get color based on number of points</span></span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_color(n_points):</span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n_points <span class="op">&lt;=</span> p10:</span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> colormap(p10)</span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> n_points <span class="op">&gt;=</span> p99:</span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> colormap(p99)</span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> colormap(n_points)</span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Add road segments to the map</span></span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a>folium.GeoJson(</span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a>    road_segments,</span>
<span id="cb19-88"><a href="#cb19-88" aria-hidden="true" tabindex="-1"></a>    style_function<span class="op">=</span><span class="kw">lambda</span> feature: {</span>
<span id="cb19-89"><a href="#cb19-89" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;fillColor&#39;</span>: get_color(feature[<span class="st">&#39;properties&#39;</span>][<span class="st">&#39;n_points&#39;</span>]),</span>
<span id="cb19-90"><a href="#cb19-90" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;color&#39;</span>: <span class="st">&#39;black&#39;</span>,</span>
<span id="cb19-91"><a href="#cb19-91" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;weight&#39;</span>: <span class="dv">1</span>,</span>
<span id="cb19-92"><a href="#cb19-92" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;fillOpacity&#39;</span>: <span class="fl">0.7</span>,</span>
<span id="cb19-93"><a href="#cb19-93" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb19-94"><a href="#cb19-94" aria-hidden="true" tabindex="-1"></a>    tooltip<span class="op">=</span>GeoJsonTooltip(fields<span class="op">=</span>[<span class="st">&#39;uniquename&#39;</span>, <span class="st">&#39;n_points&#39;</span>],</span>
<span id="cb19-95"><a href="#cb19-95" aria-hidden="true" tabindex="-1"></a>                           aliases<span class="op">=</span>[<span class="st">&#39;Road Name&#39;</span>, <span class="st">&#39;Number of Points&#39;</span>],</span>
<span id="cb19-96"><a href="#cb19-96" aria-hidden="true" tabindex="-1"></a>                           localize<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb19-97"><a href="#cb19-97" aria-hidden="true" tabindex="-1"></a>    popup<span class="op">=</span>GeoJsonPopup(fields<span class="op">=</span>[<span class="st">&#39;uniquename&#39;</span>, <span class="st">&#39;n_points&#39;</span>],</span>
<span id="cb19-98"><a href="#cb19-98" aria-hidden="true" tabindex="-1"></a>                       aliases<span class="op">=</span>[<span class="st">&#39;Road Name&#39;</span>, <span class="st">&#39;Number of Points&#39;</span>],</span>
<span id="cb19-99"><a href="#cb19-99" aria-hidden="true" tabindex="-1"></a>                       localize<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-100"><a href="#cb19-100" aria-hidden="true" tabindex="-1"></a>).add_to(m)</span>
<span id="cb19-101"><a href="#cb19-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-102"><a href="#cb19-102" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a color legend</span></span>
<span id="cb19-103"><a href="#cb19-103" aria-hidden="true" tabindex="-1"></a>colormap.add_to(m)</span>
<span id="cb19-104"><a href="#cb19-104" aria-hidden="true" tabindex="-1"></a>colormap.caption <span class="op">=</span> <span class="ss">f&#39;Number of Points on Road Segment (10th-90th percentile: </span><span class="sc">{</span>p10<span class="sc">:.0f}</span><span class="ss">-</span><span class="sc">{</span>p99<span class="sc">:.0f}</span><span class="ss">)&#39;</span></span>
<span id="cb19-105"><a href="#cb19-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-106"><a href="#cb19-106" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the map</span></span>
<span id="cb19-107"><a href="#cb19-107" aria-hidden="true" tabindex="-1"></a>m.save(<span class="st">&quot;maps/missoula_road_segments_map_smartbuffer.html&quot;</span>)</span>
<span id="cb19-108"><a href="#cb19-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-109"><a href="#cb19-109" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Map of road segments has been saved as &#39;missoula_road_segments_map_smartbuffer.html&#39;&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code">
<div class="sourceCode" id="cb20"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> folium.features <span class="im">import</span> GeoJsonPopup, GeoJsonTooltip</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> branca.colormap <span class="im">import</span> LinearColormap</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.ops <span class="im">import</span> unary_union</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure the data is in EPSG:5070 projection</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>missoula_roads <span class="op">=</span> missoula_roads.to_crs(epsg<span class="op">=</span><span class="dv">5070</span>)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a smart buffer that fills all space between polygons</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_smart_buffer(gdf):</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    buffer_distance <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    buffered <span class="op">=</span> gdf.<span class="bu">buffer</span>(buffer_distance)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="kw">not</span> unary_union(buffered).is_valid:</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>        buffer_distance <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>        buffered <span class="op">=</span> gdf.<span class="bu">buffer</span>(buffer_distance)</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> gpd.GeoDataFrame(geometry<span class="op">=</span>buffered, crs<span class="op">=</span>gdf.crs)</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the smart buffer</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>missoula_roads_buffer <span class="op">=</span> create_smart_buffer(missoula_roads)</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>missoula_roads_buffer[<span class="st">&#39;uniquename&#39;</span>] <span class="op">=</span> missoula_roads[<span class="st">&#39;uniquename&#39;</span>]</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Process 911 calls data</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>calls_911_2023_2024_buffer <span class="op">=</span> calls_911_2023_2024.copy()</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>calls_911_2023_2024_buffer.to_crs(epsg<span class="op">=</span><span class="dv">5070</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform spatial join and count points</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>roads_calls <span class="op">=</span> missoula_roads_buffer.sjoin(calls_911_2023_2024_buffer).groupby(<span class="st">&#39;uniquename&#39;</span>).size().rename(<span class="st">&#39;n_points&#39;</span>).reset_index()</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>roads_calls <span class="op">=</span> missoula_roads_buffer.merge(roads_calls, on<span class="op">=</span><span class="st">&#39;uniquename&#39;</span>, how<span class="op">=</span><span class="st">&#39;left&#39;</span>)</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill NaN values with 0 for roads with no calls</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>roads_calls[<span class="st">&#39;n_points&#39;</span>] <span class="op">=</span> roads_calls[<span class="st">&#39;n_points&#39;</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only necessary columns</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>roads_calls_fixed <span class="op">=</span> roads_calls[[<span class="st">&#39;uniquename&#39;</span>, <span class="st">&#39;geometry&#39;</span>, <span class="st">&#39;n_points&#39;</span>]]</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove roads starting with &#39;90&#39; in uniquename</span></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>roads_calls_fixed <span class="op">=</span> roads_calls_fixed[<span class="op">~</span>roads_calls_fixed.uniquename.<span class="bu">str</span>.startswith(<span class="st">&#39;90&#39;</span>)]</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a copy for the 20m buffer</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>roads_calls_20m <span class="op">=</span> roads_calls_fixed.copy()</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>roads_calls_20m[<span class="st">&#39;geometry&#39;</span>] <span class="op">=</span> roads_calls_20m.<span class="bu">buffer</span>(<span class="dv">20</span>)</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure the GeoDataFrames are in WGS84 (EPSG:4326) for Folium</span></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>road_segments_original <span class="op">=</span> roads_calls_fixed.to_crs(epsg<span class="op">=</span><span class="dv">4326</span>)</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>road_segments_20m <span class="op">=</span> roads_calls_20m.to_crs(epsg<span class="op">=</span><span class="dv">4326</span>)</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a map centered on Missoula</span></span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> folium.Map(location<span class="op">=</span>[<span class="fl">46.87</span>, <span class="op">-</span><span class="fl">113.99</span>], zoom_start<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a color map with percentile-based scaling</span></span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>min_points <span class="op">=</span> road_segments_original[<span class="st">&#39;n_points&#39;</span>].<span class="bu">min</span>()</span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>max_points <span class="op">=</span> road_segments_original[<span class="st">&#39;n_points&#39;</span>].<span class="bu">max</span>()</span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>p10 <span class="op">=</span> np.percentile(road_segments_original[<span class="st">&#39;n_points&#39;</span>], <span class="dv">10</span>)</span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>p99 <span class="op">=</span> np.percentile(road_segments_original[<span class="st">&#39;n_points&#39;</span>], <span class="dv">99</span>)</span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>colormap <span class="op">=</span> LinearColormap(</span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>    colors <span class="op">=</span> [</span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#00FF00&#39;</span>,  <span class="co"># Green</span></span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#90EE90&#39;</span>,  <span class="co"># Light Green</span></span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#FFA500&#39;</span>,  <span class="co"># Orange</span></span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#FF8C00&#39;</span>,  <span class="co"># Dark Orange</span></span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#FF4500&#39;</span>,  <span class="co"># Red-Orange</span></span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#FF0000&#39;</span>,  <span class="co"># Red</span></span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#DC143C&#39;</span>,  <span class="co"># Crimson</span></span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#B22222&#39;</span>,  <span class="co"># Fire Brick</span></span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#8B0000&#39;</span>,  <span class="co"># Dark Red</span></span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;#000000&#39;</span>   <span class="co"># Black</span></span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a>    vmin<span class="op">=</span>p10,</span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a>    vmax<span class="op">=</span>p99</span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-77"><a href="#cb20-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-78"><a href="#cb20-78" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to get color based on number of points</span></span>
<span id="cb20-79"><a href="#cb20-79" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_color(n_points):</span>
<span id="cb20-80"><a href="#cb20-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n_points <span class="op">&lt;=</span> p10:</span>
<span id="cb20-81"><a href="#cb20-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> colormap(p10)</span>
<span id="cb20-82"><a href="#cb20-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> n_points <span class="op">&gt;=</span> p99:</span>
<span id="cb20-83"><a href="#cb20-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> colormap(p99)</span>
<span id="cb20-84"><a href="#cb20-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb20-85"><a href="#cb20-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> colormap(n_points)</span>
<span id="cb20-86"><a href="#cb20-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-87"><a href="#cb20-87" aria-hidden="true" tabindex="-1"></a><span class="co"># Add original road segments to the map</span></span>
<span id="cb20-88"><a href="#cb20-88" aria-hidden="true" tabindex="-1"></a>folium.GeoJson(</span>
<span id="cb20-89"><a href="#cb20-89" aria-hidden="true" tabindex="-1"></a>    road_segments_original,</span>
<span id="cb20-90"><a href="#cb20-90" aria-hidden="true" tabindex="-1"></a>    style_function<span class="op">=</span><span class="kw">lambda</span> feature: {</span>
<span id="cb20-91"><a href="#cb20-91" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;fillColor&#39;</span>: get_color(feature[<span class="st">&#39;properties&#39;</span>][<span class="st">&#39;n_points&#39;</span>]),</span>
<span id="cb20-92"><a href="#cb20-92" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;color&#39;</span>: <span class="st">&#39;black&#39;</span>,</span>
<span id="cb20-93"><a href="#cb20-93" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;weight&#39;</span>: <span class="dv">1</span>,</span>
<span id="cb20-94"><a href="#cb20-94" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;fillOpacity&#39;</span>: <span class="fl">0.7</span>,</span>
<span id="cb20-95"><a href="#cb20-95" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb20-96"><a href="#cb20-96" aria-hidden="true" tabindex="-1"></a>    tooltip<span class="op">=</span>GeoJsonTooltip(fields<span class="op">=</span>[<span class="st">&#39;uniquename&#39;</span>, <span class="st">&#39;n_points&#39;</span>],</span>
<span id="cb20-97"><a href="#cb20-97" aria-hidden="true" tabindex="-1"></a>                           aliases<span class="op">=</span>[<span class="st">&#39;Road Name&#39;</span>, <span class="st">&#39;Number of Points&#39;</span>],</span>
<span id="cb20-98"><a href="#cb20-98" aria-hidden="true" tabindex="-1"></a>                           localize<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb20-99"><a href="#cb20-99" aria-hidden="true" tabindex="-1"></a>    popup<span class="op">=</span>GeoJsonPopup(fields<span class="op">=</span>[<span class="st">&#39;uniquename&#39;</span>, <span class="st">&#39;n_points&#39;</span>],</span>
<span id="cb20-100"><a href="#cb20-100" aria-hidden="true" tabindex="-1"></a>                       aliases<span class="op">=</span>[<span class="st">&#39;Road Name&#39;</span>, <span class="st">&#39;Number of Points&#39;</span>],</span>
<span id="cb20-101"><a href="#cb20-101" aria-hidden="true" tabindex="-1"></a>                       localize<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-102"><a href="#cb20-102" aria-hidden="true" tabindex="-1"></a>).add_to(m)</span>
<span id="cb20-103"><a href="#cb20-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-104"><a href="#cb20-104" aria-hidden="true" tabindex="-1"></a><span class="co"># Add 20m buffered road segments to the map</span></span>
<span id="cb20-105"><a href="#cb20-105" aria-hidden="true" tabindex="-1"></a>folium.GeoJson(</span>
<span id="cb20-106"><a href="#cb20-106" aria-hidden="true" tabindex="-1"></a>    road_segments_20m,</span>
<span id="cb20-107"><a href="#cb20-107" aria-hidden="true" tabindex="-1"></a>    style_function<span class="op">=</span><span class="kw">lambda</span> feature: {</span>
<span id="cb20-108"><a href="#cb20-108" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;fillColor&#39;</span>: <span class="st">&#39;none&#39;</span>,</span>
<span id="cb20-109"><a href="#cb20-109" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;color&#39;</span>: <span class="st">&#39;white&#39;</span>,</span>
<span id="cb20-110"><a href="#cb20-110" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;weight&#39;</span>: <span class="dv">1</span>,</span>
<span id="cb20-111"><a href="#cb20-111" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;fillOpacity&#39;</span>: <span class="dv">0</span>,</span>
<span id="cb20-112"><a href="#cb20-112" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-113"><a href="#cb20-113" aria-hidden="true" tabindex="-1"></a>).add_to(m)</span>
<span id="cb20-114"><a href="#cb20-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-115"><a href="#cb20-115" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a color legend</span></span>
<span id="cb20-116"><a href="#cb20-116" aria-hidden="true" tabindex="-1"></a>colormap.add_to(m)</span>
<span id="cb20-117"><a href="#cb20-117" aria-hidden="true" tabindex="-1"></a>colormap.caption <span class="op">=</span> <span class="ss">f&#39;Number of Points on Road Segment (10th-90th percentile: </span><span class="sc">{</span>p10<span class="sc">:.0f}</span><span class="ss">-</span><span class="sc">{</span>p99<span class="sc">:.0f}</span><span class="ss">)&#39;</span></span>
<span id="cb20-118"><a href="#cb20-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-119"><a href="#cb20-119" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the map</span></span>
<span id="cb20-120"><a href="#cb20-120" aria-hidden="true" tabindex="-1"></a>m.save(<span class="st">&quot;maps/missoula_road_segments_dual_buffer_map.html&quot;</span>)</span>
<span id="cb20-121"><a href="#cb20-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-122"><a href="#cb20-122" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Map of road segments with dual buffers has been saved as &#39;missoula_road_segments_dual_buffer_map.html&#39;&quot;</span>)</span></code></pre></div>
</div>
<section id="911-calls-map-with-radius-search" class="cell markdown">
<h5>911 Calls map with radius search</h5>
</section>
<div class="cell code">
<div class="sourceCode" id="cb21"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> folium.plugins <span class="im">import</span> Draw</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> branca.element <span class="im">import</span> MacroElement, Template</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> calls_911_2023_2024  <span class="co"># Assuming this is already a GeoDataFrame</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to generate random color</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_color():</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f&#39;#</span><span class="sc">{</span>random<span class="sc">.</span>randint(<span class="dv">0</span>, <span class="bn">0xFFFFFF</span>)<span class="sc">:06x}</span><span class="ss">&#39;</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a color map with random colors</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>unique_call_types <span class="op">=</span> gdf[<span class="st">&#39;Call Type Description&#39;</span>].unique()</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>color_dict <span class="op">=</span> {call_type: random_color() <span class="cf">for</span> call_type <span class="kw">in</span> unique_call_types}</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert GeoDataFrame to a list of dictionaries for JSON serialization</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>calls_data <span class="op">=</span> gdf.copy()</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>calls_data[<span class="st">&#39;lat&#39;</span>] <span class="op">=</span> calls_data.geometry.y</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>calls_data[<span class="st">&#39;lon&#39;</span>] <span class="op">=</span> calls_data.geometry.x</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>calls_data <span class="op">=</span> calls_data.drop(columns<span class="op">=</span>[<span class="st">&#39;geometry&#39;</span>]).to_dict(<span class="st">&#39;records&#39;</span>)</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the map</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>m_911_radius <span class="op">=</span> folium.Map(location<span class="op">=</span>[<span class="fl">46.87</span>, <span class="op">-</span><span class="fl">114.00</span>], zoom_start<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Add Draw plugin</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>draw <span class="op">=</span> Draw()</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>draw.add_to(m_911_radius)</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Custom MacroElement to add JavaScript</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ClickForMarker(MacroElement):</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, calls_data, color_dict):</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(ClickForMarker, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._template <span class="op">=</span> Template(<span class="st">&quot;&quot;&quot;</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a><span class="st">            {% macro script(this, kwargs) %}</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a><span class="st">            var calls_data = </span><span class="sc">{{</span><span class="st"> this.calls_data </span><span class="sc">}}</span><span class="st">;</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a><span class="st">            var color_dict = </span><span class="sc">{{</span><span class="st"> this.color_dict </span><span class="sc">}}</span><span class="st">;</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a><span class="st">            var currentMarker = null;</span></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a><span class="st">            function updateMap(lat, lon) {</span></span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a><span class="st">                // Clear previous update results</span></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a><span class="st">                </span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">.eachLayer(function(layer) {</span></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a><span class="st">                    if (layer instanceof L.CircleMarker || layer instanceof L.Circle) {</span></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a><span class="st">                        </span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">.removeLayer(layer);</span></span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a><span class="st">                    }</span></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a><span class="st">                });</span></span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a><span class="st">                // Remove the current marker if it exists</span></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a><span class="st">                if (currentMarker) {</span></span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a><span class="st">                    </span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">.removeLayer(currentMarker);</span></span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a><span class="st">                }</span></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a><span class="st">                // Create a 100m buffer around the clicked point (approximate)</span></span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a><span class="st">                var buffer_size = 0.00090;  // Approx. 100m in degrees</span></span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a><span class="st">                // Filter calls within the buffer</span></span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a><span class="st">                var calls_in_buffer = calls_data.filter(function(call) {</span></span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a><span class="st">                    var dx = call.lon - lon;</span></span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a><span class="st">                    var dy = call.lat - lat;</span></span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a><span class="st">                    return Math.sqrt(dx*dx + dy*dy) &lt;= buffer_size;</span></span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a><span class="st">                });</span></span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a><span class="st">                // Add circle to show buffer</span></span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a><span class="st">                L.circle([lat, lon], {</span></span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a><span class="st">                    radius: 100,</span></span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a><span class="st">                    color: &#39;red&#39;,</span></span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a><span class="st">                    fillColor: &#39;red&#39;,</span></span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a><span class="st">                    fillOpacity: 0.2</span></span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a><span class="st">                }).addTo(</span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">);</span></span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a><span class="st">                // Add points for calls</span></span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a><span class="st">                calls_in_buffer.forEach(function(call) {</span></span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a><span class="st">                    L.circleMarker([call.lat, call.lon], {</span></span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a><span class="st">                        radius: 5,</span></span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a><span class="st">                        color: color_dict[call[&#39;Call Type Description&#39;]],</span></span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a><span class="st">                        fillColor: color_dict[call[&#39;Call Type Description&#39;]],</span></span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a><span class="st">                        fillOpacity: 1</span></span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a><span class="st">                    }).bindPopup(call[&#39;Call Type Description&#39;]).addTo(</span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">);</span></span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a><span class="st">                });</span></span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a><span class="st">                // Create popup with top 10 call types</span></span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a><span class="st">                var call_type_counts = </span><span class="sc">{}</span><span class="st">;</span></span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a><span class="st">                calls_in_buffer.forEach(function(call) {</span></span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a><span class="st">                    var type = call[&#39;Call Type Description&#39;];</span></span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a><span class="st">                    call_type_counts[type] = (call_type_counts[type] || 0) + 1;</span></span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a><span class="st">                });</span></span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a><span class="st">                var top_calls = Object.entries(call_type_counts)</span></span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a><span class="st">                    .sort((a, b) =&gt; b[1] - a[1])</span></span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a><span class="st">                    .slice(0, 10);</span></span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a><span class="st">                var popup_html = &quot;&lt;h4&gt;Top Call Types:&lt;/h4&gt;&quot;;</span></span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a><span class="st">                top_calls.forEach(function([call_type, count]) {</span></span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a><span class="st">                    popup_html += call_type + &quot;: &quot; + count + &quot;&lt;br&gt;&quot;;</span></span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a><span class="st">                });</span></span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-100"><a href="#cb21-100" aria-hidden="true" tabindex="-1"></a><span class="st">                L.popup()</span></span>
<span id="cb21-101"><a href="#cb21-101" aria-hidden="true" tabindex="-1"></a><span class="st">                    .setLatLng([lat, lon])</span></span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true" tabindex="-1"></a><span class="st">                    .setContent(popup_html)</span></span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true" tabindex="-1"></a><span class="st">                    .openOn(</span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">);</span></span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true" tabindex="-1"></a><span class="st">            }</span></span>
<span id="cb21-105"><a href="#cb21-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-106"><a href="#cb21-106" aria-hidden="true" tabindex="-1"></a><span class="st">            </span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">.on(&#39;click&#39;, function(e) {</span></span>
<span id="cb21-107"><a href="#cb21-107" aria-hidden="true" tabindex="-1"></a><span class="st">                var lat = e.latlng.lat.toFixed(6);</span></span>
<span id="cb21-108"><a href="#cb21-108" aria-hidden="true" tabindex="-1"></a><span class="st">                var lon = e.latlng.lng.toFixed(6);</span></span>
<span id="cb21-109"><a href="#cb21-109" aria-hidden="true" tabindex="-1"></a><span class="st">                </span></span>
<span id="cb21-110"><a href="#cb21-110" aria-hidden="true" tabindex="-1"></a><span class="st">                // Remove the current marker if it exists</span></span>
<span id="cb21-111"><a href="#cb21-111" aria-hidden="true" tabindex="-1"></a><span class="st">                if (currentMarker) {</span></span>
<span id="cb21-112"><a href="#cb21-112" aria-hidden="true" tabindex="-1"></a><span class="st">                    </span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">.removeLayer(currentMarker);</span></span>
<span id="cb21-113"><a href="#cb21-113" aria-hidden="true" tabindex="-1"></a><span class="st">                }</span></span>
<span id="cb21-114"><a href="#cb21-114" aria-hidden="true" tabindex="-1"></a><span class="st">                </span></span>
<span id="cb21-115"><a href="#cb21-115" aria-hidden="true" tabindex="-1"></a><span class="st">                // Create a new marker and store it in currentMarker</span></span>
<span id="cb21-116"><a href="#cb21-116" aria-hidden="true" tabindex="-1"></a><span class="st">                currentMarker = L.marker([lat, lon]).addTo(</span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">);</span></span>
<span id="cb21-117"><a href="#cb21-117" aria-hidden="true" tabindex="-1"></a><span class="st">                currentMarker.bindPopup(&#39;&lt;button onclick=&quot;updateMap(&#39; + lat + &#39;,&#39; + lon + &#39;)&quot;&gt;Analyze This Area&lt;/button&gt;&#39;).openPopup();</span></span>
<span id="cb21-118"><a href="#cb21-118" aria-hidden="true" tabindex="-1"></a><span class="st">            });</span></span>
<span id="cb21-119"><a href="#cb21-119" aria-hidden="true" tabindex="-1"></a><span class="st">            {</span><span class="sc">% e</span><span class="st">ndmacro %}</span></span>
<span id="cb21-120"><a href="#cb21-120" aria-hidden="true" tabindex="-1"></a><span class="st">            &quot;&quot;&quot;</span>)</span>
<span id="cb21-121"><a href="#cb21-121" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.calls_data <span class="op">=</span> calls_data</span>
<span id="cb21-122"><a href="#cb21-122" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.color_dict <span class="op">=</span> color_dict</span>
<span id="cb21-123"><a href="#cb21-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-124"><a href="#cb21-124" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the custom MacroElement to the map</span></span>
<span id="cb21-125"><a href="#cb21-125" aria-hidden="true" tabindex="-1"></a>m_911_radius.add_child(ClickForMarker(json.dumps(calls_data), json.dumps(color_dict)))</span>
<span id="cb21-126"><a href="#cb21-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-127"><a href="#cb21-127" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the map</span></span>
<span id="cb21-128"><a href="#cb21-128" aria-hidden="true" tabindex="-1"></a>m_911_radius.save(<span class="st">&quot;maps/911_calls_map.html&quot;</span>)</span>
<span id="cb21-129"><a href="#cb21-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-130"><a href="#cb21-130" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Map saved as 911_calls_map.html&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code">
<div class="sourceCode" id="cb22"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> folium.plugins <span class="im">import</span> Draw</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> branca.element <span class="im">import</span> MacroElement, Template</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> geopy.geocoders <span class="im">import</span> Nominatim</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> geopy.exc <span class="im">import</span> GeocoderTimedOut</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> calls_911_2023_2024  <span class="co"># Assuming this is already a GeoDataFrame</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to generate random color</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_color():</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f&#39;#</span><span class="sc">{</span>random<span class="sc">.</span>randint(<span class="dv">0</span>, <span class="bn">0xFFFFFF</span>)<span class="sc">:06x}</span><span class="ss">&#39;</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a color map with random colors</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>unique_call_types <span class="op">=</span> gdf[<span class="st">&#39;Call Type Description&#39;</span>].unique()</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>color_dict <span class="op">=</span> {call_type: random_color() <span class="cf">for</span> call_type <span class="kw">in</span> unique_call_types}</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert GeoDataFrame to a list of dictionaries for JSON serialization</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>calls_data <span class="op">=</span> gdf.copy()</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>calls_data[<span class="st">&#39;lat&#39;</span>] <span class="op">=</span> calls_data.geometry.y</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>calls_data[<span class="st">&#39;lon&#39;</span>] <span class="op">=</span> calls_data.geometry.x</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>calls_data <span class="op">=</span> calls_data.drop(columns<span class="op">=</span>[<span class="st">&#39;geometry&#39;</span>]).to_dict(<span class="st">&#39;records&#39;</span>)</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the map</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>m_911_radius <span class="op">=</span> folium.Map(location<span class="op">=</span>[<span class="fl">46.87</span>, <span class="op">-</span><span class="fl">114.00</span>], zoom_start<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a><span class="co"># # Add Draw plugin</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a><span class="co"># draw = Draw()</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a><span class="co"># draw.add_to(m_911_radius)</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Custom MacroElement to add JavaScript</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ClickForMarker(MacroElement):</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, calls_data, color_dict):</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(ClickForMarker, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._template <span class="op">=</span> Template(<span class="st">&quot;&quot;&quot;</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a><span class="st">            {% macro script(this, kwargs) %}</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a><span class="st">            var calls_data = </span><span class="sc">{{</span><span class="st"> this.calls_data </span><span class="sc">}}</span><span class="st">;</span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a><span class="st">            var color_dict = </span><span class="sc">{{</span><span class="st"> this.color_dict </span><span class="sc">}}</span><span class="st">;</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a><span class="st">            var currentMarker = null;</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a><span class="st">            var currentCircle = null;</span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a><span class="st">            function metersToDegreesLat(meters) {</span></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a><span class="st">                return meters / 111320.0; // Roughly 111,320 meters per degree of latitude</span></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a><span class="st">            }</span></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a><span class="st">            function metersToDegreesLon(meters, lat) {</span></span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a><span class="st">                return meters / (111320.0 * Math.cos(lat * Math.PI / 180));</span></span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a><span class="st">            }</span></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a><span class="st">            function updateMap(lat, lon) {</span></span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a><span class="st">                // Get the radius in meters from the input</span></span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a><span class="st">                var radiusMeters = parseFloat(document.getElementById(&#39;radius-input&#39;).value) || 100;</span></span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a><span class="st">                var radiusLat = metersToDegreesLat(radiusMeters);</span></span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a><span class="st">                var radiusLon = metersToDegreesLon(radiusMeters, lat);</span></span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a><span class="st">                // Clear previous update results</span></span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a><span class="st">                </span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">.eachLayer(function(layer) {</span></span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a><span class="st">                    if (layer instanceof L.CircleMarker || layer instanceof L.Circle) {</span></span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a><span class="st">                        </span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">.removeLayer(layer);</span></span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a><span class="st">                    }</span></span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a><span class="st">                });</span></span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a><span class="st">                // Remove the current marker if it exists</span></span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a><span class="st">                if (currentMarker) {</span></span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a><span class="st">                    </span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">.removeLayer(currentMarker);</span></span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a><span class="st">                }</span></span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a><span class="st">                // Remove the current circle if it exists</span></span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a><span class="st">                if (currentCircle) {</span></span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a><span class="st">                    </span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">.removeLayer(currentCircle);</span></span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a><span class="st">                }</span></span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a><span class="st">                // Filter calls within the buffer</span></span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a><span class="st">                var calls_in_buffer = calls_data.filter(function(call) {</span></span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a><span class="st">                    var dx = call.lon - lon;</span></span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a><span class="st">                    var dy = call.lat - lat;</span></span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a><span class="st">                    return Math.sqrt(dx*dx + dy*dy) &lt;= Math.max(radiusLat, radiusLon);</span></span>
<span id="cb22-82"><a href="#cb22-82" aria-hidden="true" tabindex="-1"></a><span class="st">                });</span></span>
<span id="cb22-83"><a href="#cb22-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-84"><a href="#cb22-84" aria-hidden="true" tabindex="-1"></a><span class="st">                // Add circle to show buffer</span></span>
<span id="cb22-85"><a href="#cb22-85" aria-hidden="true" tabindex="-1"></a><span class="st">                currentCircle = L.circle([lat, lon], {</span></span>
<span id="cb22-86"><a href="#cb22-86" aria-hidden="true" tabindex="-1"></a><span class="st">                    radius: radiusMeters,</span></span>
<span id="cb22-87"><a href="#cb22-87" aria-hidden="true" tabindex="-1"></a><span class="st">                    color: &#39;red&#39;,</span></span>
<span id="cb22-88"><a href="#cb22-88" aria-hidden="true" tabindex="-1"></a><span class="st">                    fillColor: &#39;red&#39;,</span></span>
<span id="cb22-89"><a href="#cb22-89" aria-hidden="true" tabindex="-1"></a><span class="st">                    fillOpacity: 0.2</span></span>
<span id="cb22-90"><a href="#cb22-90" aria-hidden="true" tabindex="-1"></a><span class="st">                }).addTo(</span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">);</span></span>
<span id="cb22-91"><a href="#cb22-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-92"><a href="#cb22-92" aria-hidden="true" tabindex="-1"></a><span class="st">                // Add points for calls</span></span>
<span id="cb22-93"><a href="#cb22-93" aria-hidden="true" tabindex="-1"></a><span class="st">                calls_in_buffer.forEach(function(call) {</span></span>
<span id="cb22-94"><a href="#cb22-94" aria-hidden="true" tabindex="-1"></a><span class="st">                    L.circleMarker([call.lat, call.lon], {</span></span>
<span id="cb22-95"><a href="#cb22-95" aria-hidden="true" tabindex="-1"></a><span class="st">                        radius: 5,</span></span>
<span id="cb22-96"><a href="#cb22-96" aria-hidden="true" tabindex="-1"></a><span class="st">                        color: color_dict[call[&#39;Call Type Description&#39;]],</span></span>
<span id="cb22-97"><a href="#cb22-97" aria-hidden="true" tabindex="-1"></a><span class="st">                        fillColor: color_dict[call[&#39;Call Type Description&#39;]],</span></span>
<span id="cb22-98"><a href="#cb22-98" aria-hidden="true" tabindex="-1"></a><span class="st">                        fillOpacity: 1</span></span>
<span id="cb22-99"><a href="#cb22-99" aria-hidden="true" tabindex="-1"></a><span class="st">                    }).bindPopup(call[&#39;Call Type Description&#39;]).addTo(</span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">);</span></span>
<span id="cb22-100"><a href="#cb22-100" aria-hidden="true" tabindex="-1"></a><span class="st">                });</span></span>
<span id="cb22-101"><a href="#cb22-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-102"><a href="#cb22-102" aria-hidden="true" tabindex="-1"></a><span class="st">                // Create popup with top 10 call types</span></span>
<span id="cb22-103"><a href="#cb22-103" aria-hidden="true" tabindex="-1"></a><span class="st">                var call_type_counts = </span><span class="sc">{}</span><span class="st">;</span></span>
<span id="cb22-104"><a href="#cb22-104" aria-hidden="true" tabindex="-1"></a><span class="st">                calls_in_buffer.forEach(function(call) {</span></span>
<span id="cb22-105"><a href="#cb22-105" aria-hidden="true" tabindex="-1"></a><span class="st">                    var type = call[&#39;Call Type Description&#39;];</span></span>
<span id="cb22-106"><a href="#cb22-106" aria-hidden="true" tabindex="-1"></a><span class="st">                    call_type_counts[type] = (call_type_counts[type] || 0) + 1;</span></span>
<span id="cb22-107"><a href="#cb22-107" aria-hidden="true" tabindex="-1"></a><span class="st">                });</span></span>
<span id="cb22-108"><a href="#cb22-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-109"><a href="#cb22-109" aria-hidden="true" tabindex="-1"></a><span class="st">                var top_calls = Object.entries(call_type_counts)</span></span>
<span id="cb22-110"><a href="#cb22-110" aria-hidden="true" tabindex="-1"></a><span class="st">                    .sort((a, b) =&gt; b[1] - a[1])</span></span>
<span id="cb22-111"><a href="#cb22-111" aria-hidden="true" tabindex="-1"></a><span class="st">                    .slice(0, 10);</span></span>
<span id="cb22-112"><a href="#cb22-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-113"><a href="#cb22-113" aria-hidden="true" tabindex="-1"></a><span class="st">                var popup_html = &quot;&lt;h4&gt;Top Call Types:&lt;/h4&gt;&quot;;</span></span>
<span id="cb22-114"><a href="#cb22-114" aria-hidden="true" tabindex="-1"></a><span class="st">                top_calls.forEach(function([call_type, count]) {</span></span>
<span id="cb22-115"><a href="#cb22-115" aria-hidden="true" tabindex="-1"></a><span class="st">                    popup_html += call_type + &quot;: &quot; + count + &quot;&lt;br&gt;&quot;;</span></span>
<span id="cb22-116"><a href="#cb22-116" aria-hidden="true" tabindex="-1"></a><span class="st">                });</span></span>
<span id="cb22-117"><a href="#cb22-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-118"><a href="#cb22-118" aria-hidden="true" tabindex="-1"></a><span class="st">                L.popup()</span></span>
<span id="cb22-119"><a href="#cb22-119" aria-hidden="true" tabindex="-1"></a><span class="st">                    .setLatLng([lat, lon])</span></span>
<span id="cb22-120"><a href="#cb22-120" aria-hidden="true" tabindex="-1"></a><span class="st">                    .setContent(popup_html)</span></span>
<span id="cb22-121"><a href="#cb22-121" aria-hidden="true" tabindex="-1"></a><span class="st">                    .openOn(</span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">);</span></span>
<span id="cb22-122"><a href="#cb22-122" aria-hidden="true" tabindex="-1"></a><span class="st">            }</span></span>
<span id="cb22-123"><a href="#cb22-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-124"><a href="#cb22-124" aria-hidden="true" tabindex="-1"></a><span class="st">            </span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">.on(&#39;click&#39;, function(e) {</span></span>
<span id="cb22-125"><a href="#cb22-125" aria-hidden="true" tabindex="-1"></a><span class="st">                var lat = e.latlng.lat.toFixed(6);</span></span>
<span id="cb22-126"><a href="#cb22-126" aria-hidden="true" tabindex="-1"></a><span class="st">                var lon = e.latlng.lng.toFixed(6);</span></span>
<span id="cb22-127"><a href="#cb22-127" aria-hidden="true" tabindex="-1"></a><span class="st">                </span></span>
<span id="cb22-128"><a href="#cb22-128" aria-hidden="true" tabindex="-1"></a><span class="st">                // Remove the current marker if it exists</span></span>
<span id="cb22-129"><a href="#cb22-129" aria-hidden="true" tabindex="-1"></a><span class="st">                if (currentMarker) {</span></span>
<span id="cb22-130"><a href="#cb22-130" aria-hidden="true" tabindex="-1"></a><span class="st">                    </span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">.removeLayer(currentMarker);</span></span>
<span id="cb22-131"><a href="#cb22-131" aria-hidden="true" tabindex="-1"></a><span class="st">                }</span></span>
<span id="cb22-132"><a href="#cb22-132" aria-hidden="true" tabindex="-1"></a><span class="st">                </span></span>
<span id="cb22-133"><a href="#cb22-133" aria-hidden="true" tabindex="-1"></a><span class="st">                // Create a new marker and store it in currentMarker</span></span>
<span id="cb22-134"><a href="#cb22-134" aria-hidden="true" tabindex="-1"></a><span class="st">                currentMarker = L.marker([lat, lon]).addTo(</span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">);</span></span>
<span id="cb22-135"><a href="#cb22-135" aria-hidden="true" tabindex="-1"></a><span class="st">                currentMarker.bindPopup(&#39;&lt;button onclick=&quot;updateMap(&#39; + lat + &#39;,&#39; + lon + &#39;)&quot;&gt;Analyze This Area&lt;/button&gt;&#39;).openPopup();</span></span>
<span id="cb22-136"><a href="#cb22-136" aria-hidden="true" tabindex="-1"></a><span class="st">            });</span></span>
<span id="cb22-137"><a href="#cb22-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-138"><a href="#cb22-138" aria-hidden="true" tabindex="-1"></a><span class="st">            // Add search and radius control</span></span>
<span id="cb22-139"><a href="#cb22-139" aria-hidden="true" tabindex="-1"></a><span class="st">            var searchControl = L.Control.extend({</span></span>
<span id="cb22-140"><a href="#cb22-140" aria-hidden="true" tabindex="-1"></a><span class="st">                options: {</span></span>
<span id="cb22-141"><a href="#cb22-141" aria-hidden="true" tabindex="-1"></a><span class="st">                    position: &#39;topright&#39;</span></span>
<span id="cb22-142"><a href="#cb22-142" aria-hidden="true" tabindex="-1"></a><span class="st">                },</span></span>
<span id="cb22-143"><a href="#cb22-143" aria-hidden="true" tabindex="-1"></a><span class="st">                onAdd: function (map) {</span></span>
<span id="cb22-144"><a href="#cb22-144" aria-hidden="true" tabindex="-1"></a><span class="st">                    var container = L.DomUtil.create(&#39;div&#39;, &#39;leaflet-bar leaflet-control leaflet-control-custom&#39;);</span></span>
<span id="cb22-145"><a href="#cb22-145" aria-hidden="true" tabindex="-1"></a><span class="st">                    container.style.backgroundColor = &#39;white&#39;;</span></span>
<span id="cb22-146"><a href="#cb22-146" aria-hidden="true" tabindex="-1"></a><span class="st">                    container.style.padding = &#39;5px&#39;;</span></span>
<span id="cb22-147"><a href="#cb22-147" aria-hidden="true" tabindex="-1"></a><span class="st">                    container.innerHTML = &#39;&lt;input type=&quot;text&quot; id=&quot;address-input&quot; placeholder=&quot;Enter address in Missoula, MT&quot;&gt;&#39; +</span></span>
<span id="cb22-148"><a href="#cb22-148" aria-hidden="true" tabindex="-1"></a><span class="st">                                          &#39;&lt;input type=&quot;number&quot; id=&quot;radius-input&quot; placeholder=&quot;Radius (meters)&quot; value=&quot;100&quot;&gt;&#39; +</span></span>
<span id="cb22-149"><a href="#cb22-149" aria-hidden="true" tabindex="-1"></a><span class="st">                                          &#39;&lt;button id=&quot;search-button&quot;&gt;Search&lt;/button&gt;&#39;;</span></span>
<span id="cb22-150"><a href="#cb22-150" aria-hidden="true" tabindex="-1"></a><span class="st">                    container.style.fontSize = &#39;14px&#39;;</span></span>
<span id="cb22-151"><a href="#cb22-151" aria-hidden="true" tabindex="-1"></a><span class="st">                    return container;</span></span>
<span id="cb22-152"><a href="#cb22-152" aria-hidden="true" tabindex="-1"></a><span class="st">                }</span></span>
<span id="cb22-153"><a href="#cb22-153" aria-hidden="true" tabindex="-1"></a><span class="st">            });</span></span>
<span id="cb22-154"><a href="#cb22-154" aria-hidden="true" tabindex="-1"></a><span class="st">            </span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">.addControl(new searchControl());</span></span>
<span id="cb22-155"><a href="#cb22-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-156"><a href="#cb22-156" aria-hidden="true" tabindex="-1"></a><span class="st">            document.getElementById(&#39;search-button&#39;).addEventListener(&#39;click&#39;, function() {</span></span>
<span id="cb22-157"><a href="#cb22-157" aria-hidden="true" tabindex="-1"></a><span class="st">                var address = document.getElementById(&#39;address-input&#39;).value + &#39;, Missoula, MT&#39;;</span></span>
<span id="cb22-158"><a href="#cb22-158" aria-hidden="true" tabindex="-1"></a><span class="st">                fetch(&#39;https://nominatim.openstreetmap.org/search?format=json&amp;q=&#39; + encodeURIComponent(address))</span></span>
<span id="cb22-159"><a href="#cb22-159" aria-hidden="true" tabindex="-1"></a><span class="st">                    .then(response =&gt; response.json())</span></span>
<span id="cb22-160"><a href="#cb22-160" aria-hidden="true" tabindex="-1"></a><span class="st">                    .then(data =&gt; {</span></span>
<span id="cb22-161"><a href="#cb22-161" aria-hidden="true" tabindex="-1"></a><span class="st">                        if (data.length &gt; 0) {</span></span>
<span id="cb22-162"><a href="#cb22-162" aria-hidden="true" tabindex="-1"></a><span class="st">                            var lat = parseFloat(data[0].lat);</span></span>
<span id="cb22-163"><a href="#cb22-163" aria-hidden="true" tabindex="-1"></a><span class="st">                            var lon = parseFloat(data[0].lon);</span></span>
<span id="cb22-164"><a href="#cb22-164" aria-hidden="true" tabindex="-1"></a><span class="st">                            </span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">.setView([lat, lon], 16);</span></span>
<span id="cb22-165"><a href="#cb22-165" aria-hidden="true" tabindex="-1"></a><span class="st">                            if (currentMarker) {</span></span>
<span id="cb22-166"><a href="#cb22-166" aria-hidden="true" tabindex="-1"></a><span class="st">                                </span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">.removeLayer(currentMarker);</span></span>
<span id="cb22-167"><a href="#cb22-167" aria-hidden="true" tabindex="-1"></a><span class="st">                            }</span></span>
<span id="cb22-168"><a href="#cb22-168" aria-hidden="true" tabindex="-1"></a><span class="st">                            currentMarker = L.marker([lat, lon]).addTo(</span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">);</span></span>
<span id="cb22-169"><a href="#cb22-169" aria-hidden="true" tabindex="-1"></a><span class="st">                            currentMarker.bindPopup(&#39;&lt;button onclick=&quot;updateMap(&#39; + lat + &#39;,&#39; + lon + &#39;)&quot;&gt;Analyze This Area&lt;/button&gt;&#39;).openPopup();</span></span>
<span id="cb22-170"><a href="#cb22-170" aria-hidden="true" tabindex="-1"></a><span class="st">                        } else {</span></span>
<span id="cb22-171"><a href="#cb22-171" aria-hidden="true" tabindex="-1"></a><span class="st">                            alert(&#39;Address not found&#39;);</span></span>
<span id="cb22-172"><a href="#cb22-172" aria-hidden="true" tabindex="-1"></a><span class="st">                        }</span></span>
<span id="cb22-173"><a href="#cb22-173" aria-hidden="true" tabindex="-1"></a><span class="st">                    })</span></span>
<span id="cb22-174"><a href="#cb22-174" aria-hidden="true" tabindex="-1"></a><span class="st">                    .catch(error =&gt; {</span></span>
<span id="cb22-175"><a href="#cb22-175" aria-hidden="true" tabindex="-1"></a><span class="st">                        console.error(&#39;Error:&#39;, error);</span></span>
<span id="cb22-176"><a href="#cb22-176" aria-hidden="true" tabindex="-1"></a><span class="st">                        alert(&#39;An error occurred while searching for the address&#39;);</span></span>
<span id="cb22-177"><a href="#cb22-177" aria-hidden="true" tabindex="-1"></a><span class="st">                    });</span></span>
<span id="cb22-178"><a href="#cb22-178" aria-hidden="true" tabindex="-1"></a><span class="st">            });</span></span>
<span id="cb22-179"><a href="#cb22-179" aria-hidden="true" tabindex="-1"></a><span class="st">            {</span><span class="sc">% e</span><span class="st">ndmacro %}</span></span>
<span id="cb22-180"><a href="#cb22-180" aria-hidden="true" tabindex="-1"></a><span class="st">            &quot;&quot;&quot;</span>)</span>
<span id="cb22-181"><a href="#cb22-181" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.calls_data <span class="op">=</span> calls_data</span>
<span id="cb22-182"><a href="#cb22-182" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.color_dict <span class="op">=</span> color_dict</span>
<span id="cb22-183"><a href="#cb22-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-184"><a href="#cb22-184" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the custom MacroElement to the map</span></span>
<span id="cb22-185"><a href="#cb22-185" aria-hidden="true" tabindex="-1"></a>m_911_radius.add_child(ClickForMarker(json.dumps(calls_data), json.dumps(color_dict)))</span>
<span id="cb22-186"><a href="#cb22-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-187"><a href="#cb22-187" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the map</span></span>
<span id="cb22-188"><a href="#cb22-188" aria-hidden="true" tabindex="-1"></a>m_911_radius.save(<span class="st">&quot;9maps/11_calls_map_2.html&quot;</span>)</span>
<span id="cb22-189"><a href="#cb22-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-190"><a href="#cb22-190" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Map saved as 911_calls_map_2.html&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code">
<div class="sourceCode" id="cb23"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> folium.plugins <span class="im">import</span> Draw</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> branca.element <span class="im">import</span> MacroElement, Template</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> calls_911_2023_2024  <span class="co"># Assuming this is already a GeoDataFrame</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>poi <span class="op">=</span> poi.copy()</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to generate random color</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_color():</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f&#39;#</span><span class="sc">{</span>random<span class="sc">.</span>randint(<span class="dv">0</span>, <span class="bn">0xFFFFFF</span>)<span class="sc">:06x}</span><span class="ss">&#39;</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Create color maps</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>unique_call_types <span class="op">=</span> gdf[<span class="st">&#39;Call Type Description&#39;</span>].unique()</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>call_color_dict <span class="op">=</span> {call_type: random_color() <span class="cf">for</span> call_type <span class="kw">in</span> unique_call_types}</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>unique_poi_types <span class="op">=</span> poi[<span class="st">&#39;b_type&#39;</span>].unique()</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>poi_color_map <span class="op">=</span> {b_type: <span class="ss">f&#39;#</span><span class="sc">{</span><span class="bu">hash</span>(b_type) <span class="op">%</span> <span class="bn">0xFFFFFF</span><span class="sc">:06x}</span><span class="ss">&#39;</span> <span class="cf">for</span> b_type <span class="kw">in</span> unique_poi_types}</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert GeoDataFrame to a list of dictionaries for JSON serialization</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>calls_data <span class="op">=</span> gdf.copy()</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>calls_data[<span class="st">&#39;lat&#39;</span>] <span class="op">=</span> calls_data.geometry.y</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>calls_data[<span class="st">&#39;lon&#39;</span>] <span class="op">=</span> calls_data.geometry.x</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>calls_data <span class="op">=</span> calls_data.drop(columns<span class="op">=</span>[<span class="st">&#39;geometry&#39;</span>]).to_dict(<span class="st">&#39;records&#39;</span>)</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the map</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>m_combined <span class="op">=</span> folium.Map(location<span class="op">=</span>[<span class="fl">46.87</span>, <span class="op">-</span><span class="fl">114.00</span>], zoom_start<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Add Draw plugin</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>draw <span class="op">=</span> Draw()</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>draw.add_to(m_combined)</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Create feature groups for POIs</span></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>all_pois <span class="op">=</span> folium.FeatureGroup(name<span class="op">=</span><span class="st">&quot;All POIs&quot;</span>, show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> poi.iterrows():</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>    folium.CircleMarker(</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>        location<span class="op">=</span>[row[<span class="st">&#39;lat&#39;</span>], row[<span class="st">&#39;lon&#39;</span>]],</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>        radius<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>        popup<span class="op">=</span><span class="ss">f&quot;</span><span class="sc">{</span>row[<span class="st">&#39;b_type&#39;</span>]<span class="sc">}</span><span class="ss">&quot;</span>,</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span>poi_color_map[row[<span class="st">&#39;b_type&#39;</span>]],</span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>        fill<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>        fillColor<span class="op">=</span>poi_color_map[row[<span class="st">&#39;b_type&#39;</span>]]</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>    ).add_to(all_pois)</span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>all_pois.add_to(m_combined)</span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> b_type <span class="kw">in</span> unique_poi_types:</span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>    fg <span class="op">=</span> folium.FeatureGroup(name<span class="op">=</span><span class="ss">f&quot;POI: </span><span class="sc">{</span>b_type<span class="sc">}</span><span class="ss">&quot;</span>, show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>    type_df <span class="op">=</span> poi[poi[<span class="st">&#39;b_type&#39;</span>] <span class="op">==</span> b_type]</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> type_df.iterrows():</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>        folium.CircleMarker(</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>            location<span class="op">=</span>[row[<span class="st">&#39;lat&#39;</span>], row[<span class="st">&#39;lon&#39;</span>]],</span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>            radius<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>            popup<span class="op">=</span><span class="ss">f&quot;</span><span class="sc">{</span>row[<span class="st">&#39;b_type&#39;</span>]<span class="sc">}</span><span class="ss">&quot;</span>,</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>poi_color_map[b_type],</span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>            fill<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>            fillColor<span class="op">=</span>poi_color_map[b_type]</span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>        ).add_to(fg)</span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a>    fg.add_to(m_combined)</span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Custom MacroElement to add JavaScript</span></span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ClickForMarker(MacroElement):</span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, calls_data, call_color_dict):</span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(ClickForMarker, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._template <span class="op">=</span> Template(<span class="st">&quot;&quot;&quot;</span></span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a><span class="st">            {% macro script(this, kwargs) %}</span></span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a><span class="st">            var calls_data = </span><span class="sc">{{</span><span class="st"> this.calls_data </span><span class="sc">}}</span><span class="st">;</span></span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a><span class="st">            var call_color_dict = </span><span class="sc">{{</span><span class="st"> this.call_color_dict </span><span class="sc">}}</span><span class="st">;</span></span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a><span class="st">            var currentMarker = null;</span></span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a><span class="st">            var currentCircle = null;</span></span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a><span class="st">            var currentCallMarkers = L.layerGroup().addTo(</span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">);</span></span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a><span class="st">            function metersToDegreesLat(meters) {</span></span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a><span class="st">                return meters / 111320.0;</span></span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a><span class="st">            }</span></span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a><span class="st">            function metersToDegreesLon(meters, lat) {</span></span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a><span class="st">                return meters / (111320.0 * Math.cos(lat * Math.PI / 180));</span></span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a><span class="st">            }</span></span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a><span class="st">            function updateMap(lat, lon) {</span></span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a><span class="st">                var radiusMeters = parseInt(document.getElementById(&#39;radius-select&#39;).value);</span></span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a><span class="st">                var radiusLat = metersToDegreesLat(radiusMeters);</span></span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a><span class="st">                var radiusLon = metersToDegreesLon(radiusMeters, lat);</span></span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a><span class="st">                                  </span></span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a><span class="st">                // change radiusLat and radiusLon based on radiusMeters (i.e. var buffer_size = 0.00090;  Approx. 100m in degrees)</span></span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a><span class="st">                if (radiusMeters == 10) {</span></span>
<span id="cb23-91"><a href="#cb23-91" aria-hidden="true" tabindex="-1"></a><span class="st">                    radiusLat = 0.00010;</span></span>
<span id="cb23-92"><a href="#cb23-92" aria-hidden="true" tabindex="-1"></a><span class="st">                    radiusLon = 0.00010;</span></span>
<span id="cb23-93"><a href="#cb23-93" aria-hidden="true" tabindex="-1"></a><span class="st">                } else if (radiusMeters == 25) {</span></span>
<span id="cb23-94"><a href="#cb23-94" aria-hidden="true" tabindex="-1"></a><span class="st">                    radiusLat = 0.00025;</span></span>
<span id="cb23-95"><a href="#cb23-95" aria-hidden="true" tabindex="-1"></a><span class="st">                    radiusLon = 0.00025;</span></span>
<span id="cb23-96"><a href="#cb23-96" aria-hidden="true" tabindex="-1"></a><span class="st">                } else if (radiusMeters == 50) {</span></span>
<span id="cb23-97"><a href="#cb23-97" aria-hidden="true" tabindex="-1"></a><span class="st">                    radiusLat = 0.00050;</span></span>
<span id="cb23-98"><a href="#cb23-98" aria-hidden="true" tabindex="-1"></a><span class="st">                    radiusLon = 0.00050;</span></span>
<span id="cb23-99"><a href="#cb23-99" aria-hidden="true" tabindex="-1"></a><span class="st">                } else if (radiusMeters == 100) {</span></span>
<span id="cb23-100"><a href="#cb23-100" aria-hidden="true" tabindex="-1"></a><span class="st">                    radiusLat = 0.00100;</span></span>
<span id="cb23-101"><a href="#cb23-101" aria-hidden="true" tabindex="-1"></a><span class="st">                    radiusLon = 0.00100;</span></span>
<span id="cb23-102"><a href="#cb23-102" aria-hidden="true" tabindex="-1"></a><span class="st">                } else if (radiusMeters == 200) {</span></span>
<span id="cb23-103"><a href="#cb23-103" aria-hidden="true" tabindex="-1"></a><span class="st">                    radiusLat = 0.00200;</span></span>
<span id="cb23-104"><a href="#cb23-104" aria-hidden="true" tabindex="-1"></a><span class="st">                    radiusLon = 0.00200;;</span></span>
<span id="cb23-105"><a href="#cb23-105" aria-hidden="true" tabindex="-1"></a><span class="st">                }</span></span>
<span id="cb23-106"><a href="#cb23-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-107"><a href="#cb23-107" aria-hidden="true" tabindex="-1"></a><span class="st">                currentCallMarkers.clearLayers();</span></span>
<span id="cb23-108"><a href="#cb23-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-109"><a href="#cb23-109" aria-hidden="true" tabindex="-1"></a><span class="st">                if (currentCircle) {</span></span>
<span id="cb23-110"><a href="#cb23-110" aria-hidden="true" tabindex="-1"></a><span class="st">                    </span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">.removeLayer(currentCircle);</span></span>
<span id="cb23-111"><a href="#cb23-111" aria-hidden="true" tabindex="-1"></a><span class="st">                }</span></span>
<span id="cb23-112"><a href="#cb23-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-113"><a href="#cb23-113" aria-hidden="true" tabindex="-1"></a><span class="st">                currentCircle = L.circle([lat, lon], {</span></span>
<span id="cb23-114"><a href="#cb23-114" aria-hidden="true" tabindex="-1"></a><span class="st">                    radius: radiusMeters,</span></span>
<span id="cb23-115"><a href="#cb23-115" aria-hidden="true" tabindex="-1"></a><span class="st">                    color: &#39;red&#39;,</span></span>
<span id="cb23-116"><a href="#cb23-116" aria-hidden="true" tabindex="-1"></a><span class="st">                    fillColor: &#39;red&#39;,</span></span>
<span id="cb23-117"><a href="#cb23-117" aria-hidden="true" tabindex="-1"></a><span class="st">                    fillOpacity: 0.2</span></span>
<span id="cb23-118"><a href="#cb23-118" aria-hidden="true" tabindex="-1"></a><span class="st">                }).addTo(</span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">);</span></span>
<span id="cb23-119"><a href="#cb23-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-120"><a href="#cb23-120" aria-hidden="true" tabindex="-1"></a><span class="st">                var calls_in_buffer = calls_data.filter(function(call) {</span></span>
<span id="cb23-121"><a href="#cb23-121" aria-hidden="true" tabindex="-1"></a><span class="st">                    var dx = call.lon - lon;</span></span>
<span id="cb23-122"><a href="#cb23-122" aria-hidden="true" tabindex="-1"></a><span class="st">                    var dy = call.lat - lat;</span></span>
<span id="cb23-123"><a href="#cb23-123" aria-hidden="true" tabindex="-1"></a><span class="st">                    return Math.sqrt(dx*dx + dy*dy) &lt;= Math.max(radiusLat, radiusLon);</span></span>
<span id="cb23-124"><a href="#cb23-124" aria-hidden="true" tabindex="-1"></a><span class="st">                });</span></span>
<span id="cb23-125"><a href="#cb23-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-126"><a href="#cb23-126" aria-hidden="true" tabindex="-1"></a><span class="st">                calls_in_buffer.forEach(function(call) {</span></span>
<span id="cb23-127"><a href="#cb23-127" aria-hidden="true" tabindex="-1"></a><span class="st">                    L.circleMarker([call.lat, call.lon], {</span></span>
<span id="cb23-128"><a href="#cb23-128" aria-hidden="true" tabindex="-1"></a><span class="st">                        radius: 5,</span></span>
<span id="cb23-129"><a href="#cb23-129" aria-hidden="true" tabindex="-1"></a><span class="st">                        color: call_color_dict[call[&#39;Call Type Description&#39;]],</span></span>
<span id="cb23-130"><a href="#cb23-130" aria-hidden="true" tabindex="-1"></a><span class="st">                        fillColor: call_color_dict[call[&#39;Call Type Description&#39;]],</span></span>
<span id="cb23-131"><a href="#cb23-131" aria-hidden="true" tabindex="-1"></a><span class="st">                        fillOpacity: 1</span></span>
<span id="cb23-132"><a href="#cb23-132" aria-hidden="true" tabindex="-1"></a><span class="st">                    }).bindPopup(call[&#39;Call Type Description&#39;]).addTo(currentCallMarkers);</span></span>
<span id="cb23-133"><a href="#cb23-133" aria-hidden="true" tabindex="-1"></a><span class="st">                });</span></span>
<span id="cb23-134"><a href="#cb23-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-135"><a href="#cb23-135" aria-hidden="true" tabindex="-1"></a><span class="st">                var call_type_counts = </span><span class="sc">{}</span><span class="st">;</span></span>
<span id="cb23-136"><a href="#cb23-136" aria-hidden="true" tabindex="-1"></a><span class="st">                calls_in_buffer.forEach(function(call) {</span></span>
<span id="cb23-137"><a href="#cb23-137" aria-hidden="true" tabindex="-1"></a><span class="st">                    var type = call[&#39;Call Type Description&#39;];</span></span>
<span id="cb23-138"><a href="#cb23-138" aria-hidden="true" tabindex="-1"></a><span class="st">                    call_type_counts[type] = (call_type_counts[type] || 0) + 1;</span></span>
<span id="cb23-139"><a href="#cb23-139" aria-hidden="true" tabindex="-1"></a><span class="st">                });</span></span>
<span id="cb23-140"><a href="#cb23-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-141"><a href="#cb23-141" aria-hidden="true" tabindex="-1"></a><span class="st">                var top_calls = Object.entries(call_type_counts)</span></span>
<span id="cb23-142"><a href="#cb23-142" aria-hidden="true" tabindex="-1"></a><span class="st">                    .sort((a, b) =&gt; b[1] - a[1])</span></span>
<span id="cb23-143"><a href="#cb23-143" aria-hidden="true" tabindex="-1"></a><span class="st">                    .slice(0, 10);</span></span>
<span id="cb23-144"><a href="#cb23-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-145"><a href="#cb23-145" aria-hidden="true" tabindex="-1"></a><span class="st">                var popup_html = &quot;&lt;h4&gt;Top Call Types:&lt;/h4&gt;&quot;;</span></span>
<span id="cb23-146"><a href="#cb23-146" aria-hidden="true" tabindex="-1"></a><span class="st">                top_calls.forEach(function([call_type, count]) {</span></span>
<span id="cb23-147"><a href="#cb23-147" aria-hidden="true" tabindex="-1"></a><span class="st">                    popup_html += call_type + &quot;: &quot; + count + &quot;&lt;br&gt;&quot;;</span></span>
<span id="cb23-148"><a href="#cb23-148" aria-hidden="true" tabindex="-1"></a><span class="st">                });</span></span>
<span id="cb23-149"><a href="#cb23-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-150"><a href="#cb23-150" aria-hidden="true" tabindex="-1"></a><span class="st">                L.popup()</span></span>
<span id="cb23-151"><a href="#cb23-151" aria-hidden="true" tabindex="-1"></a><span class="st">                    .setLatLng([lat, lon])</span></span>
<span id="cb23-152"><a href="#cb23-152" aria-hidden="true" tabindex="-1"></a><span class="st">                    .setContent(popup_html)</span></span>
<span id="cb23-153"><a href="#cb23-153" aria-hidden="true" tabindex="-1"></a><span class="st">                    .openOn(</span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">);</span></span>
<span id="cb23-154"><a href="#cb23-154" aria-hidden="true" tabindex="-1"></a><span class="st">            }</span></span>
<span id="cb23-155"><a href="#cb23-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-156"><a href="#cb23-156" aria-hidden="true" tabindex="-1"></a><span class="st">            </span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">.on(&#39;click&#39;, function(e) {</span></span>
<span id="cb23-157"><a href="#cb23-157" aria-hidden="true" tabindex="-1"></a><span class="st">                var lat = e.latlng.lat.toFixed(6);</span></span>
<span id="cb23-158"><a href="#cb23-158" aria-hidden="true" tabindex="-1"></a><span class="st">                var lon = e.latlng.lng.toFixed(6);</span></span>
<span id="cb23-159"><a href="#cb23-159" aria-hidden="true" tabindex="-1"></a><span class="st">                </span></span>
<span id="cb23-160"><a href="#cb23-160" aria-hidden="true" tabindex="-1"></a><span class="st">                if (currentMarker) {</span></span>
<span id="cb23-161"><a href="#cb23-161" aria-hidden="true" tabindex="-1"></a><span class="st">                    </span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">.removeLayer(currentMarker);</span></span>
<span id="cb23-162"><a href="#cb23-162" aria-hidden="true" tabindex="-1"></a><span class="st">                }</span></span>
<span id="cb23-163"><a href="#cb23-163" aria-hidden="true" tabindex="-1"></a><span class="st">                </span></span>
<span id="cb23-164"><a href="#cb23-164" aria-hidden="true" tabindex="-1"></a><span class="st">                currentMarker = L.marker([lat, lon]).addTo(</span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">);</span></span>
<span id="cb23-165"><a href="#cb23-165" aria-hidden="true" tabindex="-1"></a><span class="st">                currentMarker.bindPopup(&#39;&lt;button onclick=&quot;updateMap(&#39; + lat + &#39;,&#39; + lon + &#39;)&quot;&gt;Analyze This Area&lt;/button&gt;&#39;).openPopup();</span></span>
<span id="cb23-166"><a href="#cb23-166" aria-hidden="true" tabindex="-1"></a><span class="st">            });</span></span>
<span id="cb23-167"><a href="#cb23-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-168"><a href="#cb23-168" aria-hidden="true" tabindex="-1"></a><span class="st">            var searchControl = L.Control.extend({</span></span>
<span id="cb23-169"><a href="#cb23-169" aria-hidden="true" tabindex="-1"></a><span class="st">                options: {</span></span>
<span id="cb23-170"><a href="#cb23-170" aria-hidden="true" tabindex="-1"></a><span class="st">                    position: &#39;topright&#39;</span></span>
<span id="cb23-171"><a href="#cb23-171" aria-hidden="true" tabindex="-1"></a><span class="st">                },</span></span>
<span id="cb23-172"><a href="#cb23-172" aria-hidden="true" tabindex="-1"></a><span class="st">                onAdd: function (map) {</span></span>
<span id="cb23-173"><a href="#cb23-173" aria-hidden="true" tabindex="-1"></a><span class="st">                    var container = L.DomUtil.create(&#39;div&#39;, &#39;leaflet-bar leaflet-control leaflet-control-custom&#39;);</span></span>
<span id="cb23-174"><a href="#cb23-174" aria-hidden="true" tabindex="-1"></a><span class="st">                    container.style.backgroundColor = &#39;white&#39;;</span></span>
<span id="cb23-175"><a href="#cb23-175" aria-hidden="true" tabindex="-1"></a><span class="st">                    container.style.padding = &#39;5px&#39;;</span></span>
<span id="cb23-176"><a href="#cb23-176" aria-hidden="true" tabindex="-1"></a><span class="st">                    container.innerHTML = &#39;&lt;input type=&quot;text&quot; id=&quot;address-input&quot; placeholder=&quot;Enter address in Missoula, MT&quot;&gt;&#39; +</span></span>
<span id="cb23-177"><a href="#cb23-177" aria-hidden="true" tabindex="-1"></a><span class="st">                                          &#39;&lt;select id=&quot;radius-select&quot;&gt;&#39; +</span></span>
<span id="cb23-178"><a href="#cb23-178" aria-hidden="true" tabindex="-1"></a><span class="st">                                          &#39;&lt;option value=&quot;10&quot;&gt;10m&lt;/option&gt;&#39; +</span></span>
<span id="cb23-179"><a href="#cb23-179" aria-hidden="true" tabindex="-1"></a><span class="st">                                          &#39;&lt;option value=&quot;25&quot;&gt;25m&lt;/option&gt;&#39; +</span></span>
<span id="cb23-180"><a href="#cb23-180" aria-hidden="true" tabindex="-1"></a><span class="st">                                          &#39;&lt;option value=&quot;50&quot;&gt;50m&lt;/option&gt;&#39; +</span></span>
<span id="cb23-181"><a href="#cb23-181" aria-hidden="true" tabindex="-1"></a><span class="st">                                          &#39;&lt;option value=&quot;100&quot; selected&gt;100m&lt;/option&gt;&#39; +</span></span>
<span id="cb23-182"><a href="#cb23-182" aria-hidden="true" tabindex="-1"></a><span class="st">                                          &#39;&lt;option value=&quot;200&quot;&gt;200m&lt;/option&gt;&#39; +</span></span>
<span id="cb23-183"><a href="#cb23-183" aria-hidden="true" tabindex="-1"></a><span class="st">                                          &#39;&lt;/select&gt;&#39; +</span></span>
<span id="cb23-184"><a href="#cb23-184" aria-hidden="true" tabindex="-1"></a><span class="st">                                          &#39;&lt;button id=&quot;search-button&quot;&gt;Search&lt;/button&gt;&#39;;</span></span>
<span id="cb23-185"><a href="#cb23-185" aria-hidden="true" tabindex="-1"></a><span class="st">                    container.style.fontSize = &#39;14px&#39;;</span></span>
<span id="cb23-186"><a href="#cb23-186" aria-hidden="true" tabindex="-1"></a><span class="st">                    return container;</span></span>
<span id="cb23-187"><a href="#cb23-187" aria-hidden="true" tabindex="-1"></a><span class="st">                }</span></span>
<span id="cb23-188"><a href="#cb23-188" aria-hidden="true" tabindex="-1"></a><span class="st">            });</span></span>
<span id="cb23-189"><a href="#cb23-189" aria-hidden="true" tabindex="-1"></a><span class="st">            </span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">.addControl(new searchControl());</span></span>
<span id="cb23-190"><a href="#cb23-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-191"><a href="#cb23-191" aria-hidden="true" tabindex="-1"></a><span class="st">            document.getElementById(&#39;search-button&#39;).addEventListener(&#39;click&#39;, function() {</span></span>
<span id="cb23-192"><a href="#cb23-192" aria-hidden="true" tabindex="-1"></a><span class="st">                var address = document.getElementById(&#39;address-input&#39;).value + &#39;, Missoula, MT&#39;;</span></span>
<span id="cb23-193"><a href="#cb23-193" aria-hidden="true" tabindex="-1"></a><span class="st">                fetch(&#39;https://nominatim.openstreetmap.org/search?format=json&amp;q=&#39; + encodeURIComponent(address))</span></span>
<span id="cb23-194"><a href="#cb23-194" aria-hidden="true" tabindex="-1"></a><span class="st">                    .then(response =&gt; response.json())</span></span>
<span id="cb23-195"><a href="#cb23-195" aria-hidden="true" tabindex="-1"></a><span class="st">                    .then(data =&gt; {</span></span>
<span id="cb23-196"><a href="#cb23-196" aria-hidden="true" tabindex="-1"></a><span class="st">                        if (data.length &gt; 0) {</span></span>
<span id="cb23-197"><a href="#cb23-197" aria-hidden="true" tabindex="-1"></a><span class="st">                            var lat = parseFloat(data[0].lat);</span></span>
<span id="cb23-198"><a href="#cb23-198" aria-hidden="true" tabindex="-1"></a><span class="st">                            var lon = parseFloat(data[0].lon);</span></span>
<span id="cb23-199"><a href="#cb23-199" aria-hidden="true" tabindex="-1"></a><span class="st">                            </span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">.setView([lat, lon], 16);</span></span>
<span id="cb23-200"><a href="#cb23-200" aria-hidden="true" tabindex="-1"></a><span class="st">                            if (currentMarker) {</span></span>
<span id="cb23-201"><a href="#cb23-201" aria-hidden="true" tabindex="-1"></a><span class="st">                                </span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">.removeLayer(currentMarker);</span></span>
<span id="cb23-202"><a href="#cb23-202" aria-hidden="true" tabindex="-1"></a><span class="st">                            }</span></span>
<span id="cb23-203"><a href="#cb23-203" aria-hidden="true" tabindex="-1"></a><span class="st">                            currentMarker = L.marker([lat, lon]).addTo(</span><span class="sc">{{</span><span class="st"> this._parent.get_name() </span><span class="sc">}}</span><span class="st">);</span></span>
<span id="cb23-204"><a href="#cb23-204" aria-hidden="true" tabindex="-1"></a><span class="st">                            currentMarker.bindPopup(&#39;&lt;button onclick=&quot;updateMap(&#39; + lat + &#39;,&#39; + lon + &#39;)&quot;&gt;Analyze This Area&lt;/button&gt;&#39;).openPopup();</span></span>
<span id="cb23-205"><a href="#cb23-205" aria-hidden="true" tabindex="-1"></a><span class="st">                        } else {</span></span>
<span id="cb23-206"><a href="#cb23-206" aria-hidden="true" tabindex="-1"></a><span class="st">                            alert(&#39;Address not found&#39;);</span></span>
<span id="cb23-207"><a href="#cb23-207" aria-hidden="true" tabindex="-1"></a><span class="st">                        }</span></span>
<span id="cb23-208"><a href="#cb23-208" aria-hidden="true" tabindex="-1"></a><span class="st">                    })</span></span>
<span id="cb23-209"><a href="#cb23-209" aria-hidden="true" tabindex="-1"></a><span class="st">                    .catch(error =&gt; {</span></span>
<span id="cb23-210"><a href="#cb23-210" aria-hidden="true" tabindex="-1"></a><span class="st">                        console.error(&#39;Error:&#39;, error);</span></span>
<span id="cb23-211"><a href="#cb23-211" aria-hidden="true" tabindex="-1"></a><span class="st">                        alert(&#39;An error occurred while searching for the address&#39;);</span></span>
<span id="cb23-212"><a href="#cb23-212" aria-hidden="true" tabindex="-1"></a><span class="st">                    });</span></span>
<span id="cb23-213"><a href="#cb23-213" aria-hidden="true" tabindex="-1"></a><span class="st">            });</span></span>
<span id="cb23-214"><a href="#cb23-214" aria-hidden="true" tabindex="-1"></a><span class="st">            {</span><span class="sc">% e</span><span class="st">ndmacro %}</span></span>
<span id="cb23-215"><a href="#cb23-215" aria-hidden="true" tabindex="-1"></a><span class="st">            &quot;&quot;&quot;</span>)</span>
<span id="cb23-216"><a href="#cb23-216" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.calls_data <span class="op">=</span> calls_data</span>
<span id="cb23-217"><a href="#cb23-217" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.call_color_dict <span class="op">=</span> call_color_dict</span>
<span id="cb23-218"><a href="#cb23-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-219"><a href="#cb23-219" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the custom MacroElement to the map</span></span>
<span id="cb23-220"><a href="#cb23-220" aria-hidden="true" tabindex="-1"></a>m_combined.add_child(ClickForMarker(json.dumps(calls_data), json.dumps(call_color_dict)))</span>
<span id="cb23-221"><a href="#cb23-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-222"><a href="#cb23-222" aria-hidden="true" tabindex="-1"></a><span class="co"># Add layer control to the map</span></span>
<span id="cb23-223"><a href="#cb23-223" aria-hidden="true" tabindex="-1"></a>folium.LayerControl().add_to(m_combined)</span>
<span id="cb23-224"><a href="#cb23-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-225"><a href="#cb23-225" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a legend for POIs</span></span>
<span id="cb23-226"><a href="#cb23-226" aria-hidden="true" tabindex="-1"></a>poi_legend_html <span class="op">=</span> <span class="st">&#39;&#39;&#39;</span></span>
<span id="cb23-227"><a href="#cb23-227" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;div style=&quot;position: fixed; bottom: 50px; left: 50px; width: 220px; height: 180px; </span></span>
<span id="cb23-228"><a href="#cb23-228" aria-hidden="true" tabindex="-1"></a><span class="st">    border:2px solid grey; z-index:9999; font-size:14px; background-color:white;</span></span>
<span id="cb23-229"><a href="#cb23-229" aria-hidden="true" tabindex="-1"></a><span class="st">    overflow-y: auto;&quot;&gt;</span></span>
<span id="cb23-230"><a href="#cb23-230" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;p&gt;&lt;strong&gt;POI Types:&lt;/strong&gt;&lt;/p&gt;</span></span>
<span id="cb23-231"><a href="#cb23-231" aria-hidden="true" tabindex="-1"></a><span class="st">    &#39;&#39;&#39;</span></span>
<span id="cb23-232"><a href="#cb23-232" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> b_type, color <span class="kw">in</span> poi_color_map.items():</span>
<span id="cb23-233"><a href="#cb23-233" aria-hidden="true" tabindex="-1"></a>    poi_legend_html <span class="op">+=</span> <span class="ss">f&#39;&lt;p&gt;&lt;span style=&quot;color:</span><span class="sc">{</span>color<span class="sc">}</span><span class="ss">;&quot;&gt;●&lt;/span&gt; </span><span class="sc">{</span>b_type<span class="sc">}</span><span class="ss">&lt;/p&gt;&#39;</span></span>
<span id="cb23-234"><a href="#cb23-234" aria-hidden="true" tabindex="-1"></a>poi_legend_html <span class="op">+=</span> <span class="st">&#39;&lt;/div&gt;&#39;</span></span>
<span id="cb23-235"><a href="#cb23-235" aria-hidden="true" tabindex="-1"></a>m_combined.get_root().html.add_child(folium.Element(poi_legend_html))</span>
<span id="cb23-236"><a href="#cb23-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-237"><a href="#cb23-237" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a legend for 911 call types</span></span>
<span id="cb23-238"><a href="#cb23-238" aria-hidden="true" tabindex="-1"></a>call_legend_html <span class="op">=</span> <span class="st">&#39;&#39;&#39;</span></span>
<span id="cb23-239"><a href="#cb23-239" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;div style=&quot;position: fixed; bottom: 50px; right: 50px; width: 220px; height: 180px; </span></span>
<span id="cb23-240"><a href="#cb23-240" aria-hidden="true" tabindex="-1"></a><span class="st">    border:2px solid grey; z-index:9999; font-size:14px; background-color:white;</span></span>
<span id="cb23-241"><a href="#cb23-241" aria-hidden="true" tabindex="-1"></a><span class="st">    overflow-y: auto;&quot;&gt;</span></span>
<span id="cb23-242"><a href="#cb23-242" aria-hidden="true" tabindex="-1"></a><span class="st">    &lt;p&gt;&lt;strong&gt;911 Call Types:&lt;/strong&gt;&lt;/p&gt;</span></span>
<span id="cb23-243"><a href="#cb23-243" aria-hidden="true" tabindex="-1"></a><span class="st">    &#39;&#39;&#39;</span></span>
<span id="cb23-244"><a href="#cb23-244" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> call_type, color <span class="kw">in</span> call_color_dict.items():</span>
<span id="cb23-245"><a href="#cb23-245" aria-hidden="true" tabindex="-1"></a>    call_legend_html <span class="op">+=</span> <span class="ss">f&#39;&lt;p&gt;&lt;span style=&quot;color:</span><span class="sc">{</span>color<span class="sc">}</span><span class="ss">;&quot;&gt;●&lt;/span&gt; </span><span class="sc">{</span>call_type<span class="sc">}</span><span class="ss">&lt;/p&gt;&#39;</span></span>
<span id="cb23-246"><a href="#cb23-246" aria-hidden="true" tabindex="-1"></a>call_legend_html <span class="op">+=</span> <span class="st">&#39;&lt;/div&gt;&#39;</span></span>
<span id="cb23-247"><a href="#cb23-247" aria-hidden="true" tabindex="-1"></a>m_combined.get_root().html.add_child(folium.Element(call_legend_html))</span>
<span id="cb23-248"><a href="#cb23-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-249"><a href="#cb23-249" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the map</span></span>
<span id="cb23-250"><a href="#cb23-250" aria-hidden="true" tabindex="-1"></a>m_combined.save(<span class="st">&quot;maps/911_poi_combined_map.html&quot;</span>)</span>
<span id="cb23-251"><a href="#cb23-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-252"><a href="#cb23-252" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Combined map saved as 911_poi_combined_map.html&quot;</span>)</span></code></pre></div>
</div>
<section id="911-calls-by-type-for-each-poi-b_type"
class="cell markdown">
<h5>911 calls by type for each POI b_type</h5>
</section>
<div class="cell code" data-execution_count="10">
<div class="sourceCode" id="cb24"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>buffer_radius <span class="op">=</span> <span class="dv">50</span></span></code></pre></div>
</div>
<section id="call-type-counts-by-b_type-aggregate-for-all-b_types"
class="cell markdown">
<h6>Call type counts by b_type (aggregate for all b_types)</h6>
</section>
<div class="cell code">
<div class="sourceCode" id="cb25"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Assuming calls_911_2023_2024 and poi are already GeoDataFrames in CRS 5070</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>calls_911_gdf <span class="op">=</span> calls_911_2023_2024.to_crs(epsg<span class="op">=</span><span class="dv">5070</span>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>poi_gdf <span class="op">=</span> poi</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure the geometry columns are properly set</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>calls_911_gdf <span class="op">=</span> calls_911_gdf.set_geometry(<span class="st">&#39;geometry&#39;</span>)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>poi_gdf <span class="op">=</span> poi_gdf.set_geometry(<span class="st">&#39;geometry&#39;</span>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Count the number of each b_type</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>b_type_counts <span class="op">=</span> poi_gdf[<span class="st">&#39;b_type&#39;</span>].value_counts().reset_index()</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>b_type_counts.columns <span class="op">=</span> [<span class="st">&#39;b_type&#39;</span>, <span class="st">&#39;POI_Count&#39;</span>]</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a buffer around each POI</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>poi_gdf[<span class="st">&#39;buffer&#39;</span>] <span class="op">=</span> poi_gdf.geometry.<span class="bu">buffer</span>(buffer_radius)</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>poi_gdf <span class="op">=</span> poi_gdf.set_geometry(<span class="st">&#39;buffer&#39;</span>)</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial join to find calls within 50 meters of each POI</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>calls_near_poi <span class="op">=</span> gpd.sjoin(calls_911_gdf, poi_gdf[[<span class="st">&#39;buffer&#39;</span>, <span class="st">&#39;b_type&#39;</span>]], predicate<span class="op">=</span><span class="st">&#39;within&#39;</span>, how<span class="op">=</span><span class="st">&#39;inner&#39;</span>)</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Group by b_type and Call Type Description</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>grouped <span class="op">=</span> calls_near_poi.groupby([<span class="st">&#39;b_type&#39;</span>, <span class="st">&#39;Call Type Description&#39;</span>]).size().unstack(fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate total for each b_type and add as a column</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>grouped[<span class="st">&#39;Total&#39;</span>] <span class="op">=</span> grouped.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort rows by total calls descending</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>poi_911_calls <span class="op">=</span> grouped.sort_values(<span class="st">&#39;Total&#39;</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort columns by total calls descending, keeping &#39;Total&#39; as the last column</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>column_order <span class="op">=</span> poi_911_calls.<span class="bu">sum</span>().sort_values(ascending<span class="op">=</span><span class="va">False</span>).index.tolist()</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>column_order.remove(<span class="st">&#39;Total&#39;</span>)</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>column_order.append(<span class="st">&#39;Total&#39;</span>)</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>poi_911_calls <span class="op">=</span> poi_911_calls[column_order]</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the POI count column</span></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>poi_911_calls <span class="op">=</span> poi_911_calls.reset_index().merge(b_type_counts, on<span class="op">=</span><span class="st">&#39;b_type&#39;</span>, how<span class="op">=</span><span class="st">&#39;left&#39;</span>).set_index(<span class="st">&#39;b_type&#39;</span>)</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Reorder columns to put POI_Count right after b_type</span></span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>columns <span class="op">=</span> poi_911_calls.columns.tolist()</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>columns.remove(<span class="st">&#39;POI_Count&#39;</span>)</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>columns.insert(<span class="dv">0</span>, <span class="st">&#39;POI_Count&#39;</span>)</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>poi_911_calls_by_b_type <span class="op">=</span> poi_911_calls[columns]</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename the index to &#39;b_type&#39;</span></span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>poi_911_calls_by_b_type.index.name <span class="op">=</span> <span class="st">&#39;b_type&#39;</span></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(poi_911_calls_by_b_type)</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Save to CSV</span></span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a>poi_911_calls_by_b_type.to_csv(<span class="st">&#39;data/missoula/poi_911_calls_summary.csv&#39;</span>)</span></code></pre></div>
</div>
<section
id="call-type-counts-for-each-unique-address-with-b_type-column"
class="cell markdown">
<h6>Call type counts for each unique address (with b_type column)</h6>
</section>
<div class="cell code">
<div class="sourceCode" id="cb26"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Assuming calls_911_2023_2024 and poi are already GeoDataFrames in CRS 5070</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>calls_911_gdf <span class="op">=</span> calls_911_2023_2024.to_crs(epsg<span class="op">=</span><span class="dv">5070</span>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>poi_gdf <span class="op">=</span> poi</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure the geometry columns are properly set</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>calls_911_gdf <span class="op">=</span> calls_911_gdf.set_geometry(<span class="st">&#39;geometry&#39;</span>)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>poi_gdf <span class="op">=</span> poi_gdf.set_geometry(<span class="st">&#39;geometry&#39;</span>)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a buffer around each POI</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>poi_gdf[<span class="st">&#39;buffer&#39;</span>] <span class="op">=</span> poi_gdf.geometry.<span class="bu">buffer</span>(buffer_radius)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>poi_gdf <span class="op">=</span> poi_gdf.set_geometry(<span class="st">&#39;buffer&#39;</span>)</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine b_types for POIs with the same address</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>poi_grouped <span class="op">=</span> poi_gdf.groupby(<span class="st">&#39;formatted&#39;</span>).agg({</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;b_type&#39;</span>: <span class="kw">lambda</span> x: <span class="st">&#39;, &#39;</span>.join(<span class="bu">sorted</span>(<span class="bu">set</span>(x))),</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;buffer&#39;</span>: <span class="st">&#39;first&#39;</span>  <span class="co"># Take the first buffer for each address</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>}).reset_index()</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a><span class="co"># set it as a gpd</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>poi_grouped <span class="op">=</span> gpd.GeoDataFrame(poi_grouped, geometry<span class="op">=</span><span class="st">&#39;buffer&#39;</span>)</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>poi_grouped.crs <span class="op">=</span> poi_gdf.crs</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial join to find calls within 50 meters of each POI</span></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>calls_near_poi <span class="op">=</span> gpd.sjoin(calls_911_gdf, poi_grouped[[<span class="st">&#39;buffer&#39;</span>, <span class="st">&#39;formatted&#39;</span>, <span class="st">&#39;b_type&#39;</span>]], predicate<span class="op">=</span><span class="st">&#39;within&#39;</span>, how<span class="op">=</span><span class="st">&#39;inner&#39;</span>)</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Group by formatted address and Call Type Description</span></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>grouped <span class="op">=</span> calls_near_poi.groupby([<span class="st">&#39;formatted&#39;</span>, <span class="st">&#39;Call Type Description&#39;</span>]).size().unstack(fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate total for each address and add as a column</span></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>grouped[<span class="st">&#39;Total&#39;</span>] <span class="op">=</span> grouped.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort rows by total calls descending</span></span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>poi_911_calls <span class="op">=</span> grouped.sort_values(<span class="st">&#39;Total&#39;</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort columns by total calls descending, keeping &#39;Total&#39; as the last column</span></span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>column_order <span class="op">=</span> poi_911_calls.<span class="bu">sum</span>().sort_values(ascending<span class="op">=</span><span class="va">False</span>).index.tolist()</span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>column_order.remove(<span class="st">&#39;Total&#39;</span>)</span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>column_order.append(<span class="st">&#39;Total&#39;</span>)</span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>poi_911_calls <span class="op">=</span> poi_911_calls[column_order]</span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the b_type column</span></span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>b_type_map <span class="op">=</span> poi_grouped.set_index(<span class="st">&#39;formatted&#39;</span>)[<span class="st">&#39;b_type&#39;</span>]</span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>poi_911_calls[<span class="st">&#39;b_type&#39;</span>] <span class="op">=</span> poi_911_calls.index.<span class="bu">map</span>(b_type_map)</span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Reorder columns to put b_type right after the index</span></span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>columns <span class="op">=</span> poi_911_calls.columns.tolist()</span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>columns.remove(<span class="st">&#39;b_type&#39;</span>)</span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>columns.insert(<span class="dv">0</span>, <span class="st">&#39;b_type&#39;</span>)</span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>poi_911_calls_by_poi_address <span class="op">=</span> poi_911_calls[columns]</span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename the index to &#39;Address&#39;</span></span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a>poi_911_calls_by_poi_address.index.name <span class="op">=</span> <span class="st">&#39;Address&#39;</span></span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(poi_911_calls_by_poi_address)</span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Save to CSV</span></span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a>poi_911_calls_by_poi_address.to_csv(<span class="st">&#39;data/missoula/poi_911_calls_summary_by_address.csv&#39;</span>)</span></code></pre></div>
</div>
<div class="cell code">
<div class="sourceCode" id="cb27"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>poi_911_calls_by_poi_address</span></code></pre></div>
</div>
<section id="total-call-counts-for-each-b_type" class="cell markdown">
<h6>Total call counts for each b_type</h6>
</section>
<div class="cell code">
<div class="sourceCode" id="cb28"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot poi_911_calls for each b_type, sum across all call types</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>poi_911_calls_by_b_type.loc[:, <span class="st">&#39;Total&#39;</span>].sort_values(ascending<span class="op">=</span><span class="va">False</span>).plot(kind<span class="op">=</span><span class="st">&#39;bar&#39;</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">8</span>), color<span class="op">=</span><span class="st">&#39;skyblue&#39;</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;Total 911 Calls by Business Type within </span><span class="sc">{}</span><span class="st"> Meters&#39;</span>.<span class="bu">format</span>(buffer_radius))</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;Total Calls&#39;</span>)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;Business Type&#39;</span>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
</div>
<div class="cell code">
<div class="sourceCode" id="cb29"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot poi_911_calls for each b_type, sum across all call types, scaled by the number of POIs of that type</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>poi_911_calls_by_b_type[<span class="st">&#39;Total_per_POI&#39;</span>] <span class="op">=</span> poi_911_calls_by_b_type[<span class="st">&#39;Total&#39;</span>] <span class="op">/</span> poi_911_calls_by_b_type[<span class="st">&#39;POI_Count&#39;</span>]</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>poi_911_calls_by_b_type.loc[:, <span class="st">&#39;Total_per_POI&#39;</span>].sort_values(ascending<span class="op">=</span><span class="va">False</span>).plot(kind<span class="op">=</span><span class="st">&#39;bar&#39;</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">10</span>), color<span class="op">=</span><span class="st">&#39;skyblue&#39;</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;Total 911 Calls by Business Type per POI, scaled by number of POIs within </span><span class="sc">{}</span><span class="st"> Meters&#39;</span>.<span class="bu">format</span>(buffer_radius))</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;Total Calls per POI&#39;</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;Business Type&#39;</span>)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
</div>
<section id="filterable-plot-of-top-10-call-types-for-each-b_type"
class="cell markdown">
<h5>Filterable plot of top 10 call types for each b_type</h5>
</section>
<div class="cell code">
<div class="sourceCode" id="cb30"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotly.subplots <span class="im">import</span> make_subplots</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data (assuming you&#39;ve already created this CSV in the previous step)</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>poi_911_calls <span class="op">=</span> pd.read_csv(<span class="st">&#39;data/missoula/poi_911_calls_summary.csv&#39;</span>, index_col<span class="op">=</span><span class="st">&#39;b_type&#39;</span>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove &#39;POI_Count&#39; and &#39;Total&#39; columns for this analysis</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>call_type_data <span class="op">=</span> poi_911_calls.drop([<span class="st">&#39;POI_Count&#39;</span>, <span class="st">&#39;Total&#39;</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create dropdown menu options</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>dropdown_options <span class="op">=</span> [{<span class="st">&#39;label&#39;</span>: b_type, <span class="st">&#39;value&#39;</span>: b_type} <span class="cf">for</span> b_type <span class="kw">in</span> call_type_data.index]</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to get top 10 call types for a given b_type</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_top_10_call_types(b_type):</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> call_type_data.loc[b_type].nlargest(<span class="dv">10</span>)</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the initial plot (we&#39;ll use the first b_type as default)</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>initial_b_type <span class="op">=</span> call_type_data.index[<span class="dv">0</span>]</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>initial_data <span class="op">=</span> get_top_10_call_types(initial_b_type)</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> make_subplots(rows<span class="op">=</span><span class="dv">1</span>, cols<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>bar <span class="op">=</span> go.Bar(</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>initial_data.index,</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>initial_data.values,</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span>initial_b_type</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>fig.add_trace(bar)</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Update layout</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">&#39;Top 10 Call Types by POI Type within </span><span class="sc">{}</span><span class="st"> meters of POIs&#39;</span>.<span class="bu">format</span>(buffer_radius),</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">&#39;Call Type&#39;</span>,</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>    yaxis_title<span class="op">=</span><span class="st">&#39;Number of Calls&#39;</span>,</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>    updatemenus<span class="op">=</span>[{</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;buttons&#39;</span>: [</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>                <span class="st">&#39;method&#39;</span>: <span class="st">&#39;update&#39;</span>,</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>                <span class="st">&#39;label&#39;</span>: b_type,</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>                <span class="st">&#39;args&#39;</span>: [{<span class="st">&#39;x&#39;</span>: [get_top_10_call_types(b_type).index],</span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>                          <span class="st">&#39;y&#39;</span>: [get_top_10_call_types(b_type).values]},</span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>                         {<span class="st">&#39;title&#39;</span>: <span class="ss">f&#39;Top 10 Call Types for </span><span class="sc">{</span>b_type<span class="sc">}</span><span class="ss"> within </span><span class="sc">{</span>buffer_radius<span class="sc">}</span><span class="ss"> meters of POIs&#39;</span>,}]</span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>            } <span class="cf">for</span> b_type <span class="kw">in</span> call_type_data.index</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;direction&#39;</span>: <span class="st">&#39;down&#39;</span>,</span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;showactive&#39;</span>: <span class="va">True</span>,</span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>    }]</span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>fig.show()</span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a><span class="co"># If you want to save the plot as an HTML file for later viewing:</span></span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>fig.write_html(<span class="st">&quot;charts/interactive_911_calls_plot.html&quot;</span>)</span></code></pre></div>
</div>
<section
id="call-type-counts-by-poi-as-percentage-of-total-calls-for-that-poi"
class="cell markdown">
<h6>Call type counts by POI as percentage of total calls for that
POI</h6>
</section>
<div class="cell code">
<div class="sourceCode" id="cb31"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotly.subplots <span class="im">import</span> make_subplots</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>poi_911_calls <span class="op">=</span> pd.read_csv(<span class="st">&#39;data/missoula/poi_911_calls_summary.csv&#39;</span>, index_col<span class="op">=</span><span class="st">&#39;b_type&#39;</span>)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove &#39;POI_Count&#39; column for this analysis</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>call_type_data <span class="op">=</span> poi_911_calls.drop(<span class="st">&#39;POI_Count&#39;</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to get top 10 call types proportions for a given b_type</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_top_10_call_types_prop(b_type):</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    b_type_data <span class="op">=</span> call_type_data.loc[b_type]</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    total_calls <span class="op">=</span> b_type_data[<span class="st">&#39;Total&#39;</span>]</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    proportions <span class="op">=</span> (b_type_data.drop(<span class="st">&#39;Total&#39;</span>) <span class="op">/</span> total_calls <span class="op">*</span> <span class="dv">100</span>).nlargest(<span class="dv">10</span>)</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> proportions</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Create dropdown menu options</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>dropdown_options <span class="op">=</span> [{<span class="st">&#39;label&#39;</span>: b_type, <span class="st">&#39;value&#39;</span>: b_type} <span class="cf">for</span> b_type <span class="kw">in</span> call_type_data.index]</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the initial plot (we&#39;ll use the first b_type as default)</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>initial_b_type <span class="op">=</span> call_type_data.index[<span class="dv">0</span>]</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>initial_data <span class="op">=</span> get_top_10_call_types_prop(initial_b_type)</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> make_subplots(rows<span class="op">=</span><span class="dv">1</span>, cols<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>bar <span class="op">=</span> go.Bar(</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>initial_data.index,</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>initial_data.values,</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span>initial_b_type,</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>    text<span class="op">=</span>[<span class="ss">f&#39;</span><span class="sc">{</span>val<span class="sc">:.2f}</span><span class="ss">%&#39;</span> <span class="cf">for</span> val <span class="kw">in</span> initial_data.values],</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>    textposition<span class="op">=</span><span class="st">&#39;auto&#39;</span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>fig.add_trace(bar)</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Update layout</span></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="ss">f&#39;Top 10 Call Types for </span><span class="sc">{</span>initial_b_type<span class="sc">}</span><span class="ss"> (% of Total Calls)&#39;</span>,</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">&#39;Call Type&#39;</span>,</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>    yaxis_title<span class="op">=</span><span class="st">&#39;Percentage of Calls&#39;</span>,</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>    yaxis<span class="op">=</span><span class="bu">dict</span>(<span class="bu">range</span><span class="op">=</span>[<span class="dv">0</span>, <span class="dv">100</span>]),  <span class="co"># Set y-axis range from 0 to 100%</span></span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>    updatemenus<span class="op">=</span>[{</span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;buttons&#39;</span>: [</span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>                <span class="st">&#39;method&#39;</span>: <span class="st">&#39;update&#39;</span>,</span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>                <span class="st">&#39;label&#39;</span>: b_type,</span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>                <span class="st">&#39;args&#39;</span>: [{<span class="st">&#39;x&#39;</span>: [get_top_10_call_types_prop(b_type).index],</span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>                          <span class="st">&#39;y&#39;</span>: [get_top_10_call_types_prop(b_type).values],</span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>                          <span class="st">&#39;text&#39;</span>: [[<span class="ss">f&#39;</span><span class="sc">{</span>val<span class="sc">:.2f}</span><span class="ss">%&#39;</span> <span class="cf">for</span> val <span class="kw">in</span> get_top_10_call_types_prop(b_type).values]]},</span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a>                         {<span class="st">&#39;title&#39;</span>: <span class="ss">f&#39;Top 10 Call Types for </span><span class="sc">{</span>b_type<span class="sc">}</span><span class="ss"> (% of Total Calls)&#39;</span>}]</span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a>            } <span class="cf">for</span> b_type <span class="kw">in</span> call_type_data.index</span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;direction&#39;</span>: <span class="st">&#39;down&#39;</span>,</span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;showactive&#39;</span>: <span class="va">True</span>,</span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a>    }]</span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a>fig.show()</span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the plot as an HTML file for later viewing</span></span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a>fig.write_html(<span class="st">&quot;charts/interactive_911_calls_plot_proportional.html&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code">
<div class="sourceCode" id="cb32"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>poi_911_calls <span class="op">=</span> pd.read_csv(<span class="st">&#39;data/missoula/poi_911_calls_summary.csv&#39;</span>, index_col<span class="op">=</span><span class="st">&#39;b_type&#39;</span>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove &#39;POI_Count&#39; column for this analysis</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>call_type_data <span class="op">=</span> poi_911_calls.drop(<span class="st">&#39;POI_Count&#39;</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to get top 10 call types for a given b_type</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_top_10_call_types(b_type):</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> call_type_data.loc[b_type].drop(<span class="st">&#39;Total&#39;</span>).nlargest(<span class="dv">10</span>)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to get top 10 call types proportions for a given b_type</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_top_10_call_types_prop(b_type):</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    b_type_data <span class="op">=</span> call_type_data.loc[b_type]</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    total_calls <span class="op">=</span> b_type_data[<span class="st">&#39;Total&#39;</span>]</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    proportions <span class="op">=</span> (b_type_data.drop(<span class="st">&#39;Total&#39;</span>) <span class="op">/</span> total_calls <span class="op">*</span> <span class="dv">100</span>).nlargest(<span class="dv">10</span>)</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> proportions</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the initial plot (we&#39;ll use the first b_type as default)</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>initial_b_type <span class="op">=</span> call_type_data.index[<span class="dv">0</span>]</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>initial_data_count <span class="op">=</span> get_top_10_call_types(initial_b_type)</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>initial_data_prop <span class="op">=</span> get_top_10_call_types_prop(initial_b_type)</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Add traces for both count and percentage views</span></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Bar(</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>initial_data_count.index,</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>initial_data_count.values,</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">&#39;Count&#39;</span>,</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>    visible<span class="op">=</span><span class="va">True</span></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Bar(</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>initial_data_prop.index,</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>initial_data_prop.values,</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">&#39;Percentage&#39;</span>,</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>    text<span class="op">=</span>[<span class="ss">f&#39;</span><span class="sc">{</span>val<span class="sc">:.2f}</span><span class="ss">%&#39;</span> <span class="cf">for</span> val <span class="kw">in</span> initial_data_prop.values],</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>    textposition<span class="op">=</span><span class="st">&#39;auto&#39;</span>,</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>    visible<span class="op">=</span><span class="va">False</span></span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Update layout</span></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="ss">f&#39;Top 10 Call Types for </span><span class="sc">{</span>initial_b_type<span class="sc">}</span><span class="ss">&#39;</span>,</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">&#39;Call Type&#39;</span>,</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>    yaxis_title<span class="op">=</span><span class="st">&#39;Number of Calls&#39;</span>,</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>    updatemenus<span class="op">=</span>[</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Dropdown for POI type selection</span></span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;buttons&#39;</span>: [</span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;method&#39;</span>: <span class="st">&#39;update&#39;</span>,</span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;label&#39;</span>: b_type,</span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;args&#39;</span>: [</span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>                        {</span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;x&#39;</span>: [get_top_10_call_types(b_type).index, get_top_10_call_types_prop(b_type).index],</span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;y&#39;</span>: [get_top_10_call_types(b_type).values, get_top_10_call_types_prop(b_type).values],</span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;text&#39;</span>: [<span class="va">None</span>, [<span class="ss">f&#39;</span><span class="sc">{</span>val<span class="sc">:.2f}</span><span class="ss">%&#39;</span> <span class="cf">for</span> val <span class="kw">in</span> get_top_10_call_types_prop(b_type).values]]</span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a>                        },</span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a>                        {<span class="st">&#39;title&#39;</span>: <span class="ss">f&#39;Top 10 Call Types for </span><span class="sc">{</span>b_type<span class="sc">}</span><span class="ss">&#39;</span>}</span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a>                    ]</span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a>                } <span class="cf">for</span> b_type <span class="kw">in</span> call_type_data.index</span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a>            ],</span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;direction&#39;</span>: <span class="st">&#39;down&#39;</span>,</span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;showactive&#39;</span>: <span class="va">True</span>,</span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;x&#39;</span>: <span class="fl">0.1</span>,</span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;xanchor&#39;</span>: <span class="st">&#39;left&#39;</span>,</span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;y&#39;</span>: <span class="fl">1.15</span>,</span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;yanchor&#39;</span>: <span class="st">&#39;top&#39;</span></span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Buttons for toggling between count and percentage views</span></span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;type&#39;</span>: <span class="st">&#39;buttons&#39;</span>,</span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;direction&#39;</span>: <span class="st">&#39;right&#39;</span>,</span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;x&#39;</span>: <span class="fl">0.5</span>,</span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;xanchor&#39;</span>: <span class="st">&#39;center&#39;</span>,</span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;y&#39;</span>: <span class="fl">1.15</span>,</span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;yanchor&#39;</span>: <span class="st">&#39;top&#39;</span>,</span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;buttons&#39;</span>: [</span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;label&#39;</span>: <span class="st">&quot;Count&quot;</span>,</span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;method&#39;</span>: <span class="st">&#39;update&#39;</span>,</span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;args&#39;</span>: [</span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a>                        {<span class="st">&#39;visible&#39;</span>: [<span class="va">True</span>, <span class="va">False</span>]},</span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a>                        {<span class="st">&#39;yaxis&#39;</span>: {<span class="st">&#39;title&#39;</span>: <span class="st">&#39;Number of Calls&#39;</span>, <span class="st">&#39;autorange&#39;</span>: <span class="va">True</span>}}</span>
<span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a>                    ]</span>
<span id="cb32-90"><a href="#cb32-90" aria-hidden="true" tabindex="-1"></a>                },</span>
<span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;label&#39;</span>: <span class="st">&quot;Percentage&quot;</span>,</span>
<span id="cb32-93"><a href="#cb32-93" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;method&#39;</span>: <span class="st">&#39;update&#39;</span>,</span>
<span id="cb32-94"><a href="#cb32-94" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;args&#39;</span>: [</span>
<span id="cb32-95"><a href="#cb32-95" aria-hidden="true" tabindex="-1"></a>                        {<span class="st">&#39;visible&#39;</span>: [<span class="va">False</span>, <span class="va">True</span>]},</span>
<span id="cb32-96"><a href="#cb32-96" aria-hidden="true" tabindex="-1"></a>                        {<span class="st">&#39;yaxis&#39;</span>: {<span class="st">&#39;title&#39;</span>: <span class="st">&#39;Percentage of Calls&#39;</span>, <span class="st">&#39;range&#39;</span>: [<span class="dv">0</span>, <span class="dv">100</span>]}}</span>
<span id="cb32-97"><a href="#cb32-97" aria-hidden="true" tabindex="-1"></a>                    ]</span>
<span id="cb32-98"><a href="#cb32-98" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb32-99"><a href="#cb32-99" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb32-100"><a href="#cb32-100" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb32-101"><a href="#cb32-101" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb32-102"><a href="#cb32-102" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-103"><a href="#cb32-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-104"><a href="#cb32-104" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="cb32-105"><a href="#cb32-105" aria-hidden="true" tabindex="-1"></a>fig.show()</span>
<span id="cb32-106"><a href="#cb32-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-107"><a href="#cb32-107" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the plot as an HTML file for later viewing</span></span>
<span id="cb32-108"><a href="#cb32-108" aria-hidden="true" tabindex="-1"></a>fig.write_html(<span class="st">&quot;charts/interactive_911_calls_plot_combined.html&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code">
<div class="sourceCode" id="cb33"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>poi_911_calls <span class="op">=</span> pd.read_csv(<span class="st">&#39;data/missoula/poi_911_calls_summary.csv&#39;</span>, index_col<span class="op">=</span><span class="st">&#39;b_type&#39;</span>)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove &#39;POI_Count&#39; column for this analysis</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>call_type_data <span class="op">=</span> poi_911_calls.drop(<span class="st">&#39;POI_Count&#39;</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate overall top call types</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>overall_top_calls <span class="op">=</span> call_type_data.drop(<span class="st">&#39;Total&#39;</span>, axis<span class="op">=</span><span class="dv">1</span>).<span class="bu">sum</span>().sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to get top 10 call types for a given b_type, ignoring top N overall</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_top_10_call_types(b_type, ignore_top_n):</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    ignored_calls <span class="op">=</span> <span class="bu">set</span>(overall_top_calls.nlargest(ignore_top_n).index)</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    filtered_data <span class="op">=</span> call_type_data.loc[b_type].drop(<span class="st">&#39;Total&#39;</span>).drop(ignored_calls, errors<span class="op">=</span><span class="st">&#39;ignore&#39;</span>)</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> filtered_data.nlargest(<span class="dv">10</span>)</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to get top 10 call types proportions for a given b_type, ignoring top N overall</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_top_10_call_types_prop(b_type, ignore_top_n):</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>    ignored_calls <span class="op">=</span> <span class="bu">set</span>(overall_top_calls.nlargest(ignore_top_n).index)</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    b_type_data <span class="op">=</span> call_type_data.loc[b_type]</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    total_calls <span class="op">=</span> b_type_data[<span class="st">&#39;Total&#39;</span>]</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    filtered_data <span class="op">=</span> b_type_data.drop(<span class="st">&#39;Total&#39;</span>).drop(ignored_calls, errors<span class="op">=</span><span class="st">&#39;ignore&#39;</span>)</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>    proportions <span class="op">=</span> (filtered_data <span class="op">/</span> total_calls <span class="op">*</span> <span class="dv">100</span>).nlargest(<span class="dv">10</span>)</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> proportions</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the initial plot</span></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>initial_b_type <span class="op">=</span> call_type_data.index[<span class="dv">0</span>]</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>initial_ignore_top_n <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>initial_data_count <span class="op">=</span> get_top_10_call_types(initial_b_type, initial_ignore_top_n)</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>initial_data_prop <span class="op">=</span> get_top_10_call_types_prop(initial_b_type, initial_ignore_top_n)</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Add traces for both count and percentage views</span></span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Bar(</span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>initial_data_count.index,</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>initial_data_count.values,</span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">&#39;Count&#39;</span>,</span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a>    visible<span class="op">=</span><span class="va">True</span></span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Bar(</span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>initial_data_prop.index,</span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>initial_data_prop.values,</span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">&#39;Percentage&#39;</span>,</span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a>    text<span class="op">=</span>[<span class="ss">f&#39;</span><span class="sc">{</span>val<span class="sc">:.2f}</span><span class="ss">%&#39;</span> <span class="cf">for</span> val <span class="kw">in</span> initial_data_prop.values],</span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a>    textposition<span class="op">=</span><span class="st">&#39;auto&#39;</span>,</span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a>    visible<span class="op">=</span><span class="va">False</span></span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to create slider steps</span></span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_slider_steps(b_type):</span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [</span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;method&#39;</span>: <span class="st">&#39;update&#39;</span>,</span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;label&#39;</span>: <span class="bu">str</span>(n),</span>
<span id="cb33-59"><a href="#cb33-59" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;args&#39;</span>: [</span>
<span id="cb33-60"><a href="#cb33-60" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="cb33-61"><a href="#cb33-61" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;x&#39;</span>: [get_top_10_call_types(b_type, n).index, </span>
<span id="cb33-62"><a href="#cb33-62" aria-hidden="true" tabindex="-1"></a>                          get_top_10_call_types_prop(b_type, n).index],</span>
<span id="cb33-63"><a href="#cb33-63" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;y&#39;</span>: [get_top_10_call_types(b_type, n).values, </span>
<span id="cb33-64"><a href="#cb33-64" aria-hidden="true" tabindex="-1"></a>                          get_top_10_call_types_prop(b_type, n).values],</span>
<span id="cb33-65"><a href="#cb33-65" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;text&#39;</span>: [<span class="va">None</span>, [<span class="ss">f&#39;</span><span class="sc">{</span>val<span class="sc">:.2f}</span><span class="ss">%&#39;</span> <span class="cf">for</span> val <span class="kw">in</span> get_top_10_call_types_prop(b_type, n).values]]</span>
<span id="cb33-66"><a href="#cb33-66" aria-hidden="true" tabindex="-1"></a>                },</span>
<span id="cb33-67"><a href="#cb33-67" aria-hidden="true" tabindex="-1"></a>                {<span class="st">&#39;title&#39;</span>: <span class="ss">f&#39;Top 10 Call Types for </span><span class="sc">{</span>b_type<span class="sc">}</span><span class="ss"> (Ignoring top </span><span class="sc">{</span>n<span class="sc">}</span><span class="ss"> overall)&#39;</span>}</span>
<span id="cb33-68"><a href="#cb33-68" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb33-69"><a href="#cb33-69" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">for</span> n <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="dv">11</span>)  <span class="co"># Allows ignoring 0 to 10 top overall call types</span></span>
<span id="cb33-70"><a href="#cb33-70" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb33-71"><a href="#cb33-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-72"><a href="#cb33-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Update layout</span></span>
<span id="cb33-73"><a href="#cb33-73" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb33-74"><a href="#cb33-74" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="ss">f&#39;Top 10 Call Types for </span><span class="sc">{</span>initial_b_type<span class="sc">}</span><span class="ss"> (Ignoring top </span><span class="sc">{</span>initial_ignore_top_n<span class="sc">}</span><span class="ss"> overall)&#39;</span>,</span>
<span id="cb33-75"><a href="#cb33-75" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">&#39;Call Type&#39;</span>,</span>
<span id="cb33-76"><a href="#cb33-76" aria-hidden="true" tabindex="-1"></a>    yaxis_title<span class="op">=</span><span class="st">&#39;Number of Calls&#39;</span>,</span>
<span id="cb33-77"><a href="#cb33-77" aria-hidden="true" tabindex="-1"></a>    updatemenus<span class="op">=</span>[</span>
<span id="cb33-78"><a href="#cb33-78" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Dropdown for POI type selection</span></span>
<span id="cb33-79"><a href="#cb33-79" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb33-80"><a href="#cb33-80" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;buttons&#39;</span>: [</span>
<span id="cb33-81"><a href="#cb33-81" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="cb33-82"><a href="#cb33-82" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;method&#39;</span>: <span class="st">&#39;update&#39;</span>,</span>
<span id="cb33-83"><a href="#cb33-83" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;label&#39;</span>: b_type,</span>
<span id="cb33-84"><a href="#cb33-84" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;args&#39;</span>: [</span>
<span id="cb33-85"><a href="#cb33-85" aria-hidden="true" tabindex="-1"></a>                        {</span>
<span id="cb33-86"><a href="#cb33-86" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;x&#39;</span>: [get_top_10_call_types(b_type, initial_ignore_top_n).index, </span>
<span id="cb33-87"><a href="#cb33-87" aria-hidden="true" tabindex="-1"></a>                                  get_top_10_call_types_prop(b_type, initial_ignore_top_n).index],</span>
<span id="cb33-88"><a href="#cb33-88" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;y&#39;</span>: [get_top_10_call_types(b_type, initial_ignore_top_n).values, </span>
<span id="cb33-89"><a href="#cb33-89" aria-hidden="true" tabindex="-1"></a>                                  get_top_10_call_types_prop(b_type, initial_ignore_top_n).values],</span>
<span id="cb33-90"><a href="#cb33-90" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;text&#39;</span>: [<span class="va">None</span>, [<span class="ss">f&#39;</span><span class="sc">{</span>val<span class="sc">:.2f}</span><span class="ss">%&#39;</span> <span class="cf">for</span> val <span class="kw">in</span> get_top_10_call_types_prop(b_type, initial_ignore_top_n).values]]</span>
<span id="cb33-91"><a href="#cb33-91" aria-hidden="true" tabindex="-1"></a>                        },</span>
<span id="cb33-92"><a href="#cb33-92" aria-hidden="true" tabindex="-1"></a>                        {</span>
<span id="cb33-93"><a href="#cb33-93" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;title&#39;</span>: <span class="ss">f&#39;Top 10 Call Types for </span><span class="sc">{</span>b_type<span class="sc">}</span><span class="ss"> (Ignoring top </span><span class="sc">{</span>initial_ignore_top_n<span class="sc">}</span><span class="ss"> overall)&#39;</span>,</span>
<span id="cb33-94"><a href="#cb33-94" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;sliders[0].steps&#39;</span>: create_slider_steps(b_type)</span>
<span id="cb33-95"><a href="#cb33-95" aria-hidden="true" tabindex="-1"></a>                        }</span>
<span id="cb33-96"><a href="#cb33-96" aria-hidden="true" tabindex="-1"></a>                    ]</span>
<span id="cb33-97"><a href="#cb33-97" aria-hidden="true" tabindex="-1"></a>                } <span class="cf">for</span> b_type <span class="kw">in</span> call_type_data.index</span>
<span id="cb33-98"><a href="#cb33-98" aria-hidden="true" tabindex="-1"></a>            ],</span>
<span id="cb33-99"><a href="#cb33-99" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;direction&#39;</span>: <span class="st">&#39;down&#39;</span>,</span>
<span id="cb33-100"><a href="#cb33-100" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;showactive&#39;</span>: <span class="va">True</span>,</span>
<span id="cb33-101"><a href="#cb33-101" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;x&#39;</span>: <span class="fl">0.5</span>,</span>
<span id="cb33-102"><a href="#cb33-102" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;xanchor&#39;</span>: <span class="st">&#39;left&#39;</span>,</span>
<span id="cb33-103"><a href="#cb33-103" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;y&#39;</span>: <span class="fl">1.15</span>,</span>
<span id="cb33-104"><a href="#cb33-104" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;yanchor&#39;</span>: <span class="st">&#39;top&#39;</span></span>
<span id="cb33-105"><a href="#cb33-105" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb33-106"><a href="#cb33-106" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Buttons for toggling between count and percentage views</span></span>
<span id="cb33-107"><a href="#cb33-107" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb33-108"><a href="#cb33-108" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;type&#39;</span>: <span class="st">&#39;buttons&#39;</span>,</span>
<span id="cb33-109"><a href="#cb33-109" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;direction&#39;</span>: <span class="st">&#39;right&#39;</span>,</span>
<span id="cb33-110"><a href="#cb33-110" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;x&#39;</span>: <span class="fl">0.8</span>,</span>
<span id="cb33-111"><a href="#cb33-111" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;xanchor&#39;</span>: <span class="st">&#39;center&#39;</span>,</span>
<span id="cb33-112"><a href="#cb33-112" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;y&#39;</span>: <span class="fl">1.15</span>,</span>
<span id="cb33-113"><a href="#cb33-113" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;yanchor&#39;</span>: <span class="st">&#39;top&#39;</span>,</span>
<span id="cb33-114"><a href="#cb33-114" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;buttons&#39;</span>: [</span>
<span id="cb33-115"><a href="#cb33-115" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="cb33-116"><a href="#cb33-116" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;label&#39;</span>: <span class="st">&quot;Count&quot;</span>,</span>
<span id="cb33-117"><a href="#cb33-117" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;method&#39;</span>: <span class="st">&#39;update&#39;</span>,</span>
<span id="cb33-118"><a href="#cb33-118" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;args&#39;</span>: [</span>
<span id="cb33-119"><a href="#cb33-119" aria-hidden="true" tabindex="-1"></a>                        {<span class="st">&#39;visible&#39;</span>: [<span class="va">True</span>, <span class="va">False</span>]},</span>
<span id="cb33-120"><a href="#cb33-120" aria-hidden="true" tabindex="-1"></a>                        {<span class="st">&#39;yaxis&#39;</span>: {<span class="st">&#39;title&#39;</span>: <span class="st">&#39;Number of Calls&#39;</span>, <span class="st">&#39;autorange&#39;</span>: <span class="va">True</span>}}</span>
<span id="cb33-121"><a href="#cb33-121" aria-hidden="true" tabindex="-1"></a>                    ]</span>
<span id="cb33-122"><a href="#cb33-122" aria-hidden="true" tabindex="-1"></a>                },</span>
<span id="cb33-123"><a href="#cb33-123" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="cb33-124"><a href="#cb33-124" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;label&#39;</span>: <span class="st">&quot;Percentage&quot;</span>,</span>
<span id="cb33-125"><a href="#cb33-125" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;method&#39;</span>: <span class="st">&#39;update&#39;</span>,</span>
<span id="cb33-126"><a href="#cb33-126" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;args&#39;</span>: [</span>
<span id="cb33-127"><a href="#cb33-127" aria-hidden="true" tabindex="-1"></a>                        {<span class="st">&#39;visible&#39;</span>: [<span class="va">False</span>, <span class="va">True</span>]},</span>
<span id="cb33-128"><a href="#cb33-128" aria-hidden="true" tabindex="-1"></a>                        {<span class="st">&#39;yaxis&#39;</span>: {<span class="st">&#39;title&#39;</span>: <span class="st">&#39;Percentage of Calls for this POI&#39;</span>, <span class="st">&#39;range&#39;</span>: [<span class="dv">0</span>, <span class="dv">100</span>]}}</span>
<span id="cb33-129"><a href="#cb33-129" aria-hidden="true" tabindex="-1"></a>                    ]</span>
<span id="cb33-130"><a href="#cb33-130" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb33-131"><a href="#cb33-131" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb33-132"><a href="#cb33-132" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb33-133"><a href="#cb33-133" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb33-134"><a href="#cb33-134" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add a slider to control the number of top overall call types to ignore</span></span>
<span id="cb33-135"><a href="#cb33-135" aria-hidden="true" tabindex="-1"></a>    sliders<span class="op">=</span>[{</span>
<span id="cb33-136"><a href="#cb33-136" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;active&#39;</span>: <span class="dv">0</span>,</span>
<span id="cb33-137"><a href="#cb33-137" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;currentvalue&#39;</span>: {<span class="st">&quot;prefix&quot;</span>: <span class="st">&quot;Ignore top N overall: &quot;</span>},</span>
<span id="cb33-138"><a href="#cb33-138" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;pad&#39;</span>: {<span class="st">&quot;t&quot;</span>: <span class="dv">50</span>},</span>
<span id="cb33-139"><a href="#cb33-139" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;steps&#39;</span>: create_slider_steps(initial_b_type)</span>
<span id="cb33-140"><a href="#cb33-140" aria-hidden="true" tabindex="-1"></a>    }]</span>
<span id="cb33-141"><a href="#cb33-141" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-142"><a href="#cb33-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-143"><a href="#cb33-143" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the plot as an HTML file for later viewing</span></span>
<span id="cb33-144"><a href="#cb33-144" aria-hidden="true" tabindex="-1"></a>fig.write_html(<span class="st">&quot;charts/interactive_911_calls_plot_with_ignore.html&quot;</span>)</span></code></pre></div>
</div>
<section id="categorize-calls-by-violent-and-non-violent"
class="cell markdown">
<h6>Categorize calls by violent and non-violent</h6>
</section>
<div class="cell code">
<div class="sourceCode" id="cb34"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># List of Violent call types</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>violent_calls <span class="op">=</span> [</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Assault&#39;</span>, <span class="st">&#39;Assault with a Weapon&#39;</span>, <span class="st">&#39;Domestic Animal&#39;</span>, <span class="st">&#39;Homicide&#39;</span>, </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Intimidation&#39;</span>, <span class="st">&#39;Kidnapping&#39;</span>, <span class="st">&#39;Partner Family Member Assault&#39;</span>, </span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Robbery&#39;</span>, <span class="st">&#39;Sexual Assault&#39;</span>, <span class="st">&#39;Shots Fired&#39;</span>, <span class="st">&#39;Shots Heard&#39;</span>, </span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Suicidal Person&#39;</span>, <span class="st">&#39;Suicide&#39;</span>, <span class="st">&#39;Weapons - Carry/Possess&#39;</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to classify call types</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> classify_call(call_type):</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&#39;Violent&#39;</span> <span class="cf">if</span> call_type <span class="kw">in</span> violent_calls <span class="cf">else</span> <span class="st">&#39;Nonviolent&#39;</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Add new column &#39;crime_type&#39; to the DataFrame</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>calls_911_2023[<span class="st">&#39;crime_type&#39;</span>] <span class="op">=</span> calls_911_2023[<span class="st">&#39;Call Type Description&#39;</span>].<span class="bu">apply</span>(classify_call)</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the first few rows to verify the new column</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(calls_911_2023[[<span class="st">&#39;Call Type Description&#39;</span>, <span class="st">&#39;crime_type&#39;</span>]].head())</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Print value counts to see the distribution</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(calls_911_2023[<span class="st">&#39;crime_type&#39;</span>].value_counts())</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: If you want to see the distribution as percentages</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(calls_911_2023[<span class="st">&#39;crime_type&#39;</span>].value_counts(normalize<span class="op">=</span><span class="va">True</span>))</span></code></pre></div>
</div>
<section id="911-calls-time-series" class="cell markdown">
<h5>911 Calls Time Series</h5>
</section>
<section id="911-calls-time-series-by-day" class="cell markdown">
<h6>911 Calls Time Series by Day</h6>
</section>
<div class="cell code">
<div class="sourceCode" id="cb35"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> calls_911_2023_2024</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Call Creation Date and Time&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Call Creation Date and Time&#39;</span>].astype(<span class="st">&#39;datetime64[ns]&#39;</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract date</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Date&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Call Creation Date and Time&#39;</span>].dt.date</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a dataframe with each day as a row and columns for each call type</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>daily_counts <span class="op">=</span> df.groupby([<span class="st">&#39;Date&#39;</span>, <span class="st">&#39;Call Type Description&#39;</span>]).size().unstack(fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a total column</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>daily_counts[<span class="st">&#39;Total&#39;</span>] <span class="op">=</span> daily_counts.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort the index to ensure chronological order</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>daily_counts <span class="op">=</span> daily_counts.sort_index()</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to get top 10 call types for a given date</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_top_10_call_types(date):</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    day_data <span class="op">=</span> daily_counts.loc[date].sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    top_10 <span class="op">=</span> day_data.head(<span class="dv">10</span>)</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&#39;&lt;br&gt;&#39;</span>.join([<span class="ss">f&quot;</span><span class="sc">{</span>call_type<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>count<span class="sc">}</span><span class="ss">&quot;</span> <span class="cf">for</span> call_type, count <span class="kw">in</span> top_10.items() <span class="cf">if</span> call_type <span class="op">!=</span> <span class="st">&#39;Total&#39;</span>])</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Create hover text for each day</span></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>hover_text <span class="op">=</span> daily_counts.index.<span class="bu">map</span>(get_top_10_call_types)</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot</span></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Add trace for total calls (visible by default)</span></span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>fig.add_trace(</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    go.Scatter(</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>daily_counts.index,</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span>daily_counts[<span class="st">&#39;Total&#39;</span>],</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">&#39;Total Calls&#39;</span>,</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>        line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">&#39;black&#39;</span>, width<span class="op">=</span><span class="dv">2</span>),</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>        hovertemplate<span class="op">=</span><span class="st">&#39;&lt;b&gt;Date&lt;/b&gt;: %</span><span class="sc">{x}</span><span class="st">&lt;br&gt;&#39;</span> <span class="op">+</span></span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&#39;&lt;b&gt;Total Calls&lt;/b&gt;: %</span><span class="sc">{y}</span><span class="st">&lt;br&gt;&lt;br&gt;&#39;</span> <span class="op">+</span></span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>                      <span class="st">&#39;&lt;b&gt;Top 10 Call Types:&lt;/b&gt;&lt;br&gt;%</span><span class="sc">{text}</span><span class="st">&#39;</span>,</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>        text<span class="op">=</span>hover_text</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Add traces for each call type (hidden by default)</span></span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> column <span class="kw">in</span> daily_counts.columns:</span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> column <span class="op">!=</span> <span class="st">&#39;Total&#39;</span>:</span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>        fig.add_trace(</span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>            go.Scatter(</span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>                x<span class="op">=</span>daily_counts.index,</span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>                y<span class="op">=</span>daily_counts[column],</span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>                name<span class="op">=</span>column,</span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a>                visible<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>                hovertemplate<span class="op">=</span><span class="st">&#39;&lt;b&gt;Date&lt;/b&gt;: %</span><span class="sc">{x}</span><span class="st">&lt;br&gt;&#39;</span> <span class="op">+</span></span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>                              <span class="ss">f&#39;&lt;b&gt;</span><span class="sc">{</span>column<span class="sc">}</span><span class="ss">&lt;/b&gt;: %</span><span class="ch">{{</span><span class="ss">y</span><span class="ch">}}</span><span class="ss">&lt;br&gt;&lt;br&gt;&#39;</span> <span class="op">+</span></span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;&lt;b&gt;Top 10 Call Types:&lt;/b&gt;&lt;br&gt;%</span><span class="sc">{text}</span><span class="st">&#39;</span>,</span>
<span id="cb35-58"><a href="#cb35-58" aria-hidden="true" tabindex="-1"></a>                text<span class="op">=</span>hover_text</span>
<span id="cb35-59"><a href="#cb35-59" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb35-60"><a href="#cb35-60" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb35-61"><a href="#cb35-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-62"><a href="#cb35-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Create buttons for filtering</span></span>
<span id="cb35-63"><a href="#cb35-63" aria-hidden="true" tabindex="-1"></a>buttons <span class="op">=</span> [<span class="bu">dict</span>(</span>
<span id="cb35-64"><a href="#cb35-64" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">&#39;Total Calls&#39;</span>,</span>
<span id="cb35-65"><a href="#cb35-65" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">&#39;update&#39;</span>,</span>
<span id="cb35-66"><a href="#cb35-66" aria-hidden="true" tabindex="-1"></a>    args<span class="op">=</span>[{<span class="st">&#39;visible&#39;</span>: [<span class="va">True</span>] <span class="op">+</span> [<span class="va">False</span>] <span class="op">*</span> (<span class="bu">len</span>(daily_counts.columns) <span class="op">-</span> <span class="dv">1</span>)},</span>
<span id="cb35-67"><a href="#cb35-67" aria-hidden="true" tabindex="-1"></a>          {<span class="st">&#39;title&#39;</span>: <span class="st">&#39;Total 911 Calls by Day&#39;</span>}]</span>
<span id="cb35-68"><a href="#cb35-68" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb35-69"><a href="#cb35-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-70"><a href="#cb35-70" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, column <span class="kw">in</span> <span class="bu">enumerate</span>(daily_counts.columns):</span>
<span id="cb35-71"><a href="#cb35-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> column <span class="op">!=</span> <span class="st">&#39;Total&#39;</span>:</span>
<span id="cb35-72"><a href="#cb35-72" aria-hidden="true" tabindex="-1"></a>        visibility <span class="op">=</span> [<span class="va">False</span>] <span class="op">*</span> <span class="bu">len</span>(daily_counts.columns)</span>
<span id="cb35-73"><a href="#cb35-73" aria-hidden="true" tabindex="-1"></a>        visibility[i <span class="op">+</span> <span class="dv">1</span>] <span class="op">=</span> <span class="va">True</span>  <span class="co"># +1 because Total is the first trace</span></span>
<span id="cb35-74"><a href="#cb35-74" aria-hidden="true" tabindex="-1"></a>        buttons.append(<span class="bu">dict</span>(</span>
<span id="cb35-75"><a href="#cb35-75" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span>column,</span>
<span id="cb35-76"><a href="#cb35-76" aria-hidden="true" tabindex="-1"></a>            method<span class="op">=</span><span class="st">&#39;update&#39;</span>,</span>
<span id="cb35-77"><a href="#cb35-77" aria-hidden="true" tabindex="-1"></a>            args<span class="op">=</span>[{<span class="st">&#39;visible&#39;</span>: visibility},</span>
<span id="cb35-78"><a href="#cb35-78" aria-hidden="true" tabindex="-1"></a>                  {<span class="st">&#39;title&#39;</span>: <span class="ss">f&#39;911 Calls by Day: </span><span class="sc">{</span>column<span class="sc">}</span><span class="ss">&#39;</span>}]</span>
<span id="cb35-79"><a href="#cb35-79" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb35-80"><a href="#cb35-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-81"><a href="#cb35-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Update layout</span></span>
<span id="cb35-82"><a href="#cb35-82" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb35-83"><a href="#cb35-83" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">&#39;Total 911 Calls by Day&#39;</span>,</span>
<span id="cb35-84"><a href="#cb35-84" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">&#39;Date&#39;</span>,</span>
<span id="cb35-85"><a href="#cb35-85" aria-hidden="true" tabindex="-1"></a>    yaxis_title<span class="op">=</span><span class="st">&#39;Number of Calls&#39;</span>,</span>
<span id="cb35-86"><a href="#cb35-86" aria-hidden="true" tabindex="-1"></a>    updatemenus<span class="op">=</span>[<span class="bu">dict</span>(</span>
<span id="cb35-87"><a href="#cb35-87" aria-hidden="true" tabindex="-1"></a>        active<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb35-88"><a href="#cb35-88" aria-hidden="true" tabindex="-1"></a>        buttons<span class="op">=</span>buttons,</span>
<span id="cb35-89"><a href="#cb35-89" aria-hidden="true" tabindex="-1"></a>        direction<span class="op">=</span><span class="st">&quot;down&quot;</span>,</span>
<span id="cb35-90"><a href="#cb35-90" aria-hidden="true" tabindex="-1"></a>        pad<span class="op">=</span>{<span class="st">&quot;r&quot;</span>: <span class="dv">10</span>, <span class="st">&quot;t&quot;</span>: <span class="dv">10</span>},</span>
<span id="cb35-91"><a href="#cb35-91" aria-hidden="true" tabindex="-1"></a>        showactive<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb35-92"><a href="#cb35-92" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb35-93"><a href="#cb35-93" aria-hidden="true" tabindex="-1"></a>        xanchor<span class="op">=</span><span class="st">&quot;left&quot;</span>,</span>
<span id="cb35-94"><a href="#cb35-94" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="fl">1.15</span>,</span>
<span id="cb35-95"><a href="#cb35-95" aria-hidden="true" tabindex="-1"></a>        yanchor<span class="op">=</span><span class="st">&quot;top&quot;</span></span>
<span id="cb35-96"><a href="#cb35-96" aria-hidden="true" tabindex="-1"></a>    )],</span>
<span id="cb35-97"><a href="#cb35-97" aria-hidden="true" tabindex="-1"></a>    hovermode<span class="op">=</span><span class="st">&#39;closest&#39;</span></span>
<span id="cb35-98"><a href="#cb35-98" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-99"><a href="#cb35-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-100"><a href="#cb35-100" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="cb35-101"><a href="#cb35-101" aria-hidden="true" tabindex="-1"></a>fig.show()</span>
<span id="cb35-102"><a href="#cb35-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-103"><a href="#cb35-103" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the plot as an HTML file</span></span>
<span id="cb35-104"><a href="#cb35-104" aria-hidden="true" tabindex="-1"></a>fig.write_html(<span class="st">&quot;charts/911_calls_time_series_plot_by_day_with_popup.html&quot;</span>)</span></code></pre></div>
</div>
<section id="911-calls-time-series-by-hour" class="cell markdown">
<h6>911 Calls Time Series by Hour</h6>
</section>
<div class="cell code">
<div class="sourceCode" id="cb36"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the data</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> calls_911_2023_2024</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Call Creation Date and Time&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Call Creation Date and Time&#39;</span>].astype(<span class="st">&#39;datetime64[ns]&#39;</span>)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[df[<span class="st">&#39;Call Creation Date and Time&#39;</span>].dt.strftime(<span class="st">&#39;%H-%M-%S&#39;</span>) <span class="op">!=</span> <span class="st">&#39;00-00-00&#39;</span>] <span class="co"># Remove rows with time 00:00:00 (to avoid issues with plotting a lot of calls at midnight)</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract month and day, ignoring year</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Hour&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Call Creation Date and Time&#39;</span>].dt.hour</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a dataframe with each day as a row and columns for each call type</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>daily_counts <span class="op">=</span> df.groupby([<span class="st">&#39;Hour&#39;</span>, <span class="st">&#39;Call Type Description&#39;</span>]).size().unstack(fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a total column</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>daily_counts[<span class="st">&#39;Total&#39;</span>] <span class="op">=</span> daily_counts.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort the index to ensure chronological order</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>daily_counts <span class="op">=</span> daily_counts.sort_index()</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Add trace for total calls (visible by default)</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>fig.add_trace(</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>    go.Scatter(</span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>daily_counts.index,</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span>daily_counts[<span class="st">&#39;Total&#39;</span>],</span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">&#39;Total Calls&#39;</span>,</span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>        line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">&#39;black&#39;</span>, width<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Add traces for each call type (hidden by default)</span></span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> column <span class="kw">in</span> daily_counts.columns:</span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> column <span class="op">!=</span> <span class="st">&#39;Total&#39;</span>:</span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>        fig.add_trace(</span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>            go.Scatter(</span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a>                x<span class="op">=</span>daily_counts.index,</span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a>                y<span class="op">=</span>daily_counts[column],</span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a>                name<span class="op">=</span>column,</span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a>                visible<span class="op">=</span><span class="va">False</span></span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Create buttons for filtering</span></span>
<span id="cb36-47"><a href="#cb36-47" aria-hidden="true" tabindex="-1"></a>buttons <span class="op">=</span> [<span class="bu">dict</span>(</span>
<span id="cb36-48"><a href="#cb36-48" aria-hidden="true" tabindex="-1"></a>    label<span class="op">=</span><span class="st">&#39;Total Calls&#39;</span>,</span>
<span id="cb36-49"><a href="#cb36-49" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">&#39;update&#39;</span>,</span>
<span id="cb36-50"><a href="#cb36-50" aria-hidden="true" tabindex="-1"></a>    args<span class="op">=</span>[{<span class="st">&#39;visible&#39;</span>: [<span class="va">True</span>] <span class="op">+</span> [<span class="va">False</span>] <span class="op">*</span> (<span class="bu">len</span>(daily_counts.columns) <span class="op">-</span> <span class="dv">1</span>)},</span>
<span id="cb36-51"><a href="#cb36-51" aria-hidden="true" tabindex="-1"></a>          {<span class="st">&#39;title&#39;</span>: <span class="st">&#39;Total 911 Calls by Hour&#39;</span>}]</span>
<span id="cb36-52"><a href="#cb36-52" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb36-53"><a href="#cb36-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-54"><a href="#cb36-54" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, column <span class="kw">in</span> <span class="bu">enumerate</span>(daily_counts.columns):</span>
<span id="cb36-55"><a href="#cb36-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> column <span class="op">!=</span> <span class="st">&#39;Total&#39;</span>:</span>
<span id="cb36-56"><a href="#cb36-56" aria-hidden="true" tabindex="-1"></a>        visibility <span class="op">=</span> [<span class="va">False</span>] <span class="op">*</span> <span class="bu">len</span>(daily_counts.columns)</span>
<span id="cb36-57"><a href="#cb36-57" aria-hidden="true" tabindex="-1"></a>        visibility[i <span class="op">+</span> <span class="dv">1</span>] <span class="op">=</span> <span class="va">True</span>  <span class="co"># +1 because Total is the first trace</span></span>
<span id="cb36-58"><a href="#cb36-58" aria-hidden="true" tabindex="-1"></a>        buttons.append(<span class="bu">dict</span>(</span>
<span id="cb36-59"><a href="#cb36-59" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span>column,</span>
<span id="cb36-60"><a href="#cb36-60" aria-hidden="true" tabindex="-1"></a>            method<span class="op">=</span><span class="st">&#39;update&#39;</span>,</span>
<span id="cb36-61"><a href="#cb36-61" aria-hidden="true" tabindex="-1"></a>            args<span class="op">=</span>[{<span class="st">&#39;visible&#39;</span>: visibility},</span>
<span id="cb36-62"><a href="#cb36-62" aria-hidden="true" tabindex="-1"></a>                  {<span class="st">&#39;title&#39;</span>: <span class="ss">f&#39;911 Calls by Hour: </span><span class="sc">{</span>column<span class="sc">}</span><span class="ss">&#39;</span>}]</span>
<span id="cb36-63"><a href="#cb36-63" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb36-64"><a href="#cb36-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-65"><a href="#cb36-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Update layout</span></span>
<span id="cb36-66"><a href="#cb36-66" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb36-67"><a href="#cb36-67" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">&#39;Total 911 Calls by Hour&#39;</span>,</span>
<span id="cb36-68"><a href="#cb36-68" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">&#39;Hour&#39;</span>,</span>
<span id="cb36-69"><a href="#cb36-69" aria-hidden="true" tabindex="-1"></a>    yaxis_title<span class="op">=</span><span class="st">&#39;Number of Calls&#39;</span>,</span>
<span id="cb36-70"><a href="#cb36-70" aria-hidden="true" tabindex="-1"></a>    updatemenus<span class="op">=</span>[<span class="bu">dict</span>(</span>
<span id="cb36-71"><a href="#cb36-71" aria-hidden="true" tabindex="-1"></a>        active<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb36-72"><a href="#cb36-72" aria-hidden="true" tabindex="-1"></a>        buttons<span class="op">=</span>buttons,</span>
<span id="cb36-73"><a href="#cb36-73" aria-hidden="true" tabindex="-1"></a>        direction<span class="op">=</span><span class="st">&quot;down&quot;</span>,</span>
<span id="cb36-74"><a href="#cb36-74" aria-hidden="true" tabindex="-1"></a>        pad<span class="op">=</span>{<span class="st">&quot;r&quot;</span>: <span class="dv">10</span>, <span class="st">&quot;t&quot;</span>: <span class="dv">10</span>},</span>
<span id="cb36-75"><a href="#cb36-75" aria-hidden="true" tabindex="-1"></a>        showactive<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb36-76"><a href="#cb36-76" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb36-77"><a href="#cb36-77" aria-hidden="true" tabindex="-1"></a>        xanchor<span class="op">=</span><span class="st">&quot;left&quot;</span>,</span>
<span id="cb36-78"><a href="#cb36-78" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="fl">1.15</span>,</span>
<span id="cb36-79"><a href="#cb36-79" aria-hidden="true" tabindex="-1"></a>        yanchor<span class="op">=</span><span class="st">&quot;top&quot;</span></span>
<span id="cb36-80"><a href="#cb36-80" aria-hidden="true" tabindex="-1"></a>    )],</span>
<span id="cb36-81"><a href="#cb36-81" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-82"><a href="#cb36-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-83"><a href="#cb36-83" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the plot as an HTML file</span></span>
<span id="cb36-84"><a href="#cb36-84" aria-hidden="true" tabindex="-1"></a>fig.write_html(<span class="st">&quot;charts/911_calls_time_series_plot_by_hour.html&quot;</span>)</span></code></pre></div>
</div>
<section id="911-calls-2023-heatmap-by-call-type-description"
class="cell markdown">
<h5>911 Calls 2023 Heatmap by Call Type Description</h5>
</section>
<div class="cell code">
<div class="sourceCode" id="cb37"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> folium.plugins <span class="im">import</span> HeatMap</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create DataFrame from the provided data</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> calls_911_2023_2024</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(data)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a map centered on Missoula</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> folium.Map(location<span class="op">=</span>[<span class="fl">46.87</span>, <span class="op">-</span><span class="fl">113.99</span>], zoom_start<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a feature group for all calls</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>all_calls_group <span class="op">=</span> folium.FeatureGroup(name<span class="op">=</span><span class="st">&quot;All Calls&quot;</span>, show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>all_heat_data <span class="op">=</span> df[[<span class="st">&#39;Lat&#39;</span>, <span class="st">&#39;Lon&#39;</span>]].values.tolist()</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>HeatMap(all_heat_data).add_to(all_calls_group)</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>all_calls_group.add_to(m)</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Get unique call types</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>call_types <span class="op">=</span> df[<span class="st">&#39;Call Type Description&#39;</span>].unique()</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a feature group for each call type</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> call_type <span class="kw">in</span> call_types:</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    filtered_data <span class="op">=</span> df[df[<span class="st">&#39;Call Type Description&#39;</span>] <span class="op">==</span> call_type]</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>    heat_data <span class="op">=</span> filtered_data[[<span class="st">&#39;Lat&#39;</span>, <span class="st">&#39;Lon&#39;</span>]].values.tolist()</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>    feature_group <span class="op">=</span> folium.FeatureGroup(name<span class="op">=</span>call_type, show<span class="op">=</span><span class="va">False</span>)  <span class="co"># Set show=False to make layers off by default</span></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>    HeatMap(heat_data, radius <span class="op">=</span> <span class="dv">15</span>, min_opacity <span class="op">=</span> <span class="fl">0.4</span>, blur <span class="op">=</span> <span class="dv">15</span>, gradient <span class="op">=</span> {<span class="fl">0.4</span>: <span class="st">&#39;blue&#39;</span>, <span class="fl">0.65</span>: <span class="st">&#39;lime&#39;</span>, <span class="dv">1</span>: <span class="st">&#39;red&#39;</span>}, max_zoom<span class="op">=</span><span class="dv">18</span>).add_to(feature_group)</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>    feature_group.add_to(m)</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Add layer control to the map</span></span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>folium.LayerControl().add_to(m)</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the map</span></span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>m.save(<span class="st">&quot;maps/missoula_911_heatmap_with_all_calls.html&quot;</span>)</span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Heatmap with &#39;All Calls&#39; option has been saved as &#39;missoula_911_heatmap_with_all_calls.html&#39;&quot;</span>)</span></code></pre></div>
</div>
<section
id="911-calls-2023-heatmap-by-crime-type-violent-or-non-violent"
class="cell markdown">
<h5>911 Calls 2023 Heatmap by Crime Type (violent or non-violent)</h5>
</section>
<div class="cell code">
<div class="sourceCode" id="cb38"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> folium.plugins <span class="im">import</span> HeatMap</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create DataFrame from the provided data</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> calls_911_2023_2024</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(data)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a map centered on Missoula</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> folium.Map(location<span class="op">=</span>[<span class="fl">46.87</span>, <span class="op">-</span><span class="fl">113.99</span>], zoom_start<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a feature group for all calls</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>all_calls_group <span class="op">=</span> folium.FeatureGroup(name<span class="op">=</span><span class="st">&quot;All Calls&quot;</span>, show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>all_heat_data <span class="op">=</span> df[[<span class="st">&#39;Lat&#39;</span>, <span class="st">&#39;Lon&#39;</span>]].values.tolist()</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>HeatMap(all_heat_data).add_to(all_calls_group)</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>all_calls_group.add_to(m)</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Get unique crime types</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>call_types <span class="op">=</span> df[<span class="st">&#39;crime_type&#39;</span>].unique()</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a feature group for each crime type</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> call_type <span class="kw">in</span> call_types:</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>    filtered_data <span class="op">=</span> df[df[<span class="st">&#39;crime_type&#39;</span>] <span class="op">==</span> call_type]</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>    heat_data <span class="op">=</span> filtered_data[[<span class="st">&#39;Lat&#39;</span>, <span class="st">&#39;Lon&#39;</span>]].values.tolist()</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>    feature_group <span class="op">=</span> folium.FeatureGroup(name<span class="op">=</span>call_type, show<span class="op">=</span><span class="va">False</span>)  <span class="co"># Set show=False to make layers off by default</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>    HeatMap(heat_data, radius <span class="op">=</span> <span class="dv">15</span>, min_opacity <span class="op">=</span> <span class="fl">0.4</span>, blur <span class="op">=</span> <span class="dv">15</span>, gradient <span class="op">=</span> {<span class="fl">0.4</span>: <span class="st">&#39;blue&#39;</span>, <span class="fl">0.65</span>: <span class="st">&#39;lime&#39;</span>, <span class="dv">1</span>: <span class="st">&#39;red&#39;</span>}, max_zoom<span class="op">=</span><span class="dv">18</span>).add_to(feature_group)</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>    feature_group.add_to(m)</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Add layer control to the map</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>folium.LayerControl().add_to(m)</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the map</span></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>m.save(<span class="st">&quot;maps/missoula_911_heatmap_with_crime_type.html&quot;</span>)</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Heatmap with &#39;All Calls&#39; option has been saved as &#39;missoula_911_heatmap_with_crime_type.html&#39;&quot;</span>)</span></code></pre></div>
</div>
<section id="911-calls-2023-heatmap-by-call-hour" class="cell markdown">
<h5>911 Calls 2023 Heatmap by Call Hour</h5>
</section>
<div class="cell code">
<div class="sourceCode" id="cb39"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> folium.plugins <span class="im">import</span> HeatMap</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create DataFrame from the provided data</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> calls_911_2023_2024</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(data)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="co"># drop dates with no hms (cant use dt for this)</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[df[<span class="st">&#39;Call Creation Date and Time&#39;</span>].<span class="bu">str</span>.contains(<span class="st">&#39;:&#39;</span>)]</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the &#39;Date&#39; column to datetime and extract hour</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Date&#39;</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">&#39;Call Creation Date and Time&#39;</span>])</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;Hour&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Date&#39;</span>].dt.hour</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a map centered on Missoula</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> folium.Map(location<span class="op">=</span>[<span class="fl">46.87</span>, <span class="op">-</span><span class="fl">113.99</span>], zoom_start<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a feature group for each hour</span></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> hour <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">24</span>):</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>    hour_df <span class="op">=</span> df[df[<span class="st">&#39;Hour&#39;</span>] <span class="op">==</span> hour]</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>    heat_data <span class="op">=</span> hour_df[[<span class="st">&#39;Lat&#39;</span>, <span class="st">&#39;Lon&#39;</span>]].values.tolist()</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a name for the layer (e.g., &quot;12 AM&quot; for hour 0, &quot;1 PM&quot; for hour 13)</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>    layer_name <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>hour <span class="op">%</span> <span class="dv">12</span> <span class="kw">or</span> <span class="dv">12</span><span class="sc">}</span><span class="ss"> </span><span class="sc">{</span><span class="st">&#39;AM&#39;</span> <span class="cf">if</span> hour <span class="op">&lt;</span> <span class="dv">12</span> <span class="cf">else</span> <span class="st">&#39;PM&#39;</span><span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>    feature_group <span class="op">=</span> folium.FeatureGroup(name<span class="op">=</span>layer_name, show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>    HeatMap(heat_data, radius <span class="op">=</span> <span class="dv">15</span>, min_opacity <span class="op">=</span> <span class="fl">0.4</span>, blur <span class="op">=</span> <span class="dv">15</span>, gradient <span class="op">=</span> {<span class="fl">0.4</span>: <span class="st">&#39;blue&#39;</span>, <span class="fl">0.65</span>: <span class="st">&#39;lime&#39;</span>, <span class="dv">1</span>: <span class="st">&#39;red&#39;</span>}, max_zoom<span class="op">=</span><span class="dv">18</span>).add_to(feature_group)</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>    feature_group.add_to(m)</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a feature group for all hours</span></span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>all_heat_data <span class="op">=</span> df[[<span class="st">&#39;Lat&#39;</span>, <span class="st">&#39;Lon&#39;</span>]].values.tolist()</span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>all_hours_group <span class="op">=</span> folium.FeatureGroup(name<span class="op">=</span><span class="st">&quot;All Hours&quot;</span>, show<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>HeatMap(all_heat_data).add_to(all_hours_group)</span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a>all_hours_group.add_to(m)</span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Add layer control to the map</span></span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>folium.LayerControl().add_to(m)</span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the map</span></span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>m.save(<span class="st">&quot;maps/missoula_911_heatmap_hourly_layers.html&quot;</span>)</span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Heatmap with hourly layers has been saved as &#39;missoula_911_heatmap_hourly_layers.html&#39;&quot;</span>)</span></code></pre></div>
</div>
<section id="neighborhoods-calls" class="cell markdown">
<h5>Neighborhoods Calls</h5>
</section>
<div class="cell code">
<div class="sourceCode" id="cb40"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Open the TIFF file</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>tif_file <span class="op">=</span> <span class="st">&quot;data/missoula/missoula_pop_density.tif&quot;</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> rasterio.<span class="bu">open</span>(tif_file) <span class="im">as</span> src:</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read the raster data</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> src.read(<span class="dv">1</span>)  <span class="co"># Read the first band (assuming single-band raster)</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Replace NaN (no-data) values with 0</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> np.nan_to_num(data, nan<span class="op">=</span><span class="dv">0</span>)  <span class="co"># Replace NaN with 0</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print out the metadata to verify file details</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Metadata:&quot;</span>, src.meta)</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check the data shape and some basic statistics</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Data Shape:&quot;</span>, data.shape)</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Min Value:&quot;</span>, np.nanmin(data))  <span class="co"># Should not be NaN anymore</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Max Value:&quot;</span>, np.nanmax(data))</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Mean Value:&quot;</span>, np.nanmean(data))</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Flatten the raster data to create a table (row for each pixel)</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>data_flat <span class="op">=</span> data.flatten()</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a DataFrame from the flattened raster data</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame({<span class="st">&#39;Pixel Value&#39;</span>: data_flat})</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the first few rows of the DataFrame</span></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.head())</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a><span class="co">#------</span></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio</span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rasterstats <span class="im">import</span> zonal_stats</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the population density TIFF file</span></span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a>pop_density_file <span class="op">=</span> <span class="st">&#39;data/missoula/missoula_pop_density.tif&#39;</span></span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> rasterio.<span class="bu">open</span>(pop_density_file) <span class="im">as</span> src:</span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>    population_density <span class="op">=</span> src.read(<span class="dv">1</span>)  <span class="co"># Read the first band (assuming single-band raster)</span></span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a>    transform <span class="op">=</span> src.transform          <span class="co"># Affine transformation for pixel coordinates</span></span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a>    pixel_size <span class="op">=</span> transform[<span class="dv">0</span>] <span class="op">*</span> transform[<span class="dv">4</span>]  <span class="co"># Get pixel size (e.g., in square kilometers)</span></span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the neighborhood boundaries (GeoJSON, Shapefile, etc.)</span></span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a>n_file <span class="op">=</span> gpd.read_file(<span class="st">&#39;data/missoula/missoula_neighborhoods_fixed_3.geojson&#39;</span>)</span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure both datasets are in the same coordinate reference system (CRS)</span></span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> n_file.crs <span class="op">!=</span> src.crs:</span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a>    n_file <span class="op">=</span> n_file.to_crs(src.crs)</span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform zonal statistics to sum population density for each neighborhood</span></span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true" tabindex="-1"></a>stats <span class="op">=</span> zonal_stats(n_file, pop_density_file, stats<span class="op">=</span><span class="st">&quot;sum&quot;</span>, affine<span class="op">=</span>transform)</span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-57"><a href="#cb40-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the population density sums to the neighborhoods GeoDataFrame</span></span>
<span id="cb40-58"><a href="#cb40-58" aria-hidden="true" tabindex="-1"></a>n_file[<span class="st">&#39;population_density_sum&#39;</span>] <span class="op">=</span> [stat[<span class="st">&#39;sum&#39;</span>] <span class="cf">for</span> stat <span class="kw">in</span> stats]</span>
<span id="cb40-59"><a href="#cb40-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-60"><a href="#cb40-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the population for each neighborhood</span></span>
<span id="cb40-61"><a href="#cb40-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Assuming the population density is per square kilometer</span></span>
<span id="cb40-62"><a href="#cb40-62" aria-hidden="true" tabindex="-1"></a><span class="co"># n_file[&#39;population&#39;] = n_file[&#39;population_density_sum&#39;] * pixel_size</span></span>
<span id="cb40-63"><a href="#cb40-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-64"><a href="#cb40-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the results</span></span>
<span id="cb40-65"><a href="#cb40-65" aria-hidden="true" tabindex="-1"></a><span class="co"># print(n_file)  # Assuming &#39;name&#39; is the neighborhood name column</span></span>
<span id="cb40-66"><a href="#cb40-66" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(n_file[[<span class="st">&#39;FeatureName&#39;</span>, <span class="st">&#39;population_density_sum&#39;</span>]])</span>
<span id="cb40-67"><a href="#cb40-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-68"><a href="#cb40-68" aria-hidden="true" tabindex="-1"></a>n_file.to_file(<span class="st">&quot;pop_dens_sum.geojson&quot;</span>, driver<span class="op">=</span><span class="st">&quot;GeoJSON&quot;</span>)</span>
<span id="cb40-69"><a href="#cb40-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-70"><a href="#cb40-70" aria-hidden="true" tabindex="-1"></a><span class="co">#sums pops</span></span>
<span id="cb40-71"><a href="#cb40-71" aria-hidden="true" tabindex="-1"></a>i_sum <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb40-72"><a href="#cb40-72" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> n_file[<span class="st">&quot;population_density_sum&quot;</span>]:</span>
<span id="cb40-73"><a href="#cb40-73" aria-hidden="true" tabindex="-1"></a>    i_sum <span class="op">+=</span> i</span>
<span id="cb40-74"><a href="#cb40-74" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;totaled:&quot;</span>, i_sum) </span>
<span id="cb40-75"><a href="#cb40-75" aria-hidden="true" tabindex="-1"></a><span class="co">#save into file</span></span>
<span id="cb40-76"><a href="#cb40-76" aria-hidden="true" tabindex="-1"></a><span class="co">#csv:</span></span>
<span id="cb40-77"><a href="#cb40-77" aria-hidden="true" tabindex="-1"></a><span class="co"># n_file[[&#39;FeatureName&#39;, &#39;population_density_sum&#39;]].to_csv(&#39;neighbor_pop_dens.csv&#39;, index=False)</span></span>
<span id="cb40-78"><a href="#cb40-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-79"><a href="#cb40-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-80"><a href="#cb40-80" aria-hidden="true" tabindex="-1"></a><span class="co">#------</span></span>
<span id="cb40-81"><a href="#cb40-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-82"><a href="#cb40-82" aria-hidden="true" tabindex="-1"></a>n_file</span>
<span id="cb40-83"><a href="#cb40-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-84"><a href="#cb40-84" aria-hidden="true" tabindex="-1"></a><span class="co">#------</span></span>
<span id="cb40-85"><a href="#cb40-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-86"><a href="#cb40-86" aria-hidden="true" tabindex="-1"></a><span class="co">#1</span></span>
<span id="cb40-87"><a href="#cb40-87" aria-hidden="true" tabindex="-1"></a><span class="co">#----------------------</span></span>
<span id="cb40-88"><a href="#cb40-88" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb40-89"><a href="#cb40-89" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> branca.colormap <span class="im">as</span> cm</span>
<span id="cb40-90"><a href="#cb40-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-91"><a href="#cb40-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-92"><a href="#cb40-92" aria-hidden="true" tabindex="-1"></a><span class="co">#merge at geometry</span></span>
<span id="cb40-93"><a href="#cb40-93" aria-hidden="true" tabindex="-1"></a>merged <span class="op">=</span> n_file.merge(n_file.sjoin(calls_911_2023_2024).groupby(<span class="st">&#39;FeatureName&#39;</span>).size().rename(<span class="st">&#39;CallAmount&#39;</span>).reset_index())</span>
<span id="cb40-94"><a href="#cb40-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-95"><a href="#cb40-95" aria-hidden="true" tabindex="-1"></a>merged</span>
<span id="cb40-96"><a href="#cb40-96" aria-hidden="true" tabindex="-1"></a><span class="co">#----------------------</span></span>
<span id="cb40-97"><a href="#cb40-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-98"><a href="#cb40-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-99"><a href="#cb40-99" aria-hidden="true" tabindex="-1"></a><span class="co">#2</span></span>
<span id="cb40-100"><a href="#cb40-100" aria-hidden="true" tabindex="-1"></a><span class="co">#----------------------</span></span>
<span id="cb40-101"><a href="#cb40-101" aria-hidden="true" tabindex="-1"></a>merged.to_file(<span class="st">&quot;n_p_sum.geojson&quot;</span>, driver<span class="op">=</span><span class="st">&quot;GeoJSON&quot;</span>)</span>
<span id="cb40-102"><a href="#cb40-102" aria-hidden="true" tabindex="-1"></a>merged[[<span class="st">&quot;FeatureName&quot;</span>, <span class="st">&quot;CallAmount&quot;</span>]]</span>
<span id="cb40-103"><a href="#cb40-103" aria-hidden="true" tabindex="-1"></a><span class="co">#----------------------</span></span>
<span id="cb40-104"><a href="#cb40-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-105"><a href="#cb40-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-106"><a href="#cb40-106" aria-hidden="true" tabindex="-1"></a><span class="co">#3</span></span>
<span id="cb40-107"><a href="#cb40-107" aria-hidden="true" tabindex="-1"></a><span class="co">#----------------------</span></span>
<span id="cb40-108"><a href="#cb40-108" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> folium.Map(location<span class="op">=</span>[<span class="fl">46.8721</span>, <span class="op">-</span><span class="fl">113.9940</span>], zoom_start<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb40-109"><a href="#cb40-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-110"><a href="#cb40-110" aria-hidden="true" tabindex="-1"></a><span class="co">#colormap</span></span>
<span id="cb40-111"><a href="#cb40-111" aria-hidden="true" tabindex="-1"></a>colormap <span class="op">=</span> cm.linear.YlOrRd_09.scale(merged[<span class="st">&quot;CallAmount&quot;</span>].<span class="bu">min</span>(), merged[<span class="st">&quot;CallAmount&quot;</span>].<span class="bu">max</span>())</span>
<span id="cb40-112"><a href="#cb40-112" aria-hidden="true" tabindex="-1"></a>colormap.caption <span class="op">=</span> <span class="st">&quot;Call Amount by Neighborhood&quot;</span></span>
<span id="cb40-113"><a href="#cb40-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-114"><a href="#cb40-114" aria-hidden="true" tabindex="-1"></a><span class="co">#color neighs</span></span>
<span id="cb40-115"><a href="#cb40-115" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> style_function(feature):</span>
<span id="cb40-116"><a href="#cb40-116" aria-hidden="true" tabindex="-1"></a>    call_amount <span class="op">=</span> feature[<span class="st">&#39;properties&#39;</span>][<span class="st">&#39;CallAmount&#39;</span>]</span>
<span id="cb40-117"><a href="#cb40-117" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb40-118"><a href="#cb40-118" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;fillOpacity&#39;</span>: <span class="fl">0.7</span>,</span>
<span id="cb40-119"><a href="#cb40-119" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;weight&#39;</span>: <span class="fl">0.5</span>,</span>
<span id="cb40-120"><a href="#cb40-120" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;fillColor&#39;</span>: colormap(call_amount) <span class="cf">if</span> call_amount <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> <span class="st">&#39;#ffffff&#39;</span>,  <span class="co"># White if no data</span></span>
<span id="cb40-121"><a href="#cb40-121" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;color&#39;</span>: <span class="st">&#39;black&#39;</span></span>
<span id="cb40-122"><a href="#cb40-122" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb40-123"><a href="#cb40-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-124"><a href="#cb40-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-125"><a href="#cb40-125" aria-hidden="true" tabindex="-1"></a>folium.GeoJson(</span>
<span id="cb40-126"><a href="#cb40-126" aria-hidden="true" tabindex="-1"></a>    merged,</span>
<span id="cb40-127"><a href="#cb40-127" aria-hidden="true" tabindex="-1"></a>    style_function<span class="op">=</span>style_function,</span>
<span id="cb40-128"><a href="#cb40-128" aria-hidden="true" tabindex="-1"></a>    tooltip<span class="op">=</span>folium.GeoJsonTooltip(fields<span class="op">=</span>[<span class="st">&#39;FeatureName&#39;</span>, <span class="st">&#39;CallAmount&#39;</span>], aliases<span class="op">=</span>[<span class="st">&#39;Neighborhood:&#39;</span>, <span class="st">&#39;Calls:&#39;</span>]),</span>
<span id="cb40-129"><a href="#cb40-129" aria-hidden="true" tabindex="-1"></a>).add_to(m)</span>
<span id="cb40-130"><a href="#cb40-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-131"><a href="#cb40-131" aria-hidden="true" tabindex="-1"></a>colormap.add_to(m)</span>
<span id="cb40-132"><a href="#cb40-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-133"><a href="#cb40-133" aria-hidden="true" tabindex="-1"></a><span class="co">#save map</span></span>
<span id="cb40-134"><a href="#cb40-134" aria-hidden="true" tabindex="-1"></a>m.save(<span class="st">&#39;maps/neighborhood_calls_map.html&#39;</span>)</span>
<span id="cb40-135"><a href="#cb40-135" aria-hidden="true" tabindex="-1"></a><span class="co">#----------------------</span></span></code></pre></div>
</div>
<section id="zillow-data" class="cell markdown">
<h5>Zillow Data</h5>
</section>
<div class="cell code" data-execution_count="17">
<div class="sourceCode" id="cb41"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load zillow data</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>missoula_zillow <span class="op">=</span> pd.read_csv(<span class="st">&#39;data/missoula/missoula_zillow_10_2024.csv&#39;</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co"># drop values where price is less than 3 characters</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>missoula_zillow <span class="op">=</span> missoula_zillow[missoula_zillow[<span class="st">&#39;price&#39;</span>].<span class="bu">str</span>.<span class="bu">len</span>() <span class="op">&gt;</span> <span class="dv">3</span>]</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>missoula_zillow.reset_index(drop<span class="op">=</span><span class="va">True</span>, inplace<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
</div>
<div class="cell code">
<div class="sourceCode" id="cb42"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>missoula_zillow</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="19">
<div class="sourceCode" id="cb43"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># drop values where price is less than 3 characters</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>missoula_zillow <span class="op">=</span> missoula_zillow[missoula_zillow[<span class="st">&#39;price&#39;</span>].<span class="bu">str</span>.<span class="bu">len</span>() <span class="op">&gt;</span> <span class="dv">3</span>]</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>missoula_zillow.reset_index(drop<span class="op">=</span><span class="va">True</span>, inplace<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
</div>
<div class="cell code">
<div class="sourceCode" id="cb44"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>missoula_zillow.iloc[<span class="dv">3</span>]</span></code></pre></div>
</div>
<div class="cell code">
<div class="sourceCode" id="cb45"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># show the first entry image using the image_url</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> Image</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>Image(url<span class="op">=</span>missoula_zillow.iloc[<span class="dv">3</span>].image_url)</span></code></pre></div>
</div>
<div class="cell code">
<div class="sourceCode" id="cb46"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>missoula_zillow.iloc[<span class="dv">3</span>].price</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="12">
<div class="sourceCode" id="cb47"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># missoula_zillow.address</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co"># write address to a file and open it in a text editor</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>missoula_zillow.address.to_csv(<span class="st">&#39;missoula_zillow_addresses.txt&#39;</span>, index<span class="op">=</span><span class="va">False</span>)</span></code></pre></div>
</div>
<div class="cell code">
<div class="sourceCode" id="cb48"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># open missoula_zillow.csv and merge it with the missoula_zillow dataframe (original_address from missoula_zillow.csv and address from missoula_zillow df)</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>missoula_zillow_original <span class="op">=</span> pd.read_csv(<span class="st">&#39;data/missoula/missoula_zillow.csv&#39;</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>missoula_zillow_original</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="co"># merge the two dataframes</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>missoula_zillow_merged <span class="op">=</span> pd.merge(missoula_zillow, missoula_zillow_original, left_on<span class="op">=</span><span class="st">&#39;address&#39;</span>, right_on<span class="op">=</span><span class="st">&#39;original_address&#39;</span>)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>missoula_zillow_merged.to_csv(<span class="st">&#39;missoula_zillow_merged.csv&#39;</span>, index<span class="op">=</span><span class="va">False</span>)</span></code></pre></div>
</div>
<div class="cell code">
<div class="sourceCode" id="cb49"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># format the price column to be just the number</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>missoula_zillow_merged[<span class="st">&#39;price&#39;</span>] <span class="op">=</span> missoula_zillow_merged[<span class="st">&#39;price&#39;</span>].<span class="bu">str</span>.replace(<span class="st">&#39;$&#39;</span>, <span class="st">&#39;&#39;</span>).<span class="bu">str</span>.replace(<span class="st">&#39;,&#39;</span>, <span class="st">&#39;&#39;</span>).<span class="bu">str</span>.replace(<span class="st">&#39;+&#39;</span>, <span class="st">&#39;&#39;</span>).astype(<span class="bu">int</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>missoula_zillow_merged[<span class="st">&#39;price&#39;</span>]</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="31">
<div class="sourceCode" id="cb50"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>missoula_zillow_merged.to_csv(<span class="st">&#39;missoula_zillow_merged.csv&#39;</span>, index<span class="op">=</span><span class="va">False</span>)</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="3">
<div class="sourceCode" id="cb51"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read merged</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>missoula_zillow_merged <span class="op">=</span> pd.read_csv(<span class="st">&#39;missoula_zillow_merged.csv&#39;</span>)</span></code></pre></div>
</div>
<div class="cell code">
<div class="sourceCode" id="cb52"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>missoula_zillow_merged.price.plot()</span></code></pre></div>
</div>
</body>
</html>
