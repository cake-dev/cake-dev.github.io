<!DOCTYPE html>
<html>

<head>
    <title>Map Example</title>
    <style>
        text {
            font-family: Verdana, Geneva, Tahoma, sans-serif
        }

        .message {
            font-size: 2em;
            text-align: center;
        }

        path {
            fill: none;
            stroke-width: 1px;
            stroke: #222;
        }

        .grat {
            stroke: #222;
            stroke-dasharray: 4px;
            stroke-width: 1px;
            opacity: .5
        }
    </style>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v0.3.min.js"></script>
</head>

<body>
    <div class="message">D3 Map</div>
    <svg id="viz" width="1000" height="800"></svg>
</body>
<script>

    const color_range = ['#fff5eb', '#fee6ce', '#fdd0a2', '#fdae6b', '#fd8d3c', '#f16913', '#d94801', '#8c2d04']

    function create_svg_border(svg, h, w) {
        svg.attr('border', 1);
        svg.append("rect")
            .attr("x", 0)
            .attr("y", 0)
            .attr("height", h)
            .attr("width", w)
            .style("stroke", "black")
            .style("fill", "none")
            .style("stroke-width", 1);
    }

    createMap = async function () {

        let svg = d3.select("#viz");
        let width = parseInt(svg.attr("width"));
        let height = parseInt(svg.attr("height"));

        create_svg_border(svg, height, width);

        svg.append("g").attr("id", "mapLayer");
        svg.append("g").attr("id", "pointLayer");
        d3.select("#mapLayer").append("text").text("Class G Wildfires in the Western US in 1985").attr("x", 10).attr("y", 20).attr("id", "map_title");

        // In order to convert lat / lon (spherical!) coordinates to fit in the 2D
        // coordinate system of our screen, we need to create a projection function:

        let projection = d3.geoAlbersUsa()      // a USA-specific projection (that deals with Hawaii / Alaska)
            .translate([width / 1.2, height / 2]) // this centers the map in our SVG element
            .scale([1600]);                     // this specifies how much to zoom

        // This converts the projected lat/lon coordinates into an SVG path string
        let path = d3.geoPath()
            .projection(projection);

        // Load in states GeoJSON data    
        //let us_json = await d3.json("Data/us-states.json");
        let west_us_json = await d3.json("Data/western_us.geojson");

        // Bind data and create one path per GeoJSON feature
        var us_paths = d3.select("#mapLayer").selectAll("path")
            .data(west_us_json.features)
            .join("path")
            // use d attribute to define the path
            .attr("d", path)
            .style("fill", "#E8F0F7")
            .attr("opacity", "0.6");


        var tooltip = d3.select("body")
            .append("div")
            .classed(".tooltip", true)
            .style("position", "absolute")
            .style("z-index", "10")
            .style("visibility", "hidden")
            .style("background", "#ffffff")
            .text("a simple tooltip");

        await add_fires_1985()

    }

    add_fires_1985 = async function () {
        let svg = d3.select("#viz");
        let width = parseInt(svg.attr("width"));
        let height = parseInt(svg.attr("height"));

        let projection = d3.geoAlbersUsa()
            .translate([width / 1.2, height / 2])
            .scale([1600]);

        let path = d3.geoPath()
            .projection(projection);

        let fires_1985 = await d3.json("Data/fires_1985.geojson");

        d3.selectAll(".fire_15").remove()

        let fires_85 = d3.select("#pointLayer").selectAll("circle")
            .data(fires_1985.features)

        var fire_colors = d3.scaleQuantize()
            .domain([5071, 126854])
            .range(color_range);

        fires_85
            .join("circle")
            .classed("fire_85", true)
            .attr("cx", d => (projection(d.geometry.coordinates)[0]))
            .attr("cy", d => (projection(d.geometry.coordinates)[1]))
            .attr("r", d => Math.sqrt(parseInt(d.properties.BurnBndAc) * .0003))
            .attr("fill", d => fire_colors(d.properties.BurnBndAc));
    }

    add_fires_2015 = async function () {
        let svg = d3.select("#viz");
        let width = parseInt(svg.attr("width"));
        let height = parseInt(svg.attr("height"));

        let projection = d3.geoAlbersUsa()
            .translate([width / 1.2, height / 2])
            .scale([1600]);

        let path = d3.geoPath()
            .projection(projection);

        let fires_2015 = await d3.json("Data/fires_2015.geojson");

        d3.selectAll(".fire_85").remove()

        let fires_15 = d3.select("#pointLayer").selectAll("circle")
            .data(fires_2015.features)

        var fire_colors = d3.scaleQuantize()
            .domain([5052, 282888])
            .range(color_range);

        fires_15
            .join("circle")
            .classed("fire_15", true)
            .attr("cx", d => (projection(d.geometry.coordinates)[0]))
            .attr("cy", d => (projection(d.geometry.coordinates)[1]))
            .attr("r", d => Math.sqrt(parseInt(d.properties.BurnBndAc) * .0003))
            .attr("fill", d => fire_colors(d.properties.BurnBndAc));
    }

    changeMap = async function () {
        let map_title = d3.select("#map_title");
        map_year = map_title.text().substring(map_title.text().length - 4, map_title.text().length)

        if (map_year == "1985") {
            map_title.text("Class G Wildfires in the Western US in 2015");
            add_fires_2015();
        } else {
            map_title.text("Class G Wildfires in the Western US in 1985");
            add_fires_1985();
        }
    }

    changeSize = async function () {
        let map_title = d3.select("#map_title");
        map_year = map_title.text().substring(map_title.text().length - 4, map_title.text().length)

        if (map_year == "1985") {
            if (d3.selectAll(".fire_85").attr("r") == 4) {
                d3.selectAll(".fire_85").attr("r", d => Math.sqrt(parseInt(d.properties.BurnBndAc) * .0003))
            }
            else {
                d3.selectAll(".fire_85").attr("r", 4);
            }
        }
        else {
            if (d3.selectAll(".fire_15").attr("r") == 4) {
                d3.selectAll(".fire_15").attr("r", d => Math.sqrt(parseInt(d.properties.BurnBndAc) * .0003))
            }
            else {
                d3.selectAll(".fire_15").attr("r", 4);
            }
        }
    }

    async function main() {
        await createMap();
        await add_fires_1985();
    }

    main();

</script>
<script src="JS/runbutton.js" charset="utf-8"></script>


</html>